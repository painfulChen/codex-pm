<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0052cc" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <title>Codex 项目管理工具 v3</title>
  <script>
    // Keep a stable short URL for bookmarking (Chrome will use this as the bookmark address).
    try {
      if (location.pathname.endsWith("/live-view-v3.html") || location.pathname.endsWith("/live-view.html")) {
        history.replaceState(null, "", "/pm");
      }
    } catch (_) {}
  </script>
  <style>
    :root {
      --bg: #f4f5f7;
      --bg-2: #e9edf5;
      --card: #ffffff;
      --line: #dfe1e6;
      --line-soft: #ebedf2;
      --text: #172b4d;
      --muted: #5e6c84;
      --ok: #36b37e;
      --warn: #ffab00;
      --brand: #0052cc;
      --brand-soft: #deebff;
      --p0: #de350b;
      --p1: #0052cc;
      --p2: #6b778c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      background: radial-gradient(900px 520px at 80% -10%, #dbeafe 0%, transparent 60%), linear-gradient(180deg, var(--bg-2) 0%, var(--bg) 30%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
    }
    .wrap {
      max-width: 1640px;
      margin: 18px auto;
      padding: 0 16px 24px;
      display: grid;
      gap: 12px;
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(9, 30, 66, 0.08);
    }
    .tab-card .head {
      border-bottom: 0;
    }
    .tab-nav {
      padding: 10px 12px 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      border-top: 1px solid var(--line);
      background: #fafbfc;
    }
    .tab-btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid #c1c7d0;
      background: #f4f5f7;
      color: #253858;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      color: #0747a6;
      border-color: #4c9aff;
      background: #deebff;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .head {
      padding: 12px 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px 14px;
      border-bottom: 1px solid var(--line);
      background: #fafbfc;
    }
    .head select {
      height: 32px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      padding: 0 10px;
      min-width: 168px;
    }
    .project-filter-native { display: none !important; }
    .project-filter-native.fallback-visible {
      display: inline-flex !important;
      min-width: 240px;
      max-width: 460px;
      height: 34px;
    }
    .project-filter-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1 1 min(1100px, 100%);
      min-width: min(760px, 100%);
      max-width: min(1180px, 100%);
    }
    .project-filter-wrap.fallback {
      display: none;
    }
    .project-filter-viewport {
      position: relative;
      flex: 1 1 auto;
      min-width: 240px;
    }
    .project-filter-nav {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      width: 100%;
      overflow-x: auto;
      scrollbar-width: thin;
      padding: 4px;
      border: 1px solid #d9e0ec;
      border-radius: 999px;
      background: linear-gradient(180deg, #f8fafd 0%, #eef2f8 100%);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.85);
      scroll-behavior: smooth;
    }
    .project-filter-nav::-webkit-scrollbar {
      height: 8px;
    }
    .project-fade {
      position: absolute;
      top: 5px;
      bottom: 5px;
      width: 28px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.16s ease;
    }
    .project-fade.show { opacity: 1; }
    .project-fade.left {
      left: 2px;
      border-radius: 999px 0 0 999px;
      background: linear-gradient(90deg, rgba(238, 242, 248, 0.95) 0%, rgba(238, 242, 248, 0) 100%);
    }
    .project-fade.right {
      right: 2px;
      border-radius: 0 999px 999px 0;
      background: linear-gradient(270deg, rgba(238, 242, 248, 0.95) 0%, rgba(238, 242, 248, 0) 100%);
    }
    .project-nav-btn {
      height: 30px;
      min-width: 30px;
      border-radius: 999px;
      border: 1px solid #c8d4e8;
      background: #fff;
      color: #42526e;
      font-size: 14px;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .project-nav-btn:hover:not(:disabled) {
      border-color: #4c9aff;
      color: #0747a6;
      background: #deebff;
    }
    .project-nav-btn:disabled {
      opacity: 0.42;
      cursor: not-allowed;
    }
    .project-nav-btn:focus-visible,
    .project-fav-btn:focus-visible,
    .project-tool-btn:focus-visible {
      outline: 2px solid #4c9aff;
      outline-offset: 1px;
    }
    .project-tool-btn {
      height: 30px;
      min-width: 44px;
      border-radius: 999px;
      border: 1px solid #c8d4e8;
      background: #fff;
      color: #42526e;
      font-size: 11px;
      font-weight: 800;
      padding: 0 10px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .project-tool-btn:hover {
      border-color: #4c9aff;
      color: #0747a6;
      background: #deebff;
    }
    .project-pager {
      display: none;
      align-items: center;
      gap: 4px;
      flex: 0 0 auto;
      color: #5e6c84;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
    }
    .project-pager.show { display: inline-flex; }
    .project-group-label {
      font-size: 11px;
      color: #5e6c84;
      font-weight: 800;
      border: 1px dashed #c8d4e8;
      border-radius: 999px;
      padding: 4px 8px;
      background: #f8fafc;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .project-pill-wrap {
      position: relative;
      display: flex;
      align-items: stretch;
      flex: 0 0 auto;
    }
    .project-pill {
      border: 1px solid transparent;
      background: transparent;
      color: #42526e;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      line-height: 1.1;
      white-space: nowrap;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      gap: 2px;
      min-height: 34px;
      max-width: 360px;
      transition: background-color 0.16s ease, border-color 0.16s ease, color 0.16s ease, transform 0.16s ease, box-shadow 0.16s ease;
    }
    .project-pill:hover,
    .project-pill:focus-visible {
      background: #ffffff;
      border-color: #c8d4e8;
      color: #1d3b66;
      transform: translateY(-1px);
      outline: none;
    }
    .project-pill.active {
      color: #0747a6;
      border-color: #4c9aff;
      background: linear-gradient(180deg, #ffffff 0%, #deebff 100%);
      box-shadow: 0 1px 4px rgba(9, 30, 66, 0.16), inset 0 0 0 1px rgba(76, 154, 255, 0.18);
      transform: translateY(-1px);
    }
    .project-pill-title-row {
      display: flex;
      align-items: center;
      gap: 6px;
      max-width: 320px;
    }
    .project-pill-title {
      font-weight: 800;
      color: inherit;
      max-width: 230px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .project-status-badges {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .project-status-badge {
      font-size: 10px;
      font-weight: 900;
      border-radius: 999px;
      padding: 1px 6px;
      border: 1px solid transparent;
      line-height: 1.35;
    }
    .project-status-badge.doing {
      color: #006644;
      border-color: #79f2c0;
      background: #e3fcef;
    }
    .project-status-badge.waiting {
      color: #974f0c;
      border-color: #ffd6a2;
      background: #fff7d6;
    }
    .project-pill-meta {
      font-size: 11px;
      color: #6b778c;
      font-weight: 600;
      max-width: 320px;
      overflow: hidden;
      text-overflow: ellipsis;
      max-height: 0;
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity 0.16s ease, max-height 0.16s ease, transform 0.16s ease;
    }
    .project-pill:hover .project-pill-meta,
    .project-pill:focus-visible .project-pill-meta,
    .project-pill.active .project-pill-meta {
      max-height: 20px;
      opacity: 1;
      transform: translateY(0);
    }
    .project-pill.active .project-pill-meta {
      color: #2f5f9d;
    }
    .project-pill:focus-visible {
      outline: 2px solid #4c9aff;
      outline-offset: 1px;
    }
    .project-fav-btn {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #c8d4e8;
      background: #fff;
      color: #a5adba;
      font-size: 11px;
      font-weight: 900;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.16s ease, color 0.16s ease, border-color 0.16s ease, background-color 0.16s ease;
    }
    .project-pill-wrap:hover .project-fav-btn,
    .project-pill-wrap .project-fav-btn.active {
      opacity: 1;
    }
    .project-fav-btn:hover {
      color: #f5a623;
      border-color: #f5a623;
      background: #fff8e1;
    }
    .project-fav-btn.active {
      color: #f5a623;
      border-color: #f5a623;
      background: #fff8e1;
    }
    .title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: #091e42;
    }
    .meta {
      color: var(--muted);
      font-size: 13px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: var(--ok);
      box-shadow: 0 0 0 2px rgba(54, 179, 126, 0.18);
      display: inline-block;
    }
    .dot.warn {
      background: var(--warn);
      box-shadow: 0 0 0 2px rgba(255, 171, 0, 0.2);
    }
    .todo-wrap { padding: 12px; display: grid; gap: 12px; }
    .board-subnav {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      padding: 6px 0 2px;
    }
    .board-spacer { flex: 1 1 auto; }
    .search-input {
      height: 32px;
      border-radius: 999px;
      border: 1px solid #c1c7d0;
      background: #fff;
      color: #091e42;
      padding: 0 12px;
      font-size: 13px;
      width: min(360px, 100%);
    }
    .density-pill {
      border: 1px solid #c1c7d0;
      background: #f4f5f7;
      color: #42526e;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
    }
    .density-pill.active {
      color: #0747a6;
      border-color: #4c9aff;
      background: #deebff;
    }
    .board-subtab {
      border: 1px solid #c1c7d0;
      background: #f4f5f7;
      color: #42526e;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
    }
    .board-subtab.active {
      color: #0747a6;
      border-color: #4c9aff;
      background: #deebff;
    }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    input[type="text"], select, textarea {
      height: 36px;
      border-radius: 8px;
      border: 1px solid #c1c7d0;
      background: #fff;
      color: #091e42;
      padding: 0 10px;
      font-size: 14px;
    }
    textarea {
      height: auto;
      padding: 10px 10px;
      line-height: 1.5;
      min-height: 92px;
      resize: vertical;
    }
    input[type="text"] {
      width: min(620px, 100%);
      flex: 1 1 520px;
      min-width: 260px;
    }
    select { min-width: 112px; }
    button {
      border: 1px solid #c1c7d0;
      background: #f4f5f7;
      color: #172b4d;
      border-radius: 8px;
      padding: 7px 11px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      border-color: #a5adba;
      background: #ebecf0;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.65;
    }
    .todo-list {
      display: grid;
      gap: 12px;
      grid-auto-flow: column;
      grid-auto-columns: minmax(320px, 1fr);
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .todo-section {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #f7f8fa;
      min-height: 380px;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .todo-section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      background: #ebecf0;
      border-bottom: 1px solid var(--line-soft);
    }
    .todo-section-body {
      display: grid;
      align-content: start;
      gap: 8px;
      min-height: 150px;
      padding: 8px;
    }
    .todo-section-body.drag-over {
      background: #deebff;
      outline: 1px dashed var(--brand);
      outline-offset: -1px;
    }
    body.drag-mode .todo-section.drop-allowed {
      border-color: #4c9aff;
      box-shadow: 0 0 0 2px rgba(76, 154, 255, 0.16);
    }
    body.drag-mode .todo-section.drop-allowed .todo-section-head {
      color: #0747a6;
      background: #deebff;
    }
    body.drag-mode .todo-section-body.drop-allowed {
      background: #f0f7ff;
    }
    body.drag-mode .todo-section.drop-blocked {
      opacity: 0.45;
      filter: grayscale(0.15);
    }
    body.drag-mode .todo-section.drop-blocked .todo-section-body {
      cursor: not-allowed;
    }
    .todo-item {
      display: grid;
      grid-template-columns: 28px 1fr;
      grid-template-areas:
        "handle head"
        "handle main";
      gap: 6px 8px;
      align-items: start;
      padding: 8px 9px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      cursor: default;
      box-shadow: 0 1px 2px rgba(9, 30, 66, 0.08);
      transition: box-shadow 120ms ease, border-color 120ms ease;
    }
    .todo-item:hover {
      border-color: #b3bac5;
      box-shadow: 0 3px 8px rgba(9, 30, 66, 0.12);
    }
	    .todo-item.dragging {
	      opacity: 0.65;
	      box-shadow: inset 0 0 0 1px var(--brand);
	    }
	    .todo-item.selected {
	      border-color: #4c9aff;
	      box-shadow: 0 0 0 2px rgba(76, 154, 255, 0.18);
	    }
	    .todo-item.selected .todo-text { color: #091e42; }
    .todo-item.pri-p0 { border-left: 3px solid var(--p0); }
    .todo-item.pri-p1 { border-left: 3px solid var(--p1); }
    .todo-item.pri-p2 { border-left: 3px solid var(--p2); }
    .density-compact .todo-item { padding: 7px 8px; gap: 6px 8px; }
    .density-compact .todo-text {
      font-size: 13px;
      font-weight: 700;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
    }
    .density-compact .todo-item:not(.expanded) .todo-meta { display: none; }
    .density-compact .todo-section { min-height: 320px; }
    .density-compact .todo-section-body { gap: 6px; }
    .density-compact .status-btn { padding: 3px 7px; }
    .drag-handle {
      grid-area: handle;
      z-index: 2;
      color: #1f66ff;
      user-select: none;
      touch-action: none;
      line-height: 1;
      cursor: grab;
      width: 26px;
      min-width: 26px;
      height: 26px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #4c9aff;
      background: #e8f1ff;
      box-shadow: inset 0 0 0 1px #ffffff;
      transition: color 120ms ease, background 120ms ease, border-color 120ms ease;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -3px;
      padding: 0;
    }
    .drag-grip {
      display: inline-block;
      color: currentColor;
      line-height: 1;
      pointer-events: none;
      transform: translateY(-1px);
      opacity: 1;
    }
    .drag-handle:hover,
    .drag-handle:active {
      color: #0052cc;
      border-color: #1f66ff;
      background: #d9e6ff;
    }

    .drag-handle:active {
      cursor: grabbing;
      background: #cfe0ff;
    }

    .todo-drop-marker {
      height: 2px;
      margin: 4px 0;
      border-radius: 999px;
      background: linear-gradient(90deg, transparent, #4c9aff, transparent);
      animation: todo-drop-marker-pulse 900ms ease-in-out infinite;
      opacity: 0.85;
    }

    @keyframes todo-drop-marker-pulse {
      0%,
      100% {
        transform: scaleX(0.7);
      }

      50% {
        transform: scaleX(1);
      }
    }

    .todo-main {
      grid-area: main;
      display: grid;
      gap: 8px;
    }
    .todo-text {
      font-size: 15px;
      line-height: 1.45;
      color: #172b4d;
      word-break: break-word;
      font-weight: 600;
    }
    .todo-text.done { text-decoration: line-through; opacity: 0.7; }
    .todo-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      line-height: 1.35;
    }
    .badge {
      font-size: 11px;
      border: 1px solid #c1c7d0;
      border-radius: 999px;
      padding: 1px 7px;
      color: #344563;
      background: #fff;
    }
    .badge.p0 { color: var(--p0); border-color: #ff8f73; }
    .badge.p1 { color: var(--p1); border-color: #4c9aff; }
    .badge.p2 { color: var(--p2); border-color: #a5adba; }
	    .badge.project {
	      color: #0747a6;
	      background: #deebff;
	      border-color: #b3d4ff;
	    }
	    .badge.git {
	      color: #006644;
	      border-color: #79f2c0;
	      background: #e3fcef;
	    }
	    .badge.tests {
	      color: #253858;
	      border-color: #dfe1e6;
	      background: #fafbfc;
	    }
	    .badge.tests.pass {
	      color: #006644;
	      border-color: #79f2c0;
	      background: #e3fcef;
	    }
	    .badge.tests.fail {
	      color: #bf2600;
	      border-color: #ff8f73;
	      background: #ffebe6;
	    }
	    .badge.tests.not_run { color: #5e6c84; }
    .status-bar {
      grid-area: head;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    .status-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f4f5f7;
    }
    .status-btn.active {
      border-color: #4c9aff;
      color: #0747a6;
      background: #deebff;
    }
    .icon-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      border-radius: 10px;
      padding: 4px 6px;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
    }
    .icon-btn:hover {
      border-color: #c1c7d0;
      background: #ebecf0;
      color: #172b4d;
    }
    .icon-btn:active { transform: translateY(0.5px); }
    .menu-wrap { position: relative; display: inline-flex; }
    .more-btn { font-weight: 900; letter-spacing: 1px; }
    .todo-menu {
      position: absolute;
      top: 28px;
      right: 0;
      min-width: 140px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(9, 30, 66, 0.18);
      padding: 6px;
      z-index: 60;
    }
    .menu-item {
      width: 100%;
      text-align: left;
      border: 0;
      background: transparent;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      color: #172b4d;
      font-weight: 700;
    }
    .menu-item:hover { background: #f4f5f7; }
    .menu-item.danger { color: #bf2600; }
    .btn-danger {
      border-color: #ff8f73;
      background: #ffebe6;
      color: #bf2600;
    }
    .empty-line {
      padding: 12px;
      font-size: 13px;
      color: var(--muted);
      border: 1px dashed var(--line);
      border-radius: 8px;
      background: #fff;
    }
    .tiny { font-size: 12px; color: var(--muted); line-height: 1.45; }
    .agent-strip {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .agent-chip {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #b3d4ff;
      color: #0747a6;
      background: #deebff;
      line-height: 1.2;
      cursor: pointer;
    }
	    .agent-chip.stale {
	      border-color: #dfe1e6;
	      color: #6b778c;
	      background: #f4f5f7;
	    }
	    .iter-wrap { padding: 12px; display: grid; gap: 10px; }
	    .iter-calendar {
	      display: flex;
	      align-items: center;
	      gap: 8px;
	      border: 1px solid var(--line);
	      border-radius: 10px;
	      background: #fff;
	      padding: 6px 8px;
	    }
	    .iter-cal-btn {
	      border-radius: 10px;
	      padding: 6px 10px;
	      background: #f4f5f7;
	      font-weight: 800;
	      color: #344563;
	    }
	    .iter-cal-strip {
	      flex: 1;
	      display: flex;
	      gap: 8px;
	      overflow-x: auto;
	      padding: 2px 2px;
	      scroll-behavior: smooth;
	    }
	    .iter-cal-day {
	      min-width: 86px;
	      border: 1px solid #dfe1e6;
	      border-radius: 12px;
	      background: #fafbfc;
	      padding: 8px 10px;
	      display: grid;
	      gap: 2px;
	      text-align: left;
	      cursor: pointer;
	      user-select: none;
	    }
	    .iter-cal-day:hover { border-color: #b3bac5; background: #fff; }
	    .iter-cal-day.active {
	      border-color: #4c9aff;
	      background: #deebff;
	      box-shadow: 0 0 0 2px rgba(76, 154, 255, 0.16);
	    }
	    .iter-cal-day .md { font-size: 13px; font-weight: 900; color: #172b4d; line-height: 1.1; }
	    .iter-cal-day .wk { font-size: 11px; color: var(--muted); font-weight: 700; }
	    .iter-input {
	      width: min(520px, 100%);
	      flex: 1 1 340px;
	      min-width: 220px;
	    }
    .iter-timeline {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      max-height: 320px;
      overflow: auto;
      padding: 10px;
      display: grid;
      gap: 10px;
    }
    .iter-day {
      border: 1px solid var(--line-soft);
      border-radius: 8px;
      background: #fafbfc;
      padding: 8px 10px;
      display: grid;
      gap: 8px;
    }
    .iter-day-title {
      font-size: 13px;
      font-weight: 700;
      color: #253858;
    }
    .iter-item {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      padding: 8px;
      display: grid;
      gap: 6px;
    }
    .iter-head {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }
    .iter-title {
      font-size: 14px;
      font-weight: 600;
      color: #172b4d;
      line-height: 1.4;
      word-break: break-word;
    }
    .iter-summary {
      font-size: 13px;
      color: #344563;
      line-height: 1.45;
      word-break: break-word;
    }
    .modal-mask {
      position: fixed;
      inset: 0;
      background: rgba(9, 30, 66, 0.42);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }
    .modal-mask.show { display: flex; }
    .modal {
      width: min(560px, 96vw);
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: 0 20px 48px rgba(9, 30, 66, 0.28);
      overflow: hidden;
    }
    .modal-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: #fafbfc;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-weight: 700;
      color: #091e42;
    }
    .modal-body {
      padding: 14px;
      display: grid;
      gap: 10px;
    }
    .modal-foot {
      padding: 12px 14px;
      border-top: 1px solid var(--line);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      background: #fafbfc;
    }
    .modal .field {
      display: grid;
      gap: 6px;
    }
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      border: 0 !important;
      white-space: nowrap !important;
    }
    .project-search-modal { width: min(720px, 96vw); }
    .project-search-input {
      width: 100%;
      height: 38px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 0 12px;
      font-size: 14px;
      font-weight: 600;
      color: #172b4d;
      background: #fff;
    }
    .project-search-list {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      max-height: min(54vh, 520px);
      overflow: auto;
      display: grid;
      gap: 6px;
      padding: 8px;
    }
    .project-search-item {
      width: 100%;
      border: 1px solid transparent;
      border-radius: 10px;
      background: #fafbfc;
      color: #172b4d;
      text-align: left;
      padding: 8px 10px;
      display: grid;
      gap: 4px;
      cursor: pointer;
    }
    .project-search-item:hover,
    .project-search-item.active {
      border-color: #4c9aff;
      background: #deebff;
      color: #0747a6;
    }
    .project-search-name {
      font-size: 13px;
      font-weight: 800;
      line-height: 1.35;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .project-search-meta {
      font-size: 11px;
      color: #5e6c84;
      line-height: 1.35;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .project-search-hint {
      font-size: 11px;
      color: #5e6c84;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .project-search-empty {
      border: 1px dashed #c8d4e8;
      border-radius: 10px;
      background: #fafbfc;
      color: #5e6c84;
      font-size: 12px;
      font-weight: 700;
      padding: 12px;
      text-align: center;
    }
    .modal label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }
    .modal input[type="text"], .modal select, .modal textarea {
      width: 100%;
      min-width: 0;
    }
    .cmd-modal { width: min(1040px, 96vw); }
    .cmd-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .cmd-tab {
      border: 1px solid var(--line);
      background: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 700;
      color: #172b4d;
    }
    .cmd-tab.active { color: #0747a6; border-color: #4c9aff; background: #deebff; }
    .cmd-panel { display: none; }
    .cmd-panel.active { display: grid; gap: 10px; }
    .cmd-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    .cmd-title { font-weight: 900; color: #091e42; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .cmd-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .cmd-pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.45;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line-soft);
      background: #fafbfc;
      white-space: pre-wrap;
      word-break: break-word;
      user-select: text;
    }
    .cmd-pre.small { font-size: 11px; }
    .cmd-kv { display: grid; gap: 6px; }
    .cmd-kv .tiny { margin: 0; }
    .editor-wrap { padding: 12px; display: grid; gap: 10px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    .doc-tools {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .doc-tools button.active {
      color: #0747a6;
      border-color: #4c9aff;
      background: #deebff;
    }
    .doc-tools .tiny {
      margin-left: auto;
    }
    .editor {
      min-height: 52vh;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 14px;
      background: #fff;
      font-size: 16px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      overflow: auto;
      outline: none;
    }
    /* Doc (visual) */
    .doc-visual-wrap { padding: 12px; }
    .doc-layout {
      display: grid;
      grid-template-columns: 240px minmax(0, 1fr) 360px;
      gap: 12px;
      align-items: start;
    }
    /* Fix: when TOC is collapsed we may hide the TOC element; force stable grid placement so the main doc column never collapses. */
    .doc-toc-side { grid-column: 1; }
    .doc-pane { grid-column: 2; min-width: 0; }
    .doc-side { grid-column: 3; min-width: 0; }
    body.toc-collapsed .doc-layout {
      grid-template-columns: 0px minmax(0, 1fr) 360px;
    }
    body.toc-collapsed .doc-toc-side { display: none; }
    .doc-pane, .doc-side-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(9, 30, 66, 0.06);
    }
    .doc-pane-head, .doc-side-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line-soft);
      background: #fafbfc;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .doc-pane-title, .doc-side-title {
      font-size: 13px;
      font-weight: 900;
      color: #091e42;
      letter-spacing: 0.2px;
    }
    .doc-pane-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .doc-pane-actions .tiny { margin-left: 6px; }
    .doc-scroll {
      max-height: 68vh;
      overflow: auto;
      padding: 14px 16px;
      background: radial-gradient(720px 360px at 20% -20%, #eff6ff 0%, transparent 60%), #fff;
    }
    .doc-render { max-width: 80ch; margin: 0 auto; }
    .doc-render h1 {
      margin: 0 0 12px;
      font-size: 26px;
      line-height: 1.2;
      letter-spacing: 0.2px;
      color: #091e42;
    }
    .doc-render h2 {
      margin: 18px 0 10px;
      font-size: 18px;
      line-height: 1.25;
      color: #091e42;
      border-bottom: 1px solid #ebecf0;
      padding-bottom: 6px;
    }
    .doc-render h3 {
      margin: 14px 0 8px;
      font-size: 15px;
      line-height: 1.3;
      color: #172b4d;
    }
    .doc-render h4 {
      margin: 12px 0 6px;
      font-size: 13px;
      line-height: 1.3;
      color: #253858;
    }
    .doc-render p {
      margin: 8px 0;
      font-size: 15px;
      line-height: 1.75;
      color: #172b4d;
    }
    .doc-render a { color: #0052cc; text-decoration: none; font-weight: 800; }
    .doc-render a:hover { text-decoration: underline; }
    .doc-render code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #dfe1e6;
      background: #fafbfc;
      color: #253858;
    }
    .doc-render pre {
      margin: 10px 0;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #dfe1e6;
      background: #0b1220;
      color: #e6edf3;
      overflow: auto;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .doc-render pre code {
      padding: 0;
      border: 0;
      background: transparent;
      color: inherit;
      border-radius: 0;
      font-size: 12px;
      line-height: 1.6;
      display: block;
      white-space: pre;
    }
    .doc-render blockquote {
      margin: 10px 0;
      padding: 10px 12px;
      border-left: 3px solid #4c9aff;
      background: #f0f7ff;
      border-radius: 12px;
      color: #172b4d;
    }
    .doc-render ul, .doc-render ol {
      margin: 8px 0 8px 20px;
      padding: 0;
      display: grid;
      gap: 6px;
      color: #172b4d;
      font-size: 15px;
      line-height: 1.7;
    }
    .doc-render hr { border: 0; border-top: 1px solid #ebecf0; margin: 14px 0; }
    .doc-toc-body {
      max-height: 68vh;
      overflow: auto;
      padding: 10px 10px 12px;
      background: #fff;
    }
    .doc-toc {
      display: grid;
      gap: 6px;
    }
    .doc-toc .tiny { margin: 0; }
    .toc-link {
      display: flex;
      gap: 8px;
      align-items: baseline;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid transparent;
      color: #172b4d;
      text-decoration: none;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
    }
    .toc-link:hover { border-color: #b3d4ff; background: #deebff; color: #0747a6; }
    .toc-link.l3 { padding-left: 18px; font-weight: 700; color: #42526e; }
    .toc-link.l4 { padding-left: 28px; font-weight: 700; color: #5e6c84; }
    .doc-side { display: grid; gap: 12px; }
    .doc-side-body { padding: 12px; display: grid; gap: 10px; }
    .doc-latest-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: radial-gradient(720px 360px at 80% -30%, #deebff 0%, transparent 60%), #fff;
      padding: 12px;
      display: grid;
      gap: 8px;
    }
    .doc-latest-title { font-size: 14px; font-weight: 900; color: #091e42; line-height: 1.35; }
    .doc-latest-desc { font-size: 12px; color: #344563; line-height: 1.55; }
    .doc-changelog {
      max-height: 68vh;
      overflow: auto;
      padding: 10px 12px;
      display: grid;
      gap: 10px;
      background: #fff;
    }
    .chg-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 10px 10px;
      display: grid;
      gap: 6px;
    }
    .chg-head { display:flex; gap:6px; flex-wrap:wrap; align-items:center; font-size: 12px; color: var(--muted); }
    .chg-title { font-size: 13px; font-weight: 900; color: #172b4d; line-height: 1.4; }
    .chg-desc { font-size: 12px; color: #344563; line-height: 1.55; }
    .chg-kv { font-size: 11px; color: var(--muted); display:flex; gap:6px; flex-wrap:wrap; line-height: 1.4; }
    .chg-chip {
      font-size: 11px;
      font-weight: 900;
      border: 1px solid #b3d4ff;
      background: #deebff;
      color: #0747a6;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      text-decoration: none;
    }
    .chg-chip:hover { background: #b3d4ff; }
    .chg-chip.muted { border-color: #dfe1e6; background: #fafbfc; color: #42526e; }
    .chg-sep { height: 1px; background: #ebecf0; margin: 4px 0; }

    /* Selection bubble + suggestions */
    .sel-bubble {
      position: fixed;
      z-index: 80;
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #b3d4ff;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 12px 24px rgba(9, 30, 66, 0.18);
      backdrop-filter: blur(10px);
      pointer-events: auto;
    }
    .sel-bubble.dragging {
      cursor: grabbing;
      opacity: 0.98;
    }
    .sel-handle {
      width: 26px;
      min-width: 26px;
      height: 26px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #4c9aff;
      background: #e8f1ff;
      color: #0052cc;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -3px;
      line-height: 1;
      user-select: none;
      touch-action: none;
      cursor: grab;
      box-shadow: inset 0 0 0 1px #ffffff;
      pointer-events: auto;
    }
    .sel-handle:hover { border-color: #1f66ff; background: #d9e6ff; }
    .sel-handle:active { cursor: grabbing; background: #cfe0ff; }
    .sel-bubble button {
      height: 28px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border-color: #b3d4ff;
      background: #deebff;
      color: #0747a6;
    }
    .sel-bubble button.secondary {
      border-color: #dfe1e6;
      background: #fafbfc;
      color: #42526e;
    }
    .suggest-quote {
      border: 1px solid #b3d4ff;
      background: #deebff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      color: #0747a6;
      line-height: 1.55;
      max-height: 120px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .suggest-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 10px 10px;
      display: grid;
      gap: 6px;
    }
    .suggest-item .q { font-size: 12px; color: #172b4d; font-weight: 900; line-height: 1.45; }
    .suggest-item .s { font-size: 12px; color: #344563; line-height: 1.55; }
    .suggest-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .suggest-actions .status-btn { padding: 4px 8px; font-size: 11px; border-radius: 999px; }
	    .bar { padding: 10px 12px 14px; border-top: 1px solid var(--line); display: flex; gap: 8px; flex-wrap: wrap; }
	    .settings-wrap { padding: 12px; display: grid; gap: 10px; }
	    .setting-card {
	      border: 1px solid var(--line);
	      border-radius: 12px;
	      background: #fff;
	      padding: 12px;
	      display: grid;
	      gap: 10px;
	    }
	    .setting-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
	    .toggle {
	      display: inline-flex;
	      align-items: center;
	      gap: 8px;
	      font-size: 13px;
	      font-weight: 700;
	      color: #172b4d;
	      user-select: none;
	    }
	    .toggle input { width: 18px; height: 18px; }
	    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
	    .license-input { flex: 1 1 760px; width: min(920px, 100%); }
	    .badge.sub.active { color: #006644; border-color: #79f2c0; background: #e3fcef; }
	    .badge.sub.expired { color: #bf2600; border-color: #ff8f73; background: #ffebe6; }
	    .badge.sub.invalid { color: #bf2600; border-color: #ff8f73; background: #ffebe6; }
	    .badge.sub.revoked { color: #bf2600; border-color: #ff8f73; background: #ffebe6; }
	    .badge.sub.limit_reached { color: #974f0c; border-color: #ffd6a2; background: #fff7d6; }
	    .badge.sub.error { color: #bf2600; border-color: #ff8f73; background: #ffebe6; }
	    .badge.sub.unverified { color: #5e6c84; border-color: #dfe1e6; background: #fafbfc; }
	    .badge.sub.inactive { color: #5e6c84; border-color: #dfe1e6; background: #fafbfc; }
	    .act-input { flex: 1 1 520px; width: min(760px, 100%); }
	    .svc-group {
	      border: 1px solid var(--line);
	      border-radius: 12px;
	      background: #fff;
	      overflow: hidden;
	      box-shadow: 0 1px 2px rgba(9, 30, 66, 0.06);
	    }
	    .svc-group-head {
	      display: flex;
	      align-items: center;
	      justify-content: space-between;
	      gap: 10px;
	      padding: 10px 12px;
	      border-bottom: 1px solid var(--line-soft);
	      background: #fafbfc;
	      font-size: 13px;
	      font-weight: 800;
	      color: #091e42;
	    }
	    .svc-group-meta { font-size: 12px; color: var(--muted); font-weight: 700; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
	    .svc-items { padding: 10px 12px; display: grid; gap: 10px; }
	    .svc-item {
	      border: 1px solid var(--line);
	      border-radius: 12px;
	      background: #fff;
	      padding: 10px 10px;
	      display: grid;
	      gap: 8px;
	    }
	    .svc-item-top { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
	    .svc-name { font-size: 14px; font-weight: 800; color: #172b4d; }
	    .svc-right { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
	    .svc-status {
	      font-size: 11px;
	      border: 1px solid #dfe1e6;
	      border-radius: 999px;
	      padding: 2px 8px;
	      font-weight: 900;
	      background: #fafbfc;
	      color: #253858;
	    }
	    .svc-status.up { border-color: #79f2c0; background:#e3fcef; color:#006644; }
	    .svc-status.loaded { border-color: #b3d4ff; background:#deebff; color:#0747a6; }
	    .svc-status.down { border-color: #ff8f73; background:#ffebe6; color:#bf2600; }
	    .svc-kv { font-size: 12px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; line-height:1.35; }
	    .svc-kv .mono { font-size: 12px; }
	    .svc-links { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
	    .svc-link {
	      font-size: 12px;
	      font-weight: 800;
	      color: #0747a6;
	      text-decoration: none;
	      border: 1px solid #b3d4ff;
	      background:#deebff;
	      padding: 3px 8px;
	      border-radius: 999px;
	    }
	    .svc-link:hover { background:#b3d4ff; }
	    @media (max-width: 980px) {
	      .wrap { padding: 0 10px 18px; }
	      .todo-list { grid-auto-columns: minmax(260px, 1fr); }
	      .todo-text { font-size: 14px; }
	      input[type="text"] { flex-basis: 100%; }
      .project-filter-wrap { width: 100%; min-width: 0; }
      .project-filter-viewport { min-width: 0; }
      .project-pill { padding: 6px 10px; max-width: 280px; }
      .project-pill-title { max-width: 170px; }
      .project-pill-meta { max-width: 220px; }
      .project-nav-btn { min-width: 28px; height: 28px; }
	      .tab-nav { overflow-x: auto; flex-wrap: nowrap; }
	      .tab-btn { white-space: nowrap; }
	      .doc-layout { grid-template-columns: 1fr; }
	      .doc-toc-side, .doc-pane, .doc-side { grid-column: auto; }
	      body.toc-collapsed .doc-layout { grid-template-columns: 1fr; }
	      .doc-scroll, .doc-changelog { max-height: 56vh; }
	    }
  </style>
</head>
<body>
  <div class="wrap">
	    <section class="card tab-card">
	      <div class="head">
	        <div class="title">Codex 项目管理工具 v3</div>
	          <div class="meta">
            <span>项目</span>
            <div id="projectFilterWrap" class="project-filter-wrap">
              <button id="projectTabsPrev" class="project-nav-btn" type="button" title="向左滚动项目">‹</button>
              <div id="projectTabsViewport" class="project-filter-viewport">
                <div id="projectTabs" class="project-filter-nav" role="tablist" aria-label="查看项目（全局）"></div>
                <span id="projectTabsFadeLeft" class="project-fade left" aria-hidden="true"></span>
                <span id="projectTabsFadeRight" class="project-fade right" aria-hidden="true"></span>
              </div>
              <button id="projectTabsNext" class="project-nav-btn" type="button" title="向右滚动项目">›</button>
              <span id="projectTabsPagerWrap" class="project-pager" aria-live="polite">
                <button id="projectTabsPagePrev" class="project-nav-btn" type="button" title="上一页项目">‹页</button>
                <span id="projectTabsPager">1/1</span>
                <button id="projectTabsPageNext" class="project-nav-btn" type="button" title="下一页项目">页›</button>
              </span>
              <button id="projectSearchBtn" class="project-tool-btn" type="button" title="搜索项目 (⌘/Ctrl+K)">搜索</button>
              <button id="projectStateShareBtn" class="project-tool-btn" type="button" title="复制当前视图链接">分享</button>
              <button id="projectStateShortTplBtn" class="project-tool-btn" type="button" title="复制短链参数模板">短链</button>
            </div>
	            <select id="projectFilter" class="project-filter-native" title="查看项目（全局）" aria-hidden="true" tabindex="-1">
	              <option value="__all__">全部项目</option>
	            </select>
            <span id="projectA11yStatus" class="sr-only" aria-live="polite"></span>
            <span>页面布局：分Tab收纳</span>
            <span id="pageVersion" class="tiny"></span>
          </div>
	      </div>
	      <div class="tab-nav" role="tablist" aria-label="主导航">
	        <button class="tab-btn active" type="button" data-tab-target="board">任务看板</button>
	        <button class="tab-btn" type="button" data-tab-target="iterations">日程日志</button>
	        <button class="tab-btn" type="button" data-tab-target="doc">项目文档</button>
	        <button class="tab-btn" type="button" data-tab-target="services">服务状态</button>
	        <button class="tab-btn" type="button" data-tab-target="settings">设置</button>
	      </div>
	    </section>

    <section class="card tab-panel active" data-tab-panel="board">
      <div class="head">
        <div class="title">任务看板</div>
        <div class="meta">
          <span id="todoDot" class="dot"></span>
          <span id="todoStatus">连接中</span>
          <span id="currentProjectLabel">项目: 全部</span>
          <span>在线终端: <span id="agentCount">0</span></span>
          <span>进行中: <span id="countDoing">0</span></span>
          <span>待完成: <span id="countDoneReq">0</span></span>
          <span>待回滚: <span id="countRollbackReq">0</span></span>
          <span>待办: <span id="countTodo">0</span></span>
          <span>完成: <span id="countDone">0</span></span>
        </div>
      </div>
      <div class="todo-wrap">
        <div class="row">
          <input id="newTodoText" type="text" placeholder="新增任务：例如“实现 daily-brief <= 3 条规则”" />
          <select id="newTodoProject" title="任务归属项目">
            <option value="coach-feishu-suite">coach-feishu-suite</option>
          </select>
          <select id="newTodoPriority">
            <option value="P0">P0</option>
            <option value="P1" selected>P1</option>
            <option value="P2">P2</option>
          </select>
          <button id="addTodoBtn" type="button">添加任务</button>
          <button id="quickAddBtn" type="button">快速添加</button>
          <button id="refreshTodoBtn" type="button">刷新任务</button>
          <button id="cleanupAgentsBtn" type="button">清理历史终端</button>
          <button id="cmdHelpBtn" type="button">命令速查</button>
        </div>
        <div class="tiny">看板交互：列内可拖拽排序；跨列仅允许规则流转（待办→进行中、进行中→待机器完成、已完成→待机器回滚、待机器回滚→已完成）。完成/回滚仍由机器确认。可按项目筛选并给任务设置项目归属。</div>
        <div class="tiny">终端标签支持点击重命名（仅看板显示名，便于与你本地终端标签对齐）。</div>
        <div id="agentStrip" class="agent-strip"></div>
        <div class="board-subnav" role="tablist" aria-label="看板视图">
          <button class="board-subtab active" type="button" data-board-view="execution">执行态</button>
          <button class="board-subtab" type="button" data-board-view="todo">待办态</button>
          <button class="board-subtab" type="button" data-board-view="done">完成态</button>
          <button class="board-subtab" type="button" data-board-view="all">全部</button>
          <span class="board-spacer"></span>
          <input id="todoSearch" class="search-input" type="text" placeholder="搜索任务（标题/ID）" />
          <button id="densityBtn" class="density-pill" type="button" title="切换紧凑/标准">紧凑</button>
        </div>
        <div id="todoList" class="todo-list"></div>
      </div>
    </section>

	    <section class="card tab-panel" data-tab-panel="iterations">
	      <div class="head">
	        <div class="title">日程表与版本日志</div>
	        <div class="meta">
	          <span id="iterDot" class="dot"></span>
	          <span id="iterStatus">连接中</span>
	          <span>记录数: <span id="iterCount">0</span></span>
	          <span>最后写入: <span id="iterLastAt">-</span></span>
	        </div>
	      </div>
	      <div class="iter-wrap">
	        <div class="row">
	          <select id="iterType" title="日志类型">
	            <option value="optimize">优化</option>
	            <option value="fix">修复</option>
	            <option value="architecture">架构</option>
	            <option value="milestone">里程碑</option>
	            <option value="manual">手动</option>
	          </select>
	          <input id="iterTitle" class="iter-input" type="text" placeholder="迭代标题：例如“完成任务拖拽规则优化”" />
	          <input id="iterSummary" class="iter-input" type="text" placeholder="补充说明（可选）" />
	          <button id="addIterBtn" type="button">记录迭代</button>
	          <button id="refreshIterBtn" type="button">刷新日志</button>
	        </div>
	        <div class="tiny">机器确认完成/回滚会自动写入版本日志并同步项目文档（`docs/project-live.md` + `ARCHITECTURE.md`）。</div>
	        <div class="iter-calendar" aria-label="按日期快速跳转">
	          <button id="iterCalPrev" class="iter-cal-btn" type="button" title="向左滚动">◀</button>
	          <div id="iterCalStrip" class="iter-cal-strip"></div>
	          <button id="iterCalNext" class="iter-cal-btn" type="button" title="向右滚动">▶</button>
	        </div>
	        <div id="iterTimeline" class="iter-timeline"></div>
	      </div>
	    </section>

	    <section class="card tab-panel" data-tab-panel="doc">
      <div class="head">
        <div class="title">项目文档（可视化）</div>
        <div class="meta">
          <span id="docDot" class="dot"></span>
          <span id="docStatus">连接中</span>
          <span>文档项目: <span id="docProjectLabel">-</span></span>
          <span>最后更新: <span id="lastDocAt">-</span></span>
          <span>轮询: 1s</span>
        </div>
      </div>
      <div class="doc-visual-wrap">
        <div class="doc-layout">
          <div id="docTocSide" class="doc-side-card doc-toc-side">
            <div class="doc-side-head">
              <div class="doc-side-title">目录</div>
              <div class="doc-pane-actions">
                <button id="docTocToggleBtn" type="button">折叠</button>
              </div>
            </div>
            <div class="doc-toc-body">
              <div id="docToc" class="doc-toc" hidden></div>
            </div>
          </div>
          <div class="doc-pane">
	            <div class="doc-pane-head">
	              <div class="doc-pane-title">项目文档</div>
	              <div class="doc-pane-actions">
		                <button id="docTocToggleBtnMain" type="button" title="展开/折叠目录">展开目录</button>
	                <button id="copyMdBtn" type="button">复制Markdown</button>
	                <button id="copyHtmlBtn" type="button">复制渲染HTML</button>
	                <span class="tiny">自动从 <span class="mono">docs/project-live.md</span> 读取</span>
	              </div>
	            </div>
            <div class="doc-scroll">
              <div id="docRender" class="doc-render">加载中...</div>
            </div>
          </div>

          <div class="doc-side">
            <div class="doc-side-card">
              <div class="doc-side-head">
                <div class="doc-side-title">本次更新</div>
                <span class="tiny">来自版本日志（产品口径）</span>
              </div>
              <div class="doc-side-body">
                <div id="docLatestIter" class="doc-latest-card"></div>
              </div>
            </div>
            <div class="doc-side-card">
              <div class="doc-side-head">
                <div class="doc-side-title">更新日志</div>
                <div class="doc-pane-actions">
                  <button id="docChangelogRefreshBtn" type="button">刷新</button>
                </div>
              </div>
              <div id="docChangelog" class="doc-changelog"></div>
            </div>
            <div class="doc-side-card">
              <div class="doc-side-head">
                <div class="doc-side-title">建议</div>
                <div class="doc-pane-actions">
                  <button id="suggestRefreshBtn" type="button">刷新</button>
                  <button id="suggestClearBtn" type="button">清空</button>
                </div>
              </div>
              <div class="doc-side-body" style="padding-top:10px;">
                <div class="tiny">在正文中圈选文字，会出现“建议→Todo”浮窗。建议会本地保存，并可一键生成 Todo。</div>
                <div id="suggestList" class="doc-changelog" style="max-height:44vh;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="tiny" style="margin-top:10px;">说明：该区只读展示。更新由机器确认完成/回滚与手动“记录迭代”驱动（版本日志会同步 AUTO 区）。</div>
      </div>
      <div class="bar">
        <button id="toggleDocBtn" type="button">暂停轮询</button>
        <button id="reloadDocBtn" type="button">立即刷新</button>
        <span id="docHint" class="tiny">提示：如你切到“全部项目”，文档展示默认项目（可在任务看板切回具体项目）。</span>
      </div>
	    </section>

      <div id="selBubble" class="sel-bubble" hidden>
        <div id="selBubbleHandle" class="sel-handle" title="拖动浮窗（双击重置为跟随圈选）" aria-hidden="true">⋮</div>
        <button id="selSuggestBtn" type="button">建议→Todo</button>
        <button id="selCopyBtn" class="secondary" type="button">复制</button>
      </div>

      <div id="suggestModal" class="modal-mask" aria-hidden="true">
        <div class="modal" style="width:min(760px, 96vw);">
          <div class="modal-head">
            <span>添加建议并生成 Todo</span>
            <button id="suggestCloseBtn" type="button">关闭</button>
          </div>
          <div class="modal-body">
            <div class="field">
              <label for="suggestQuote">圈选内容（引用）</label>
              <div id="suggestQuote" class="suggest-quote"></div>
            </div>
            <div class="field">
              <label for="suggestText">建议（你写一句即可）</label>
              <textarea id="suggestText" placeholder="例如：这里的章节结构可拆成『当前能力/使用方式/运维入口』三块，更好扫读。"></textarea>
            </div>
            <div class="field">
              <label for="suggestTodoText">生成的 Todo 内容（可编辑）</label>
              <textarea id="suggestTodoText" placeholder="将自动带上引用与章节定位"></textarea>
            </div>
            <div class="row" style="gap:10px;">
              <div class="field" style="flex:1 1 260px;">
                <label for="suggestPriority">优先级</label>
                <select id="suggestPriority">
                  <option value="P0">P0</option>
                  <option value="P1" selected>P1</option>
                  <option value="P2">P2</option>
                </select>
              </div>
              <div class="field" style="flex:2 1 420px;">
                <label for="suggestProject">项目</label>
                <select id="suggestProject"></select>
              </div>
            </div>
            <div class="tiny">提示：创建 Todo 后，你可以在“任务看板”里拖拽/申请完成，机器确认会写版本日志并同步文档 AUTO 区。</div>
          </div>
          <div class="modal-foot">
            <button id="suggestCancelBtn" type="button">取消</button>
            <button id="suggestSubmitBtn" type="button">创建 Todo</button>
          </div>
        </div>
      </div>

	    <section class="card tab-panel" data-tab-panel="settings">
	      <div class="head">
	        <div class="title">设置（Telemetry/条款）</div>
	        <div class="meta">
	          <span id="cfgDot" class="dot"></span>
	          <span id="cfgStatus">连接中</span>
	        </div>
	      </div>
	      <div class="settings-wrap">
	        <div class="setting-card">
	          <div class="setting-row">
	            <label class="toggle">
	              <input id="telemetryEnabled" type="checkbox" />
	              开启匿名遥测（默认关闭）
	            </label>
	            <span class="tiny">仅记录最小化元数据（操作类型/错误码），不记录任务正文与代码内容。</span>
	          </div>
	          <div class="setting-row">
	            <label class="toggle">
	              <input id="telemetryLocalOnly" type="checkbox" checked />
	              仅本地记录（推荐）
	            </label>
	            <label class="toggle">
	              <input id="telemetryAllowSend" type="checkbox" disabled />
	              允许上传（预留，未启用）
	            </label>
	          </div>
	          <div class="setting-row">
	            <span class="tiny">遥测日志文件：</span>
	            <span id="telemetryPath" class="mono">docs/telemetry-events.jsonl</span>
	            <a id="telemetryDownload" class="tiny" href="/telemetry-events.jsonl" download>下载</a>
	            <button id="telemetryClear" type="button">清空</button>
	            <button id="telemetryRefresh" type="button">刷新预览</button>
	          </div>
	          <div id="telemetryPreview" class="tiny mono" style="white-space:pre-wrap; max-height:220px; overflow:auto; border:1px solid var(--line-soft); border-radius:10px; padding:10px; background:#fafbfc;"></div>
	        </div>

	        <div class="setting-card">
	          <div class="setting-row">
	            <div class="tiny">订阅（MVP）：</div>
	            <a class="tiny" href="/pricing.html" target="_blank" rel="noreferrer">打开定价页</a>
	            <span id="subStatusBadge" class="badge sub inactive">inactive</span>
	          </div>
	          <div class="setting-row">
	            <input id="licenseKeyInput" class="license-input mono" type="text" placeholder="粘贴 License Key（payload.signature）" />
	            <button id="licenseSaveBtn" type="button">保存 License</button>
	            <button id="licenseClearBtn" type="button">清除</button>
	          </div>
	          <div id="licenseMeta" class="tiny">状态：未加载</div>
	          <div class="tiny">说明：默认本地存储（`docs/pm-config.json`）。如需离线验签，请按 `docs/subscription/README.md` 生成并放置 `docs/subscription/public_key.pem`。</div>
	          <div class="setting-row" style="margin-top:6px;">
	            <div class="tiny" style="font-weight:800;">云端激活（可选）：</div>
	            <span id="actStatusBadge" class="badge sub inactive">inactive</span>
	          </div>
	          <div class="setting-row">
	            <label class="tiny">模式</label>
	            <select id="actMode" style="height:34px; border:1px solid var(--line); border-radius:10px; padding:0 10px; background:#fff;">
	              <option value="offline" selected>离线（仅验签）</option>
	              <option value="cloud">云端（可吊销/设备绑定/并发）</option>
	            </select>
	            <input id="actServerUrl" class="act-input mono" type="text" placeholder="激活服务地址，例如 http://127.0.0.1:8789" />
	            <button id="actSaveBtn" type="button">保存设置</button>
	          </div>
	          <div class="setting-row">
	            <input id="actDeviceName" class="act-input" type="text" placeholder="设备名（可选，例如 MBP-Tab1）" />
	            <button id="actActivateBtn" type="button">执行云端激活</button>
	            <button id="actClearBtn" type="button">清除激活</button>
	          </div>
	          <div id="actMeta" class="tiny">云端状态：未加载</div>
	          <div class="tiny">说明：云端激活是“支付后”商业化闭环的关键能力（支持吊销/设备绑定/并发限制）。本地可先运行 `docs/subscription/license_service.py` 作为 mock。</div>
	        </div>

	        <div class="setting-card">
          <div class="tiny" style="font-weight:800;">短链服务（模板输出）</div>
          <div class="setting-row">
            <label class="tiny" for="shortenerPreset">请求格式</label>
            <select id="shortenerPreset" style="height:34px; border:1px solid var(--line); border-radius:10px; padding:0 10px; background:#fff;">
              <option value="internal_shortener_v1">internal_shortener_v1（推荐）</option>
              <option value="generic">generic</option>
            </select>
            <input id="shortenerEndpoint" class="act-input mono" type="text" placeholder="短链 API endpoint，例如 https://short.example.com/api/v1/links" />
          </div>
          <div class="setting-row">
            <input id="shortenerHeaderName" class="mono" type="text" placeholder="Header 名，例如 Authorization" style="max-width:180px;" />
            <input id="shortenerHeaderTemplate" class="act-input mono" type="text" placeholder="Header 值模板，例如 Bearer {{TOKEN}}" />
            <button id="shortenerSaveBtn" type="button">保存短链配置</button>
          </div>
          <div id="shortenerMeta" class="tiny">状态：未加载</div>
        </div>

	        <div class="setting-card">
          <div class="tiny" style="font-weight:800;">项目导航 Feature Flags：</div>
          <div class="setting-row">
            <label class="toggle"><input id="ffTabsPagination" type="checkbox" /> 分页渲染</label>
            <label class="toggle"><input id="ffTabsGrouping" type="checkbox" /> 分组展示</label>
            <label class="toggle"><input id="ffTabsBadges" type="checkbox" /> 状态徽标</label>
            <label class="toggle"><input id="ffTabsSearch" type="checkbox" /> 快速搜索</label>
          </div>
          <div class="setting-row">
            <label class="tiny" for="ffTabsThreshold">分页阈值</label>
            <input id="ffTabsThreshold" class="mono" type="text" value="80" style="max-width:100px;" />
            <label class="tiny" for="ffTabsPageSize">每页数量</label>
            <input id="ffTabsPageSize" class="mono" type="text" value="40" style="max-width:100px;" />
            <button id="ffSaveBtn" type="button">保存开关</button>
            <button id="ffResetBtn" type="button">恢复默认</button>
          </div>
          <div id="ffMeta" class="tiny">状态：未加载</div>
        </div>

	        <div class="setting-card">
	          <div class="tiny">条款与隐私（草案）：</div>
	          <div class="setting-row">
	            <a class="tiny" href="/legal/terms.md" target="_blank" rel="noreferrer">使用条款</a>
	            <a class="tiny" href="/legal/privacy.md" target="_blank" rel="noreferrer">隐私政策</a>
	            <a class="tiny" href="/legal/dpa-lite.md" target="_blank" rel="noreferrer">DPA Lite</a>
	          </div>
	          <div class="tiny">说明：默认本地存储；匿名遥测默认关闭，可随时导出/清空。</div>
	        </div>
	      </div>
	    </section>

	    <section class="card tab-panel" data-tab-panel="services">
	      <div class="head">
	        <div class="title">服务状态（按项目）</div>
	        <div class="meta">
	          <span id="svcDot" class="dot"></span>
	          <span id="svcStatus">连接中</span>
	          <span>最后检查: <span id="svcLastAt">-</span></span>
	        </div>
	      </div>
	      <div class="settings-wrap">
	        <div class="setting-card">
	          <div class="setting-row">
	            <button id="svcRefreshBtn" type="button">刷新</button>
	            <button id="svcScanBtn" type="button">扫描LaunchAgents</button>
	            <label class="toggle">
	              <input id="svcAuto" type="checkbox" checked />
	              自动刷新（3s）
	            </label>
	            <span class="tiny">基于 <span class="mono">launchctl print</span> + <span class="mono">lsof</span> 判断是否运行/监听端口；支持“全部项目”聚合展示。</span>
	          </div>
	          <div id="svcScanResult" class="tiny mono" style="white-space:pre-wrap; max-height:180px; overflow:auto; border:1px solid var(--line-soft); border-radius:10px; padding:10px; background:#fafbfc;"></div>
	          <div id="svcGrid" style="display:grid; gap:12px;"></div>
	          <div class="tiny mono">服务清单文件：每个项目可在 <span class="mono">docs/pm-services.json</span> 自定义（若缺失则用默认映射）。</div>
	        </div>
	      </div>
	    </section>
	  </div>
  <div id="quickAddModal" class="modal-mask" aria-hidden="true">
    <div class="modal">
      <div class="modal-head">
        <span>快速添加任务</span>
        <button id="quickAddCloseBtn" type="button">关闭</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="quickAddText">任务内容</label>
          <input id="quickAddText" type="text" placeholder="例如：完成多项目文档同步联调" />
        </div>
        <div class="field">
          <label for="quickAddProject">所属项目</label>
          <select id="quickAddProject"></select>
        </div>
        <div class="field">
          <label for="quickAddPriority">优先级</label>
          <select id="quickAddPriority">
            <option value="P0">P0</option>
            <option value="P1" selected>P1</option>
            <option value="P2">P2</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button id="quickAddCancelBtn" type="button">取消</button>
        <button id="quickAddSubmitBtn" type="button">创建任务</button>
      </div>
    </div>
  </div>

  <div id="confirmDoneModal" class="modal-mask" aria-hidden="true">
    <div class="modal">
      <div class="modal-head">
        <span>机器确认完成</span>
        <button id="confirmDoneCloseBtn" type="button">关闭</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="confirmDoneWhat">做了什么</label>
          <textarea id="confirmDoneWhat" rows="3" placeholder="本次交付完成了哪些事项"></textarea>
        </div>
        <div class="field">
          <label for="confirmDoneOpt">优化点</label>
          <textarea id="confirmDoneOpt" rows="3" placeholder="关键优化或改进点"></textarea>
        </div>
        <div class="field">
          <label for="confirmDoneImpact">影响</label>
          <textarea id="confirmDoneImpact" rows="3" placeholder="对稳定性/效率/体验带来的影响"></textarea>
        </div>
      </div>
      <div class="modal-foot">
        <button id="confirmDoneCancelBtn" type="button">取消</button>
        <button id="confirmDoneSubmitBtn" type="button">确认完成</button>
      </div>
    </div>
  </div>

  <div id="cmdModal" class="modal-mask" aria-hidden="true">
    <div class="modal cmd-modal">
      <div class="modal-head">
        <span>命令速查（复制即可用）</span>
        <button id="cmdCloseBtn" type="button">关闭</button>
      </div>
	      <div class="modal-body">
	        <div class="tiny">
	          说明：页面按钮本质是对 <span class="mono">/api/todos</span> 发送 action。这里把常用操作整理成可复制命令（推荐带 <span class="mono">--offline</span>）。
	        </div>
	        <div class="row" style="gap:10px; align-items:center;">
	          <label class="tiny" for="cmdModeSelect" style="font-weight:800;">命令类型</label>
	          <select id="cmdModeSelect" title="选择输出命令风格">
	            <option value="curl">curl（HTTP）</option>
	            <option value="cli">board_cli.py（推荐）</option>
	            <option value="offline">board_offline.py（无HTTP）</option>
	          </select>
	          <span class="board-spacer"></span>
	          <label class="tiny" for="cmdMachineSelect" style="font-weight:800;">机器终端</label>
	          <select id="cmdMachineSelect" title="机器确认完成/回滚时使用的 machineBy">
	            <option value="codex">codex</option>
	          </select>
	        </div>
	        <div class="cmd-tabs" role="tablist" aria-label="命令速查">
	          <button class="cmd-tab active" type="button" data-cmd-tab="attach">接入终端</button>
	          <button class="cmd-tab" type="button" data-cmd-tab="task">当前任务</button>
	          <button class="cmd-tab" type="button" data-cmd-tab="page">页面按钮</button>
	        </div>
        <div id="cmdPanelAttach" class="cmd-panel active" data-cmd-panel="attach"></div>
        <div id="cmdPanelTask" class="cmd-panel" data-cmd-panel="task"></div>
        <div id="cmdPanelPage" class="cmd-panel" data-cmd-panel="page"></div>
      </div>
      <div class="modal-foot">
        <button id="cmdRefreshBtn" type="button">刷新内容</button>
        <button id="cmdCloseBtn2" type="button">关闭</button>
      </div>
    </div>
  </div>
  <div id="projectSearchModal" class="modal-mask" aria-hidden="true">
    <div class="modal project-search-modal" role="dialog" aria-modal="true" aria-labelledby="projectSearchTitle">
      <div class="modal-head">
        <span id="projectSearchTitle">快速切换项目</span>
        <button id="projectSearchCloseBtn" type="button">关闭</button>
      </div>
      <div class="modal-body">
        <input id="projectSearchInput" class="project-search-input" type="text" placeholder="输入项目名、分组、状态关键词..." />
        <div id="projectSearchList" class="project-search-list"></div>
        <div class="project-search-hint">
          <span>快捷键：↑/↓ 选择，Enter 切换，Esc 关闭</span>
          <span>打开快捷键：⌘/Ctrl + K</span>
        </div>
      </div>
    </div>
  </div>

  <script>
	    const docRenderEl = document.getElementById("docRender");
	    const docTocEl = document.getElementById("docToc");
	    const docTocSideEl = document.getElementById("docTocSide");
	    const docTocToggleBtn = document.getElementById("docTocToggleBtn");
	    // Main toggle lives in the doc header; assign later (after DOM is ready).
	    let docTocToggleBtnMain = null;
	    const docLatestIterEl = document.getElementById("docLatestIter");
    const docChangelogEl = document.getElementById("docChangelog");
    const suggestListEl = document.getElementById("suggestList");
    const suggestRefreshBtn = document.getElementById("suggestRefreshBtn");
    const suggestClearBtn = document.getElementById("suggestClearBtn");
    const selBubbleEl = document.getElementById("selBubble");
    const selBubbleHandleEl = document.getElementById("selBubbleHandle");
    const selSuggestBtn = document.getElementById("selSuggestBtn");
    const selCopyBtn = document.getElementById("selCopyBtn");
    const suggestModalEl = document.getElementById("suggestModal");
    const suggestCloseBtn = document.getElementById("suggestCloseBtn");
    const suggestCancelBtn = document.getElementById("suggestCancelBtn");
    const suggestSubmitBtn = document.getElementById("suggestSubmitBtn");
    const suggestQuoteEl = document.getElementById("suggestQuote");
    const suggestTextEl = document.getElementById("suggestText");
    const suggestTodoTextEl = document.getElementById("suggestTodoText");
    const suggestPriorityEl = document.getElementById("suggestPriority");
    const suggestProjectEl = document.getElementById("suggestProject");
    const docStatusEl = document.getElementById("docStatus");
    const docDotEl = document.getElementById("docDot");
    const docProjectLabelEl = document.getElementById("docProjectLabel");
    const lastDocAtEl = document.getElementById("lastDocAt");
    const toggleDocBtn = document.getElementById("toggleDocBtn");
    const reloadDocBtn = document.getElementById("reloadDocBtn");
    const copyMdBtn = document.getElementById("copyMdBtn");
    const copyHtmlBtn = document.getElementById("copyHtmlBtn");
    const docChangelogRefreshBtn = document.getElementById("docChangelogRefreshBtn");
    const docHintEl = document.getElementById("docHint");

    const todoStatusEl = document.getElementById("todoStatus");
    const todoDotEl = document.getElementById("todoDot");
    const currentProjectLabelEl = document.getElementById("currentProjectLabel");
    const agentCountEl = document.getElementById("agentCount");
    const agentStripEl = document.getElementById("agentStrip");
    const countTodoEl = document.getElementById("countTodo");
    const countDoingEl = document.getElementById("countDoing");
	    const countDoneReqEl = document.getElementById("countDoneReq");
	    const countRollbackReqEl = document.getElementById("countRollbackReq");
	    const countDoneEl = document.getElementById("countDone");
	    const todoListEl = document.getElementById("todoList");
	    const projectFilterEl = document.getElementById("projectFilter");
    const projectFilterWrapEl = document.getElementById("projectFilterWrap");
	    const projectTabsEl = document.getElementById("projectTabs");
    const projectTabsViewportEl = document.getElementById("projectTabsViewport");
    const projectTabsPrevBtn = document.getElementById("projectTabsPrev");
    const projectTabsNextBtn = document.getElementById("projectTabsNext");
    const projectTabsFadeLeftEl = document.getElementById("projectTabsFadeLeft");
    const projectTabsFadeRightEl = document.getElementById("projectTabsFadeRight");
    const projectTabsPagerWrapEl = document.getElementById("projectTabsPagerWrap");
    const projectTabsPagerEl = document.getElementById("projectTabsPager");
    const projectTabsPagePrevBtn = document.getElementById("projectTabsPagePrev");
    const projectTabsPageNextBtn = document.getElementById("projectTabsPageNext");
    const projectSearchBtn = document.getElementById("projectSearchBtn");
    const projectStateShareBtn = document.getElementById("projectStateShareBtn");
    const projectStateShortTplBtn = document.getElementById("projectStateShortTplBtn");
    const projectA11yStatusEl = document.getElementById("projectA11yStatus");
	    const newTodoTextEl = document.getElementById("newTodoText");
    const newTodoProjectEl = document.getElementById("newTodoProject");
    const newTodoPriorityEl = document.getElementById("newTodoPriority");
	    const addTodoBtn = document.getElementById("addTodoBtn");
	    const quickAddBtn = document.getElementById("quickAddBtn");
	    const refreshTodoBtn = document.getElementById("refreshTodoBtn");
	    const cleanupAgentsBtn = document.getElementById("cleanupAgentsBtn");
	    const cmdHelpBtn = document.getElementById("cmdHelpBtn");
	    const quickAddModalEl = document.getElementById("quickAddModal");
	    const quickAddCloseBtn = document.getElementById("quickAddCloseBtn");
	    const quickAddCancelBtn = document.getElementById("quickAddCancelBtn");
	    const quickAddSubmitBtn = document.getElementById("quickAddSubmitBtn");
	    const quickAddTextEl = document.getElementById("quickAddText");
	    const quickAddProjectEl = document.getElementById("quickAddProject");
	    const quickAddPriorityEl = document.getElementById("quickAddPriority");
	    const confirmDoneModalEl = document.getElementById("confirmDoneModal");
	    const confirmDoneCloseBtn = document.getElementById("confirmDoneCloseBtn");
	    const confirmDoneCancelBtn = document.getElementById("confirmDoneCancelBtn");
	    const confirmDoneSubmitBtn = document.getElementById("confirmDoneSubmitBtn");
	    const confirmDoneWhatEl = document.getElementById("confirmDoneWhat");
	    const confirmDoneOptEl = document.getElementById("confirmDoneOpt");
	    const confirmDoneImpactEl = document.getElementById("confirmDoneImpact");
	    const cmdModalEl = document.getElementById("cmdModal");
	    const cmdCloseBtn = document.getElementById("cmdCloseBtn");
	    const cmdCloseBtn2 = document.getElementById("cmdCloseBtn2");
	    const cmdRefreshBtn = document.getElementById("cmdRefreshBtn");
	    const cmdPanelAttachEl = document.getElementById("cmdPanelAttach");
	    const cmdPanelTaskEl = document.getElementById("cmdPanelTask");
	    const cmdPanelPageEl = document.getElementById("cmdPanelPage");
	    const cmdTabEls = Array.from(document.querySelectorAll("[data-cmd-tab]"));
	    const cmdModeSelectEl = document.getElementById("cmdModeSelect");
	    const cmdMachineSelectEl = document.getElementById("cmdMachineSelect");
    const projectSearchModalEl = document.getElementById("projectSearchModal");
    const projectSearchCloseBtn = document.getElementById("projectSearchCloseBtn");
    const projectSearchInputEl = document.getElementById("projectSearchInput");
    const projectSearchListEl = document.getElementById("projectSearchList");
	    const iterStatusEl = document.getElementById("iterStatus");
    const iterDotEl = document.getElementById("iterDot");
    const iterCountEl = document.getElementById("iterCount");
    const iterLastAtEl = document.getElementById("iterLastAt");
	    const iterTypeEl = document.getElementById("iterType");
	    const iterTitleEl = document.getElementById("iterTitle");
	    const iterSummaryEl = document.getElementById("iterSummary");
	    const addIterBtn = document.getElementById("addIterBtn");
	    const refreshIterBtn = document.getElementById("refreshIterBtn");
	    const iterCalStripEl = document.getElementById("iterCalStrip");
	    const iterCalPrevBtn = document.getElementById("iterCalPrev");
	    const iterCalNextBtn = document.getElementById("iterCalNext");
	    const iterTimelineEl = document.getElementById("iterTimeline");
	    const todoSearchEl = document.getElementById("todoSearch");
	    const densityBtn = document.getElementById("densityBtn");
	    const boardSubtabEls = Array.from(document.querySelectorAll("[data-board-view]"));
	    const tabBtnEls = Array.from(document.querySelectorAll("[data-tab-target]"));
	    const tabPanelEls = Array.from(document.querySelectorAll("[data-tab-panel]"));
	    const pageVersionEl = document.getElementById("pageVersion");
	    const cfgStatusEl = document.getElementById("cfgStatus");
	    const cfgDotEl = document.getElementById("cfgDot");
	    const telemetryEnabledEl = document.getElementById("telemetryEnabled");
	    const telemetryLocalOnlyEl = document.getElementById("telemetryLocalOnly");
	    const telemetryAllowSendEl = document.getElementById("telemetryAllowSend");
	    const telemetryPathEl = document.getElementById("telemetryPath");
	    const telemetryDownloadEl = document.getElementById("telemetryDownload");
	    const telemetryClearBtn = document.getElementById("telemetryClear");
	    const telemetryRefreshBtn = document.getElementById("telemetryRefresh");
	    const telemetryPreviewEl = document.getElementById("telemetryPreview");
    const shortenerPresetEl = document.getElementById("shortenerPreset");
    const shortenerEndpointEl = document.getElementById("shortenerEndpoint");
    const shortenerHeaderNameEl = document.getElementById("shortenerHeaderName");
    const shortenerHeaderTemplateEl = document.getElementById("shortenerHeaderTemplate");
    const shortenerSaveBtn = document.getElementById("shortenerSaveBtn");
    const shortenerMetaEl = document.getElementById("shortenerMeta");
    const ffTabsPaginationEl = document.getElementById("ffTabsPagination");
    const ffTabsGroupingEl = document.getElementById("ffTabsGrouping");
    const ffTabsBadgesEl = document.getElementById("ffTabsBadges");
    const ffTabsSearchEl = document.getElementById("ffTabsSearch");
    const ffTabsThresholdEl = document.getElementById("ffTabsThreshold");
    const ffTabsPageSizeEl = document.getElementById("ffTabsPageSize");
    const ffSaveBtn = document.getElementById("ffSaveBtn");
    const ffResetBtn = document.getElementById("ffResetBtn");
    const ffMetaEl = document.getElementById("ffMeta");
	    const subStatusBadgeEl = document.getElementById("subStatusBadge");
	    const licenseKeyInputEl = document.getElementById("licenseKeyInput");
	    const licenseSaveBtn = document.getElementById("licenseSaveBtn");
	    const licenseClearBtn = document.getElementById("licenseClearBtn");
	    const licenseMetaEl = document.getElementById("licenseMeta");
	    const actStatusBadgeEl = document.getElementById("actStatusBadge");
	    const actModeEl = document.getElementById("actMode");
	    const actServerUrlEl = document.getElementById("actServerUrl");
	    const actDeviceNameEl = document.getElementById("actDeviceName");
	    const actSaveBtn = document.getElementById("actSaveBtn");
	    const actActivateBtn = document.getElementById("actActivateBtn");
	    const actClearBtn = document.getElementById("actClearBtn");
	    const actMetaEl = document.getElementById("actMeta");
	    const svcDotEl = document.getElementById("svcDot");
	    const svcStatusEl = document.getElementById("svcStatus");
	    const svcLastAtEl = document.getElementById("svcLastAt");
	    const svcRefreshBtn = document.getElementById("svcRefreshBtn");
	    const svcScanBtn = document.getElementById("svcScanBtn");
	    const svcScanResultEl = document.getElementById("svcScanResult");
	    const svcAutoEl = document.getElementById("svcAuto");
	    const svcGridEl = document.getElementById("svcGrid");

    let docTimer = null;
    let todoTimer = null;
    let todoIntervalMs = 1500;
    let iterTimer = null;
    let iterTimerSig = "";
		    let svcTimer = null;
    let docRunning = true;
		    let svcRunning = true;
    let activeTabId = "board";
    let currentDocProject = "";
    let lastDocMarkdown = "";
    let lastDocFingerprint = "";
    let iterItemsCache = [];
    let iterProjectForCache = "";
    let lastDocSelection = null;
    let todoVersion = "";
	    let iterVersion = "";
		    let svcVersion = "";
	    let selectedProject = "coach-feishu-suite";
	    let defaultProject = "coach-feishu-suite";
    const PROJECT_FAVORITES_KEY = "pm_project_favorites";
    const PROJECT_SELECTED_KEY = "pm_selected_project";
    const PROJECT_TABS_SCROLL_KEY = "pm_project_tabs_scroll";
    const PROJECT_TABS_PAGE_KEY = "pm_project_tabs_page";
    let projectTabPageThreshold = 80;
    let projectTabPageSize = 40;
    const DEFAULT_FEATURE_FLAGS = {
      projectTabsPagination: true,
      projectTabsGrouping: true,
      projectTabsBadges: true,
      projectTabsSearch: true,
      projectTabsPageThreshold: 80,
      projectTabsPageSize: 40,
    };
    let featureFlags = { ...DEFAULT_FEATURE_FLAGS };
    let featureFlagsHydrated = false;
    let uiPrefsHydrated = false;
    let urlStateHydrated = false;
    let todoLoadFailCount = 0;
    let projectTabsFallbackMode = false;
    let projectPrefsSyncTimer = null;
    let projectSearchItems = [];
    let projectSearchIndex = 0;
    let projectSearchOpen = false;
    let projectSwitchStartTs = 0;
    let projectRenderPerfProbeTs = 0;
    let urlSyncTimer = null;
    let shortenerPreset = "internal_shortener_v1";
    let shortenerEndpoint = "";
    let shortenerHeaderName = "Authorization";
    let shortenerHeaderTemplate = "Bearer {{TOKEN}}";
    let projectTabItems = [];
    let favoriteProjects = new Set();
    let projectTabsPage = 0;
    let projectTabsPageCount = 1;
    let projectTabsRenderSig = "";
    let projectTabsIgnoreScrollSave = false;
    let projectTabsInitialScroll = 0;
    let projectTabsDidRestoreScroll = false;
    let projectTabsScrollSaveTimer = null;
    let hasLocalFavoritePrefs = false;
    let hasLocalProjectSelection = false;
    let hasLocalProjectPage = false;
    let hasLocalProjectScroll = false;
	    let boardView = "execution";
		    let compactDensity = false;
		    let todoSearch = "";
	    let selectedTodoId = "";
	    let cfgVersion = "";
	    // Default to CLI commands for better reliability in restricted localhost environments.
	    let cmdMode = "cli";
	    let cmdMachine = "codex-ttys000";
	    let confirmDoneTaskId = "";

	    // Load command preferences early so card-level "copy command" buttons work
	    // even before opening the command modal.
	    try {
		      const m = String(localStorage.getItem("pm_cmd_mode") || "").trim();
		      if (m) cmdMode = m;
		    } catch (_) {}
	    try {
	      const a = String(localStorage.getItem("pm_cmd_machine") || "").trim();
	      if (a) cmdMachine = a;
	    } catch (_) {}

	    try {
		      const v = new URLSearchParams(location.search || "").get("v");
		      const build = "20260214-2045";
		      if (pageVersionEl && v) pageVersionEl.textContent = `构建: ${build} · 版本: ${v}`;
		      else if (pageVersionEl) pageVersionEl.textContent = `构建: ${build}`;
		    } catch (_) {}
    try {
      const stored = String(localStorage.getItem(PROJECT_SELECTED_KEY) || "").trim();
      if (stored) {
        selectedProject = stored;
        hasLocalProjectSelection = true;
      }
    } catch (_) {}
    try {
      const raw = localStorage.getItem(PROJECT_FAVORITES_KEY) || "[]";
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        favoriteProjects = new Set(parsed.map((x) => String(x || "").trim()).filter(Boolean));
        hasLocalFavoritePrefs = parsed.length > 0;
      }
    } catch (_) {}
    try {
      const page = Number.parseInt(String(localStorage.getItem(PROJECT_TABS_PAGE_KEY) || "0"), 10);
      if (Number.isFinite(page) && page >= 0) {
        projectTabsPage = page;
        hasLocalProjectPage = true;
      }
    } catch (_) {}
    try {
      const scroll = Number.parseFloat(String(localStorage.getItem(PROJECT_TABS_SCROLL_KEY) || "0"));
      if (Number.isFinite(scroll) && scroll >= 0) {
        projectTabsInitialScroll = scroll;
        hasLocalProjectScroll = true;
      }
    } catch (_) {}
    const parseProjectStateFromUrl = () => {
      const q = new URLSearchParams(location.search || "");
      const project = String(q.get("project") || "").trim();
      const pageRaw = q.get("pp");
      const scrollRaw = q.get("ps");
      const state = {
        hasProject: project.length > 0,
        project,
        hasPage: false,
        page: 0,
        hasScroll: false,
        scroll: 0,
      };
      if (pageRaw !== null && pageRaw !== "") {
        const page = Number.parseInt(pageRaw, 10);
        if (Number.isFinite(page) && page >= 0) {
          state.hasPage = true;
          state.page = page;
        }
      }
      if (scrollRaw !== null && scrollRaw !== "") {
        const scroll = Number.parseFloat(scrollRaw);
        if (Number.isFinite(scroll) && scroll >= 0) {
          state.hasScroll = true;
          state.scroll = scroll;
        }
      }
      return state;
    };
    const initialProjectUrlState = parseProjectStateFromUrl();
    if (initialProjectUrlState.hasProject) selectedProject = initialProjectUrlState.project;
    if (initialProjectUrlState.hasPage) projectTabsPage = initialProjectUrlState.page;
    if (initialProjectUrlState.hasScroll) projectTabsInitialScroll = initialProjectUrlState.scroll;
    urlStateHydrated = true;
    const updateProjectStateUrl = () => {
      if (!urlStateHydrated) return;
      if (urlSyncTimer) clearTimeout(urlSyncTimer);
      urlSyncTimer = setTimeout(() => {
        urlSyncTimer = null;
        try {
          const q = new URLSearchParams(location.search || "");
          const project = String(selectedProject || "__all__");
          if (project && project !== "__all__") q.set("project", project);
          else q.delete("project");
          if (projectTabsPage > 0) q.set("pp", String(projectTabsPage));
          else q.delete("pp");
          const scroll = projectTabsEl ? Number(projectTabsEl.scrollLeft || 0) : Number(projectTabsInitialScroll || 0);
          if (scroll > 1) q.set("ps", String(Math.round(scroll)));
          else q.delete("ps");
          const next = `${location.pathname}${q.toString() ? `?${q.toString()}` : ""}${location.hash || ""}`;
          history.replaceState(null, "", next);
        } catch (_) {}
      }, 80);
    };
    const announceProjectA11y = (text) => {
      if (!projectA11yStatusEl) return;
      projectA11yStatusEl.textContent = String(text || "").trim();
    };
    const setProjectNavFallback = (enabled, reason = "") => {
      projectTabsFallbackMode = !!enabled;
      if (projectFilterWrapEl) projectFilterWrapEl.classList.toggle("fallback", !!enabled);
      if (projectFilterEl) {
        projectFilterEl.classList.toggle("fallback-visible", !!enabled);
        projectFilterEl.setAttribute("aria-hidden", enabled ? "false" : "true");
        if (enabled) projectFilterEl.removeAttribute("tabindex");
        else projectFilterEl.setAttribute("tabindex", "-1");
      }
      if (enabled && reason) announceProjectA11y(`已切换到基础项目选择模式：${reason}`);
    };
    const emitUiEvent = (name, props = {}) => {
      const n = String(name || "").trim();
      if (!n) return;
      const payload = {};
      Object.keys(props || {}).forEach((k) => {
        const key = String(k || "").trim();
        if (!key) return;
        const v = props[k];
        if (typeof v === "number" || typeof v === "boolean") payload[key] = v;
        else payload[key] = String(v == null ? "" : v).slice(0, 180);
      });
      fetch("/api/telemetry", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "track_event", source: "web", event: { name: n, props: payload } }),
      }).catch(() => {});
    };
    const scheduleSyncProjectPrefs = () => {
      if (projectPrefsSyncTimer) clearTimeout(projectPrefsSyncTimer);
      projectPrefsSyncTimer = setTimeout(() => {
        projectPrefsSyncTimer = null;
        const prefs = {
          projectFavorites: Array.from(favoriteProjects),
          selectedProject: String(selectedProject || ""),
          projectTabsPage: Math.max(0, Number(projectTabsPage) || 0),
          projectTabsScroll: projectTabsEl ? Number(projectTabsEl.scrollLeft || 0) : Number(projectTabsInitialScroll || 0),
          shortenerPreset: String(shortenerPreset || "internal_shortener_v1"),
          shortenerEndpoint: String(shortenerEndpoint || ""),
          shortenerHeaderName: String(shortenerHeaderName || "Authorization"),
          shortenerHeaderTemplate: String(shortenerHeaderTemplate || "Bearer {{TOKEN}}"),
        };
        fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "set_ui_prefs", prefs }),
        }).catch(() => {});
      }, 260);
    };
    const applyFeatureFlags = (flags) => {
      if (!flags || typeof flags !== "object") return;
      featureFlags = {
        ...featureFlags,
        ...flags,
      };
      featureFlags.projectTabsPagination = featureFlags.projectTabsPagination !== false;
      featureFlags.projectTabsGrouping = featureFlags.projectTabsGrouping !== false;
      featureFlags.projectTabsBadges = featureFlags.projectTabsBadges !== false;
      featureFlags.projectTabsSearch = featureFlags.projectTabsSearch !== false;
      projectTabPageThreshold = Math.max(20, Math.min(1000, Number(featureFlags.projectTabsPageThreshold) || 80));
      projectTabPageSize = Math.max(10, Math.min(200, Number(featureFlags.projectTabsPageSize) || 40));
      if (projectSearchBtn) projectSearchBtn.style.display = featureFlags.projectTabsSearch ? "" : "none";
      if (featureFlags.projectTabsSearch === false && projectSearchOpen) closeProjectSearch();
      featureFlagsHydrated = true;
    };
    const syncFeatureFlagControls = () => {
      if (ffTabsPaginationEl) ffTabsPaginationEl.checked = featureFlags.projectTabsPagination !== false;
      if (ffTabsGroupingEl) ffTabsGroupingEl.checked = featureFlags.projectTabsGrouping !== false;
      if (ffTabsBadgesEl) ffTabsBadgesEl.checked = featureFlags.projectTabsBadges !== false;
      if (ffTabsSearchEl) ffTabsSearchEl.checked = featureFlags.projectTabsSearch !== false;
      if (ffTabsThresholdEl && document.activeElement !== ffTabsThresholdEl) ffTabsThresholdEl.value = String(projectTabPageThreshold);
      if (ffTabsPageSizeEl && document.activeElement !== ffTabsPageSizeEl) ffTabsPageSizeEl.value = String(projectTabPageSize);
      if (ffMetaEl) {
        ffMetaEl.textContent = `状态：pagination=${featureFlags.projectTabsPagination ? "on" : "off"} · grouping=${featureFlags.projectTabsGrouping ? "on" : "off"} · badges=${featureFlags.projectTabsBadges ? "on" : "off"} · search=${featureFlags.projectTabsSearch ? "on" : "off"} · threshold=${projectTabPageThreshold} · pageSize=${projectTabPageSize}`;
      }
    };
    const syncShortenerControls = () => {
      if (shortenerPresetEl && document.activeElement !== shortenerPresetEl) shortenerPresetEl.value = shortenerPreset;
      if (shortenerEndpointEl && document.activeElement !== shortenerEndpointEl) shortenerEndpointEl.value = shortenerEndpoint;
      if (shortenerHeaderNameEl && document.activeElement !== shortenerHeaderNameEl) shortenerHeaderNameEl.value = shortenerHeaderName;
      if (shortenerHeaderTemplateEl && document.activeElement !== shortenerHeaderTemplateEl) shortenerHeaderTemplateEl.value = shortenerHeaderTemplate;
      if (shortenerMetaEl) {
        const endpointLabel = shortenerEndpoint ? shortenerEndpoint : "(未设置 endpoint，复制时仅生成模板)";
        shortenerMetaEl.textContent = `状态：preset=${shortenerPreset} · endpoint=${endpointLabel}`;
      }
    };
    const refreshShortenerPrefsFromInputs = () => {
      const presetRaw = String(shortenerPresetEl && shortenerPresetEl.value || shortenerPreset || "internal_shortener_v1").trim();
      shortenerPreset = ["internal_shortener_v1", "generic"].includes(presetRaw) ? presetRaw : "internal_shortener_v1";
      shortenerEndpoint = String(shortenerEndpointEl && shortenerEndpointEl.value || shortenerEndpoint || "").trim();
      shortenerHeaderName = String(shortenerHeaderNameEl && shortenerHeaderNameEl.value || shortenerHeaderName || "Authorization").trim() || "Authorization";
      shortenerHeaderTemplate = String(shortenerHeaderTemplateEl && shortenerHeaderTemplateEl.value || shortenerHeaderTemplate || "Bearer {{TOKEN}}").trim() || "Bearer {{TOKEN}}";
    };
    const applyUiPrefsOnce = (prefs) => {
      if (!prefs || typeof prefs !== "object" || uiPrefsHydrated) return;
      const fav = Array.isArray(prefs.projectFavorites) ? prefs.projectFavorites : [];
      if (!hasLocalFavoritePrefs && fav.length) favoriteProjects = new Set(fav.map((x) => String(x || "").trim()).filter(Boolean));
      if (!initialProjectUrlState.hasProject && !hasLocalProjectSelection) {
        const sp = String(prefs.selectedProject || "").trim();
        if (sp) selectedProject = sp;
      }
      if (!initialProjectUrlState.hasPage && !hasLocalProjectPage) {
        const p = Number.parseInt(String(prefs.projectTabsPage || "0"), 10);
        if (Number.isFinite(p) && p >= 0) projectTabsPage = p;
      }
      if (!initialProjectUrlState.hasScroll && !hasLocalProjectScroll) {
        const s = Number.parseFloat(String(prefs.projectTabsScroll || "0"));
        if (Number.isFinite(s) && s >= 0) projectTabsInitialScroll = s;
      }
      shortenerPreset = ["internal_shortener_v1", "generic"].includes(String(prefs.shortenerPreset || "")) ? String(prefs.shortenerPreset || "") : shortenerPreset;
      shortenerEndpoint = String(prefs.shortenerEndpoint || shortenerEndpoint || "").trim();
      shortenerHeaderName = String(prefs.shortenerHeaderName || shortenerHeaderName || "Authorization").trim() || "Authorization";
      shortenerHeaderTemplate = String(prefs.shortenerHeaderTemplate || shortenerHeaderTemplate || "Bearer {{TOKEN}}").trim() || "Bearer {{TOKEN}}";
      syncShortenerControls();
      uiPrefsHydrated = true;
    };
    const startProjectPerformanceObserver = () => {
      if (typeof window === "undefined" || typeof PerformanceObserver === "undefined") return;
      try {
        const obs = new PerformanceObserver((list) => {
          const entries = list.getEntries() || [];
          for (const entry of entries) {
            const dur = Number(entry && entry.duration ? entry.duration : 0);
            if (dur < 50) continue;
            emitUiEvent("nav_long_task", { duration: Math.round(dur) });
          }
        });
        obs.observe({ entryTypes: ["longtask"] });
      } catch (_) {}
    };
    const sampleProjectNavFpsIfNeeded = (count) => {
      if (Number(count || 0) < 300) return;
      const now = Date.now();
      if (now - projectRenderPerfProbeTs < 60000) return;
      projectRenderPerfProbeTs = now;
      let frames = 0;
      const begin = performance.now();
      const tick = (ts) => {
        frames += 1;
        if (ts - begin >= 900) {
          const fps = (frames * 1000) / Math.max(1, ts - begin);
          emitUiEvent("nav_fps_probe", { fps: Math.round(fps), projects: Number(count || 0) });
          return;
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    };
    startProjectPerformanceObserver();

    const nowText = () => new Date().toLocaleString("zh-CN", { hour12: false });
    const setDocState = (ok, text) => {
      docStatusEl.textContent = text;
      docDotEl.classList.toggle("warn", !ok);
    };
	    const setTodoState = (ok, text) => {
	      todoStatusEl.textContent = text;
	      todoDotEl.classList.toggle("warn", !ok);
	    };
	    const clearSelectedTodo = () => {
	      selectedTodoId = "";
	      document.querySelectorAll(".todo-item.selected").forEach((x) => x.classList.remove("selected"));
	    };
		    const selectTodoRow = (row) => {
		      if (!row) return;
		      const id = String(row.dataset.id || "").trim();
		      if (!id) return;
		      document.querySelectorAll(".todo-item.selected").forEach((x) => x.classList.remove("selected"));
		      selectedTodoId = id;
		      row.classList.add("selected");
		      if (cmdModalEl && cmdModalEl.classList.contains("show")) renderCmdPanels();
		    };
	    const selectedTodoRow = () => {
	      if (!selectedTodoId) return null;
	      return document.querySelector(`.todo-item[data-id="${selectedTodoId}"]`);
	    };
	    const selectedTodoItem = () => {
	      if (!selectedTodoId) return null;
	      const items = Array.isArray(todoStore.items) ? todoStore.items : [];
	      for (const it of items) {
	        if (String(it && it.id ? it.id : "") === selectedTodoId) return it;
	      }
	      return null;
	    };
	    const allVisibleTodoRows = () => Array.from(document.querySelectorAll("#todoList .todo-item"));
	    const selectNextTodo = (dir) => {
	      const rows = allVisibleTodoRows();
	      if (!rows.length) return;
	      const cur = selectedTodoRow();
	      const idx = cur ? rows.indexOf(cur) : -1;
	      const nextIdx = Math.max(0, Math.min(rows.length - 1, idx + (dir || 1)));
	      selectTodoRow(rows[nextIdx] || rows[0]);
	      (rows[nextIdx] || rows[0]).scrollIntoView({ block: "nearest" });
	    };
	    const setIterState = (ok, text) => {
	      iterStatusEl.textContent = text;
	      iterDotEl.classList.toggle("warn", !ok);
	    };
	    const setCfgState = (ok, text) => {
	      if (cfgStatusEl) cfgStatusEl.textContent = text;
	      if (cfgDotEl) cfgDotEl.classList.toggle("warn", !ok);
	    };
	    const setSvcState = (ok, text) => {
	      if (svcStatusEl) svcStatusEl.textContent = text;
	      if (svcDotEl) svcDotEl.classList.toggle("warn", !ok);
	    };
    const normalizeAgentsFromStore = (store, fallbackAgents) => {
      const out = [];
      const agentsRaw = store && store.agents && typeof store.agents === "object" && !Array.isArray(store.agents) ? store.agents : {};
      const aliases = store && store.agentAliases && typeof store.agentAliases === "object" ? store.agentAliases : {};
      const projectOverrides = store && store.agentProjects && typeof store.agentProjects === "object" ? store.agentProjects : {};
      const ids = new Set([
        ...Object.keys(agentsRaw || {}),
        ...Object.keys(aliases || {}),
        ...Object.keys(projectOverrides || {}),
      ]);
      // 兜底：即使 agents/aliases 丢失，也尽量从任务本身反推出现过的终端 ID。
      const items = store && Array.isArray(store.items) ? store.items : [];
      for (const it of items) {
        const claimedBy = String(it && it.claimedBy ? it.claimedBy : "").trim();
        const machineBy = String(it && it.machineBy ? it.machineBy : "").trim();
        if (claimedBy) ids.add(claimedBy);
        if (machineBy) ids.add(machineBy);
      }
      const nowSec = Math.floor(Date.now() / 1000);
      ids.forEach((id) => {
        const payload = agentsRaw[id] || {};
        const baseTitle = String(payload.title || id || "").trim() || id;
        const alias = String(aliases[id] || "").trim();
        const seenEpoch = Number(payload.lastSeenEpoch || 0);
        out.push({
          agentId: id,
          title: baseTitle,
          alias,
          displayTitle: alias || baseTitle,
          project: String(projectOverrides[id] || payload.project || "").trim() || defaultProject,
          state: String(payload.state || "idle").trim() || "idle",
          taskId: String(payload.taskId || "").trim(),
          cwd: String(payload.cwd || "").trim(),
          note: String(payload.note || "").trim(),
          lastSeenAt: String(payload.lastSeenAt || "").trim(),
          lastSeenEpoch: seenEpoch,
          stale: !seenEpoch || nowSec - seenEpoch > 180,
        });
      });
      out.sort((a, b) => Number(b.lastSeenEpoch || 0) - Number(a.lastSeenEpoch || 0));
      const fallback = Array.isArray(fallbackAgents) ? fallbackAgents : [];
      if (!out.length) return fallback;
      if (!fallback.length) return out;

      // 合并 fallback（例如后端 agents 列表）以避免偶发缺失，且用 fallback 补齐更“新”的 lastSeen 信息。
      const byId = new Map();
      for (const a of out) byId.set(String(a.agentId || "").trim(), a);
      for (const fb of fallback) {
        const id = String((fb && (fb.agentId || fb.id)) || "").trim();
        if (!id) continue;
        const cur = byId.get(id);
        if (!cur) {
          byId.set(id, fb);
          continue;
        }
        const curSeen = Number(cur.lastSeenEpoch || 0);
        const fbSeen = Number(fb.lastSeenEpoch || 0);
        if (fbSeen > curSeen) byId.set(id, { ...cur, ...fb });
      }
      const merged = Array.from(byId.values());
      merged.sort((a, b) => Number(b.lastSeenEpoch || 0) - Number(a.lastSeenEpoch || 0));
      return merged;
    };
    const activeDocProject = () => {
      if (selectedProject && selectedProject !== "__all__") return selectedProject;
      return defaultProject;
    };
    const syncDocProjectLabel = () => {
      docProjectLabelEl.textContent = activeDocProject();
    };
    const syncCurrentProjectLabel = () => {
      currentProjectLabelEl.textContent = `项目: ${selectedProject === "__all__" ? "全部" : selectedProject}`;
      syncDocProjectLabel();
      syncDocHint();
    };
    const syncDocHint = () => {
      if (!docHintEl) return;
      const all = selectedProject === "__all__";
      docHintEl.textContent = all
        ? `提示：如你切到“全部项目”，文档展示默认项目（当前：${activeDocProject()}）。如需查看其它项目文档，请在任务看板切回具体项目。`
        : `提示：文档与更新日志跟随当前项目（${activeDocProject()}）。`;
    };

    const escDoc = (s) =>
      String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    const slugify = (raw) => {
      const s = String(raw || "").trim();
      if (!s) return "sec";
      // Keep ASCII + CJK; fold spaces to '-'
      const cleaned = s
        .toLowerCase()
        .replace(/[^\w\u4e00-\u9fff\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");
      return cleaned || "sec";
    };
    const renderInline = (raw) => {
      const s = String(raw || "");
      let out = escDoc(s);
      // Links: [text](url)
      out = out.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m, text, url) => {
        const t = escDoc(text);
        const u = escDoc(url);
        return `<a href="${u}" target="_blank" rel="noreferrer">${t}</a>`;
      });
      // Inline code
      out = out.replace(/`([^`]+)`/g, (m, code) => `<code>${escDoc(code)}</code>`);
      // Bold then italic
      out = out.replace(/\*\*([^*]+)\*\*/g, (m, x) => `<strong>${x}</strong>`);
      out = out.replace(/\*([^*]+)\*/g, (m, x) => `<em>${x}</em>`);
      // Auto-link bare URLs
      out = out.replace(/(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/g, (m) => {
        const u = escDoc(m);
        return `<a href="${u}" target="_blank" rel="noreferrer">${u}</a>`;
      });
      return out;
    };
    const renderMarkdown = (md) => {
      const lines = String(md || "").replace(/\r\n/g, "\n").split("\n");
      const out = [];
      const toc = [];
      let inCode = false;
      let codeLang = "";
      let codeBuf = [];
      let listBuf = null; // {type:'ul'|'ol', items:[]}
      let quoteBuf = null; // []
      let paraBuf = [];
      const flushPara = () => {
        const text = paraBuf.join("\n").trimEnd();
        paraBuf = [];
        if (!text.trim()) return;
        out.push(`<p>${renderInline(text)}</p>`);
      };
      const flushList = () => {
        if (!listBuf) return;
        const items = listBuf.items.map((x) => `<li>${renderInline(x)}</li>`).join("");
        out.push(listBuf.type === "ol" ? `<ol>${items}</ol>` : `<ul>${items}</ul>`);
        listBuf = null;
      };
      const flushQuote = () => {
        if (!quoteBuf) return;
        const text = quoteBuf.join("\n").trimEnd();
        quoteBuf = null;
        if (!text.trim()) return;
        // Keep internal line breaks for readability
        out.push(`<blockquote>${renderInline(text).replace(/\n/g, "<br/>")}</blockquote>`);
      };
      const pushHeading = (level, text) => {
        const t = String(text || "").trim();
        const base = slugify(t);
        let id = base;
        // Deduplicate ids
        let i = 2;
        while (toc.find((x) => x.id === id)) {
          id = `${base}-${i}`;
          i += 1;
        }
        toc.push({ level, text: t, id });
        out.push(`<h${level} id="${escDoc(id)}">${renderInline(t)}</h${level}>`);
      };
      for (let idx = 0; idx < lines.length; idx += 1) {
        const line = lines[idx];
        const trim = line.trim();
        if (inCode) {
          if (/^```/.test(trim)) {
            const code = codeBuf.join("\n");
            out.push(`<pre><code class="lang-${escDoc(codeLang || "")}">${escDoc(code)}</code></pre>`);
            inCode = false;
            codeLang = "";
            codeBuf = [];
          } else {
            codeBuf.push(line);
          }
          continue;
        }

        if (/^```/.test(trim)) {
          flushPara();
          flushList();
          flushQuote();
          inCode = true;
          codeLang = trim.replace(/^```/, "").trim();
          codeBuf = [];
          continue;
        }

        const h = trim.match(/^(#{1,4})\s+(.+)$/);
        if (h) {
          flushPara();
          flushList();
          flushQuote();
          const level = Math.min(4, h[1].length);
          pushHeading(level, h[2]);
          continue;
        }

        if (/^---+$/.test(trim)) {
          flushPara();
          flushList();
          flushQuote();
          out.push("<hr/>");
          continue;
        }

        const q = line.match(/^\s*>\s?(.*)$/);
        if (q) {
          flushPara();
          flushList();
          if (!quoteBuf) quoteBuf = [];
          quoteBuf.push(q[1] || "");
          continue;
        } else {
          flushQuote();
        }

        const ul = line.match(/^\s*[-*+]\s+(.+)$/);
        const ol = line.match(/^\s*\d+\.\s+(.+)$/);
        if (ul || ol) {
          flushPara();
          flushQuote();
          const type = ul ? "ul" : "ol";
          const itemText = (ul ? ul[1] : ol[1]) || "";
          if (!listBuf || listBuf.type !== type) listBuf = { type, items: [] };
          listBuf.items.push(itemText);
          continue;
        } else {
          flushList();
        }

        if (!trim) {
          flushPara();
          flushList();
          flushQuote();
          continue;
        }

        paraBuf.push(line);
      }
      flushPara();
      flushList();
      flushQuote();
      if (inCode) {
        out.push(`<pre><code class="lang-${escDoc(codeLang || "")}">${escDoc(codeBuf.join("\n"))}</code></pre>`);
      }
      return { html: out.join("\n"), toc };
    };
    const scrollDocTo = (targetId) => {
      if (!targetId || !docRenderEl) return;
      const docScrollEl = docRenderEl.closest(".doc-scroll");
      const escId = (typeof CSS !== "undefined" && CSS && typeof CSS.escape === "function") ? CSS.escape(targetId) : targetId;
      const el = docRenderEl.querySelector(`#${escId}`);
      if (!el) return;
      if (!docScrollEl) {
        el.scrollIntoView({ behavior: "smooth", block: "start" });
        return;
      }
      const top = el.getBoundingClientRect().top - docScrollEl.getBoundingClientRect().top + docScrollEl.scrollTop;
      docScrollEl.scrollTo({ top: Math.max(0, top - 10), behavior: "smooth" });
    };
    const renderDocToc = (toc) => {
      if (!docTocEl) return;
      const list = Array.isArray(toc) ? toc.filter((x) => x && x.level >= 2 && x.level <= 4) : [];
      if (!list.length) {
        docTocEl.hidden = true;
        docTocEl.innerHTML = "";
        if (docTocSideEl) docTocSideEl.style.display = "none";
        return;
      }
      if (docTocSideEl) docTocSideEl.style.display = "";
      docTocEl.hidden = false;
      const links = list
        .map((x) => {
          const lvl = x.level === 3 ? " l3" : x.level === 4 ? " l4" : "";
          return `<a class="toc-link${lvl}" data-doc-anchor="${escDoc(x.id)}" href="javascript:void(0)">${escDoc(x.text)}</a>`;
        })
        .join("");
      docTocEl.innerHTML = links;
      docTocEl.querySelectorAll("[data-doc-anchor]").forEach((a) => {
        a.addEventListener("click", () => {
          const id = a.getAttribute("data-doc-anchor");
          if (id) scrollDocTo(id);
        });
      });
    };
    const renderDocVisual = (markdown) => {
      if (!docRenderEl) return;
      const md = String(markdown || "");
      const rendered = renderMarkdown(md);
      docRenderEl.innerHTML = rendered.html || `<div class="empty-line">（空文档）</div>`;
      renderDocToc(rendered.toc || []);
    };

	    const setTocCollapsed = (collapsed) => {
	      const on = !!collapsed;
	      document.body.classList.toggle("toc-collapsed", on);
	      if (docTocToggleBtn) docTocToggleBtn.textContent = on ? "展开" : "折叠";
	      if (docTocToggleBtnMain) docTocToggleBtnMain.textContent = on ? "展开目录" : "折叠目录";
	      // Guard: if TOC was previously hidden with inline style, expanding should restore it when toc exists.
	      if (!on && docTocEl && docTocSideEl) {
	        const has = String(docTocEl.innerHTML || "").trim().length > 0 && !docTocEl.hidden;
	        if (has) docTocSideEl.style.display = "";
	      }
	      try { localStorage.setItem("pm_doc_toc_collapsed", on ? "1" : "0"); } catch (_) {}
	    };

    const productTypeLabel = (raw) => {
      const k = String(raw || "manual").toLowerCase();
      if (k === "fix") return "稳定性修复";
      if (k === "optimize") return "体验优化";
      if (k === "architecture") return "架构演进";
      if (k === "milestone") return "阶段交付";
      if (k === "done") return "交付完成";
      if (k === "rollback") return "回退处理";
      return "更新记录";
    };
    const productValueHint = (raw) => {
      const k = String(raw || "manual").toLowerCase();
      if (k === "fix") return "减少异常与卡点，让流程更可靠。";
      if (k === "optimize") return "更省步骤、更顺手、更快完成关键操作。";
      if (k === "architecture") return "后续迭代更快、维护成本更低、可扩展性更强。";
      if (k === "milestone") return "关键能力可用，形成可交付阶段。";
      if (k === "done") return "一项任务正式交付并纳入版本轨迹。";
      if (k === "rollback") return "恢复到可用状态，避免问题扩大。";
      return "记录一次变更，便于回溯。";
    };
    const splitHighlights = (text, limit = 3) => {
      const raw = String(text || "").replace(/\s+/g, " ").trim();
      if (!raw) return [];
      const parts = raw.split(/[\n。；;]+/g).map((x) => x.trim()).filter(Boolean);
      const out = [];
      for (const p of parts) {
        if (out.length >= limit) break;
        if (p.length < 2) continue;
        out.push(p);
      }
      return out;
    };
    const extractChips = (it) => {
      const text = [it && it.title, it && it.summary].map((x) => String(x || "")).join(" ");
      const chips = [];
      const urls = text.match(/https?:\/\/[^\s)]+/g) || [];
      for (const u of urls.slice(0, 3)) chips.push({ kind: "url", label: "入口", value: u });
      // Heuristic: /api/* -> link to localhost origin
      const apis = text.match(/(\/api\/[A-Za-z0-9_\-./:]+)/g) || [];
      for (const p of apis.slice(0, 3)) chips.push({ kind: "api", label: "API", value: `${location.origin}${p}` });
      return chips;
    };
    const renderDocChangelog = (items, project) => {
      const list = Array.isArray(items) ? items.slice() : [];
      const p = String(project || activeDocProject());
      if (docLatestIterEl) {
        if (!list.length) {
          docLatestIterEl.innerHTML = `<div class="doc-latest-title">暂无版本日志</div><div class="doc-latest-desc">你可以在“日程日志”里点“记录迭代”，或在任务完成/回滚时由机器自动写入。</div>`;
        } else {
          const x = list[0];
          const title = String(x.title || "(未命名迭代)").trim();
          const vtag = String(x.versionTag || "-").trim();
          const type = productTypeLabel(x.type);
          const createdAt = String(x.createdAt || "").trim();
          const value = productValueHint(x.type);
          const highlights = splitHighlights(x.summary || "", 3);
          const chips = extractChips(x);
          docLatestIterEl.innerHTML = `
            <div class="chg-head">
              <span class="badge project">${escDoc(vtag)}</span>
              <span class="badge">${escDoc(type)}</span>
              <span class="badge">${escDoc(createdAt.slice(0, 19) || "-")}</span>
              <span class="badge project">${escDoc(p)}</span>
            </div>
            <div class="doc-latest-title">${escDoc(title)}</div>
            <div class="doc-latest-desc"><strong>用户价值：</strong>${escDoc(value)}</div>
            ${highlights.length ? `<div class="doc-latest-desc"><strong>说明：</strong>${escDoc(highlights.join(" / "))}</div>` : ""}
            ${chips.length ? `<div class="chg-kv">${chips.map((c) => `<a class="chg-chip" href="${escDoc(c.value)}" target="_blank" rel="noreferrer">${escDoc(c.label)} · ${escDoc(c.value.replace(location.origin, ""))}</a>`).join("")}</div>` : ""}
          `;
        }
      }

      if (!docChangelogEl) return;
      if (!list.length) {
        docChangelogEl.innerHTML = `<div class="empty-line">暂无更新日志</div>`;
        return;
      }
      const rows = list.slice(0, 24).map((x) => {
        const title = String(x.title || "(未命名迭代)").trim();
        const vtag = String(x.versionTag || "-").trim();
        const type = productTypeLabel(x.type);
        const createdAt = String(x.createdAt || "").trim();
        const value = productValueHint(x.type);
        const highlights = splitHighlights(x.summary || "", 2);
        const chips = extractChips(x);
        const kv = [];
        if (x.taskId) kv.push(`任务:${String(x.taskId)}`);
        if (x.machineBy) kv.push(`机器:${String(x.machineBy)}`);
        if (x.source) kv.push(`来源:${String(x.source)}`);
        return `
          <div class="chg-item">
            <div class="chg-head">
              <span class="badge project">${escDoc(vtag)}</span>
              <span class="badge">${escDoc(type)}</span>
              <span class="badge">${escDoc(createdAt.slice(0, 19) || "-")}</span>
            </div>
            <div class="chg-title">${escDoc(title)}</div>
            <div class="chg-desc"><strong>用户价值：</strong>${escDoc(value)}</div>
            ${highlights.length ? `<div class="chg-desc">${escDoc(highlights.join(" / "))}</div>` : ""}
            ${kv.length ? `<div class="chg-kv">${kv.map((t) => `<span class="chg-chip muted">${escDoc(t)}</span>`).join("")}</div>` : ""}
            ${chips.length ? `<div class="chg-kv">${chips.map((c) => `<a class="chg-chip" href="${escDoc(c.value)}" target="_blank" rel="noreferrer">${escDoc(c.label)}</a>`).join("")}</div>` : ""}
          </div>
        `;
      });
      docChangelogEl.innerHTML = rows.join("");
    };

    const activateTab = (tabId) => {
      const next = String(tabId || "board").trim() || "board";
      tabBtnEls.forEach((el) => el.classList.toggle("active", el.getAttribute("data-tab-target") === next));
      tabPanelEls.forEach((el) => el.classList.toggle("active", el.getAttribute("data-tab-panel") === next));
      try { localStorage.setItem("pm_active_tab", next); } catch (_) {}
      activeTabId = next;
      if (next !== "doc") {
        hideSelBubble();
        closeSuggestModal();
      }
    };
    const activateBoardView = (viewId) => {
      const next = String(viewId || "execution").trim() || "execution";
      boardView = next;
      boardSubtabEls.forEach((el) => el.classList.toggle("active", el.getAttribute("data-board-view") === next));
      try { localStorage.setItem("pm_board_view", next); } catch (_) {}
      renderTodos(todoStore);
    };
    const setDensity = (compact) => {
      compactDensity = !!compact;
      document.body.classList.toggle("density-compact", compactDensity);
      densityBtn.classList.toggle("active", compactDensity);
      densityBtn.textContent = compactDensity ? "标准" : "紧凑";
      try { localStorage.setItem("pm_board_density", compactDensity ? "compact" : "normal"); } catch (_) {}
      renderTodos(todoStore);
    };
    const setSearch = (text) => {
      todoSearch = String(text || "").trim();
      try { localStorage.setItem("pm_todo_search", todoSearch); } catch (_) {}
      renderTodos(todoStore);
    };

    const loadDoc = async () => {
      try {
        const project = activeDocProject();
        const res = await fetch(`/api/project-doc?project=${encodeURIComponent(project)}&t=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json();
        if (!payload.ok) throw new Error(payload.error || "读取文档失败");
        const data = payload.data || {};
        const txt = String(data.content || "");
        const docProject = String(data.project || project || defaultProject);
        const docFinger = `${docProject}:${txt}`;
        if (docFinger !== lastDocFingerprint) {
          lastDocFingerprint = docFinger;
          lastDocMarkdown = txt;
          currentDocProject = docProject;
          docProjectLabelEl.textContent = docProject;
          renderDocVisual(txt);
          lastDocAtEl.textContent = nowText();
          setDocState(true, "已同步");
          // Project switch should refresh changelog immediately.
          await ensureDocChangelogForProject(docProject, true);
          renderSuggestions();
        } else {
          currentDocProject = docProject;
          docProjectLabelEl.textContent = docProject;
          setDocState(true, "监听中");
        }
      } catch (e) {
        setDocState(false, `读取失败: ${e && e.message ? e.message : "unknown"}`);
      }
    };

    const ensureDocTimer = (shouldRun) => {
      const run = !!shouldRun;
      if (run) {
        if (docTimer) return;
        docTimer = setInterval(loadDoc, 1000);
        loadDoc();
        ensureDocChangelogForProject(activeDocProject(), true);
        renderSuggestions();
        return;
      }
      if (docTimer) clearInterval(docTimer);
      docTimer = null;
      hideSelBubble();
      closeSuggestModal();
      setDocState(true, "已暂停");
    };
    const startDoc = () => {
      docRunning = true;
      toggleDocBtn.textContent = "暂停轮询";
      ensureDocTimer(true);
    };
    const stopDoc = () => {
      docRunning = false;
      toggleDocBtn.textContent = "继续轮询";
      ensureDocTimer(false);
    };

    // Suggestions (local-only): selection -> suggestion -> todo
    const suggestKey = (project) => `pm_doc_suggestions_${String(project || "").trim() || defaultProject}`;
    const loadSuggestions = () => {
      const p = activeDocProject();
      try {
        const raw = localStorage.getItem(suggestKey(p));
        const data = raw ? JSON.parse(raw) : [];
        return Array.isArray(data) ? data : [];
      } catch (_) {
        return [];
      }
    };
    const saveSuggestions = (items) => {
      const p = activeDocProject();
      try {
        localStorage.setItem(suggestKey(p), JSON.stringify(Array.isArray(items) ? items : []));
      } catch (_) {}
    };
    const SEL_BUBBLE_POS_KEY = "pm_sel_bubble_pos_v1";
    let selBubblePinnedPos = null;
    let selBubbleDragging = false;
    const loadSelBubblePos = () => {
      try {
        const raw = localStorage.getItem(SEL_BUBBLE_POS_KEY) || "";
        if (!raw) return null;
        const obj = JSON.parse(raw);
        const left = Number(obj && obj.left);
        const top = Number(obj && obj.top);
        if (!Number.isFinite(left) || !Number.isFinite(top)) return null;
        return { left, top };
      } catch (_) {
        return null;
      }
    };
    const saveSelBubblePos = (pos) => {
      try {
        if (!pos) return;
        localStorage.setItem(SEL_BUBBLE_POS_KEY, JSON.stringify({ left: Math.round(pos.left), top: Math.round(pos.top) }));
      } catch (_) {}
    };
    const clearSelBubblePos = () => {
      try { localStorage.removeItem(SEL_BUBBLE_POS_KEY); } catch (_) {}
    };
    const firstLine = (s, maxLen = 90) => {
      const t = String(s || "").replace(/\s+/g, " ").trim();
      if (!t) return "";
      return t.length > maxLen ? t.slice(0, maxLen) + "…" : t;
    };
    const findHeadingContext = (node) => {
      try {
        const el = node && node.nodeType === 1 ? node : (node && node.parentElement ? node.parentElement : null);
        if (!el) return { id: "", title: "" };
        const h = el.closest ? el.closest("h2,h3,h4") : null;
        if (h && h.id) return { id: String(h.id), title: String(h.textContent || "").trim() };
        // fallback: find nearest previous heading within docRender
        if (docRenderEl) {
          const headings = Array.from(docRenderEl.querySelectorAll("h2[id],h3[id],h4[id]"));
          const rect = el.getBoundingClientRect();
          let best = null;
          for (const hh of headings) {
            const r = hh.getBoundingClientRect();
            if (r.top <= rect.top + 4) best = hh;
          }
          if (best && best.id) return { id: String(best.id), title: String(best.textContent || "").trim() };
        }
      } catch (_) {}
      return { id: "", title: "" };
    };
    const isSelectionInDoc = (sel) => {
      try {
        if (!sel || !sel.rangeCount || !docRenderEl) return false;
        const a = sel.anchorNode;
        const f = sel.focusNode;
        if (!a || !f) return false;
        return docRenderEl.contains(a) && docRenderEl.contains(f);
      } catch (_) {
        return false;
      }
    };
    const hideSelBubble = () => {
      if (!selBubbleEl) return;
      selBubbleEl.hidden = true;
      selBubbleEl.style.left = "0px";
      selBubbleEl.style.top = "0px";
    };
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const showSelBubble = (rect) => {
      if (!selBubbleEl) return;
      selBubbleEl.hidden = false;
      const w = selBubbleEl.offsetWidth || 220;
      const h = selBubbleEl.offsetHeight || 38;
      let left = 0;
      let top = 0;
      if (selBubblePinnedPos && Number.isFinite(selBubblePinnedPos.left) && Number.isFinite(selBubblePinnedPos.top)) {
        left = selBubblePinnedPos.left;
        top = selBubblePinnedPos.top;
      } else {
        left = rect.left + rect.width / 2 - w / 2;
        top = rect.top - h - 10;
        if (top < 10) top = rect.bottom + 10;
      }
      left = clamp(left, 10, window.innerWidth - w - 10);
      top = clamp(top, 10, window.innerHeight - h - 10);
      selBubbleEl.style.left = `${Math.round(left)}px`;
      selBubbleEl.style.top = `${Math.round(top)}px`;
    };
    const captureSelection = () => {
      const sel = window.getSelection ? window.getSelection() : null;
      if (!sel || !sel.toString) return null;
      const txt = String(sel.toString() || "").trim();
      if (!txt || txt.length < 2) return null;
      if (!isSelectionInDoc(sel)) return null;
      let rect = null;
      try {
        const r = sel.getRangeAt(0);
        rect = r.getBoundingClientRect();
        if (rect && rect.width === 0 && rect.height === 0) rect = null;
      } catch (_) {}
      const ctx = findHeadingContext(sel.anchorNode);
      return {
        text: txt.length > 600 ? (txt.slice(0, 600) + "…") : txt,
        headingId: ctx.id || "",
        headingTitle: ctx.title || "",
        rect,
      };
    };
    const buildTodoFromSuggestion = (q, s, ctx) => {
      const quote = firstLine(q, 120);
      const sug = String(s || "").replace(/\s+/g, " ").trim();
      const parts = [];
      parts.push(`【文档建议】${quote}`);
      if (ctx && ctx.headingTitle) parts.push(`（章节：${firstLine(ctx.headingTitle, 64)}）`);
      if (ctx && ctx.headingId) parts.push(`入口：${location.origin}/pm#${ctx.headingId}`);
      if (sug) parts.push(`建议：${sug}`);
      return parts.join(" ");
    };
    const openSuggestModal = (payload) => {
      if (!suggestModalEl) return;
      const p = payload || lastDocSelection || captureSelection();
      if (!p) return;
      lastDocSelection = p;
      if (suggestQuoteEl) suggestQuoteEl.textContent = p.text || "";
      if (suggestTextEl) suggestTextEl.value = "";
      const todo = buildTodoFromSuggestion(p.text || "", "", p);
      if (suggestTodoTextEl) suggestTodoTextEl.value = todo;
      if (suggestPriorityEl) suggestPriorityEl.value = "P1";
      // sync projects list from existing selector
      if (suggestProjectEl) {
        suggestProjectEl.innerHTML = newTodoProjectEl ? newTodoProjectEl.innerHTML : "";
        const proj = activeDocProject();
        suggestProjectEl.value = proj;
      }
      suggestModalEl.classList.add("show");
      suggestModalEl.setAttribute("aria-hidden", "false");
      setTimeout(() => (suggestTextEl ? suggestTextEl.focus() : null), 0);
    };
    const closeSuggestModal = () => {
      if (!suggestModalEl) return;
      suggestModalEl.classList.remove("show");
      suggestModalEl.setAttribute("aria-hidden", "true");
    };
    const renderSuggestions = () => {
      if (!suggestListEl) return;
      const items = loadSuggestions().slice().sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));
      if (!items.length) {
        suggestListEl.innerHTML = `<div class="empty-line">暂无建议（在正文中圈选文字即可添加）</div>`;
        return;
      }
      const rows = items.slice(0, 12).map((x) => {
        const id = escDoc(String(x.id || ""));
        const q = escDoc(firstLine(x.quote || "", 110) || "(无引用)");
        const s = escDoc(firstLine(x.suggestion || "", 140));
        const hId = String(x.headingId || "").trim();
        const hTitle = String(x.headingTitle || "").trim();
        const chips = [];
        if (hTitle) chips.push(`<span class="chg-chip muted">章节 · ${escDoc(firstLine(hTitle, 40))}</span>`);
        if (hId) chips.push(`<a class="chg-chip" href="javascript:void(0)" data-suggest-jump="${escDoc(hId)}">跳转</a>`);
        return `
          <div class="suggest-item" data-suggest-id="${id}">
            <div class="q">${q}</div>
            ${s ? `<div class="s">${s}</div>` : ""}
            <div class="suggest-actions">
              <button class="status-btn" type="button" data-suggest-act="make_todo">生成Todo</button>
              <button class="status-btn" type="button" data-suggest-act="copy">复制</button>
              <button class="status-btn btn-danger" type="button" data-suggest-act="delete">删除</button>
              ${chips.join("")}
            </div>
          </div>
        `;
      });
      suggestListEl.innerHTML = rows.join("");
      suggestListEl.querySelectorAll("[data-suggest-jump]").forEach((a) => {
        a.addEventListener("click", () => {
          const id = a.getAttribute("data-suggest-jump") || "";
          if (id) scrollDocTo(id);
        });
      });
      suggestListEl.querySelectorAll("[data-suggest-act]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const wrap = btn.closest("[data-suggest-id]");
          if (!wrap) return;
          const sid = String(wrap.getAttribute("data-suggest-id") || "").trim();
          const act = String(btn.getAttribute("data-suggest-act") || "").trim();
          const all = loadSuggestions();
          const item = all.find((z) => String(z.id || "") === sid);
          if (!item) return;
          if (act === "copy") {
            await copyText(String(item.todoText || item.suggestion || item.quote || ""));
            setDocState(true, "已复制");
            return;
          }
          if (act === "delete") {
            if (!window.confirm("确认删除该建议？")) return;
            saveSuggestions(all.filter((z) => String(z.id || "") !== sid));
            renderSuggestions();
            return;
          }
          if (act === "make_todo") {
            openSuggestModal({
              text: String(item.quote || ""),
              headingId: String(item.headingId || ""),
              headingTitle: String(item.headingTitle || ""),
              rect: null,
            });
            if (suggestTextEl) suggestTextEl.value = String(item.suggestion || "");
            if (suggestTodoTextEl) suggestTodoTextEl.value = String(item.todoText || buildTodoFromSuggestion(item.quote || "", item.suggestion || "", item));
          }
        });
      });
    };

    const apiPost = async (payload) => {
      const res = await fetch("/api/todos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const raw = await res.json().catch(() => ({}));
      if (!res.ok || !raw.ok) throw new Error(raw.error || `HTTP ${res.status}`);
      const store = raw.data || { items: [] };
      if (Array.isArray(raw.projects)) store.projectCatalog = raw.projects;
      if (raw.defaultProject) store.defaultProject = raw.defaultProject;
      if (raw.iterLatestByProject && typeof raw.iterLatestByProject === "object") store.iterLatestByProject = raw.iterLatestByProject;
      if (raw.iterUpdatedAt) store.iterUpdatedAt = String(raw.iterUpdatedAt || "");
      if (raw.uiPrefs && typeof raw.uiPrefs === "object") store.uiPrefs = raw.uiPrefs;
      if (raw.featureFlags && typeof raw.featureFlags === "object") store.featureFlags = raw.featureFlags;
      const payloadAgents = Array.isArray(raw.agents) ? raw.agents : [];
      store.agents = normalizeAgentsFromStore(store, payloadAgents);
      return store;
    };

	    const loadConfig = async () => {
	      try {
	        const res = await fetch(`/api/config?t=${Date.now()}`, { cache: "no-store" });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        const cfg = payload.data || {};
        applyFeatureFlags(cfg.featureFlags && typeof cfg.featureFlags === "object" ? cfg.featureFlags : null);
        applyUiPrefsOnce(cfg.uiPrefs && typeof cfg.uiPrefs === "object" ? cfg.uiPrefs : null);
        syncFeatureFlagControls();
        syncShortenerControls();
	        const ver = String(cfg.updatedAt || "");
	        if (ver && ver === cfgVersion) {
	          setCfgState(true, "监听中");
	          return cfg;
	        }
	        cfgVersion = ver;
	        const tel = cfg.telemetry || {};
	        if (telemetryEnabledEl) telemetryEnabledEl.checked = !!tel.enabled;
	        if (telemetryLocalOnlyEl) telemetryLocalOnlyEl.checked = tel.localOnly !== false;
	        if (telemetryAllowSendEl) telemetryAllowSendEl.checked = !!tel.allowSend;
	        if (telemetryPathEl) telemetryPathEl.textContent = "docs/telemetry-events.jsonl";
	        if (telemetryDownloadEl) telemetryDownloadEl.href = "/telemetry-events.jsonl";
	        const sub = cfg.subscription || {};
	        const subStatus = String(sub.status || "inactive");
	        const subTier = String(sub.tier || "free");
	        const subSubject = String(sub.subject || "");
	        const subExp = String(sub.expiresAt || "");
	        const subLicId = String(sub.licenseId || "");
	        const subMaxDevices = Number.isFinite(Number(sub.maxDevices)) ? Number(sub.maxDevices) : 1;
	        const act = sub.activation || {};
	        const actMode = String(act.mode || "offline");
	        const actServerUrl = String(act.serverUrl || "");
	        const actCloudStatus = String(act.cloudStatus || "inactive");
	        const actCloudError = String(act.cloudError || "");
	        const actToken = String(act.activationToken || "");
	        const actDeviceId = String(act.deviceId || "");
	        const actDeviceName = String(act.deviceName || "");
	        const actActivatedAt = String(act.activatedAt || "");
	        const actCheckedAt = String(act.checkedAt || "");
	        const effectiveStatus = actMode === "cloud" && actCloudStatus && actCloudStatus !== "inactive" ? actCloudStatus : subStatus;
	        if (licenseKeyInputEl && document.activeElement !== licenseKeyInputEl) licenseKeyInputEl.value = String(sub.licenseKey || "");
	        if (subStatusBadgeEl) {
	          const cls = ["active", "expired", "invalid", "unverified", "inactive", "revoked", "limit_reached", "error"].includes(effectiveStatus)
	            ? effectiveStatus
	            : "inactive";
	          subStatusBadgeEl.textContent = effectiveStatus;
	          subStatusBadgeEl.className = `badge sub ${cls}`;
	        }
	        if (actModeEl && document.activeElement !== actModeEl) actModeEl.value = actMode === "cloud" ? "cloud" : "offline";
	        if (actServerUrlEl && document.activeElement !== actServerUrlEl) actServerUrlEl.value = actServerUrl;
	        if (actDeviceNameEl && document.activeElement !== actDeviceNameEl) actDeviceNameEl.value = actDeviceName;
	        if (actStatusBadgeEl) {
	          const cls = ["active", "revoked", "limit_reached", "invalid", "error", "inactive", "expired", "unverified"].includes(actCloudStatus)
	            ? actCloudStatus
	            : "inactive";
	          actStatusBadgeEl.textContent = actCloudStatus || "inactive";
	          actStatusBadgeEl.className = `badge sub ${cls}`;
	        }
	        if (licenseMetaEl) {
	          const parts = [];
	          parts.push(`状态：${subStatus}（${subTier}）`);
	          if (subSubject) parts.push(`主体：${subSubject}`);
	          if (subExp) parts.push(`到期：${subExp}`);
	          if (subLicId) parts.push(`LicenseId：${subLicId}`);
	          if (subMaxDevices) parts.push(`设备上限：${subMaxDevices}`);
	          if (sub.checkedAt) parts.push(`检查：${sub.checkedAt}`);
	          if (sub.lastError) parts.push(`错误：${sub.lastError}`);
	          licenseMetaEl.textContent = parts.join(" · ");
	        }
	        if (actMetaEl) {
	          const parts = [];
	          parts.push(`云端状态：${actCloudStatus || "inactive"}（mode=${actMode || "offline"}）`);
	          if (actServerUrl) parts.push(`server：${actServerUrl}`);
	          if (actDeviceId) parts.push(`deviceId：${actDeviceId}`);
	          if (actToken) parts.push(`token：${actToken.slice(0, 12)}…${actToken.slice(-8)}`);
	          if (actActivatedAt) parts.push(`激活：${actActivatedAt}`);
	          if (actCheckedAt) parts.push(`检查：${actCheckedAt}`);
	          if (actCloudError) parts.push(`错误：${actCloudError}`);
	          actMetaEl.textContent = parts.join(" · ");
	        }
	        setCfgState(true, "已同步");
	        return cfg;
	      } catch (e) {
	        setCfgState(false, `读取失败: ${e.message || e}`);
	        return null;
	      }
	    };

	    const saveTelemetryConfig = async () => {
	      try {
	        const enabled = !!(telemetryEnabledEl && telemetryEnabledEl.checked);
	        const localOnly = !!(telemetryLocalOnlyEl && telemetryLocalOnlyEl.checked);
	        const res = await fetch("/api/config", {
	          method: "POST",
	          headers: { "Content-Type": "application/json" },
	          body: JSON.stringify({ action: "set_telemetry", enabled, localOnly, allowSend: false, endpoint: "" }),
	        });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        setCfgState(true, "已保存");
	        await loadTelemetryPreview();
	      } catch (e) {
	        setCfgState(false, `保存失败: ${e.message || e}`);
	      }
	    };
    const saveFeatureFlagsConfig = async (reset = false) => {
      try {
        const flags = reset
          ? { ...DEFAULT_FEATURE_FLAGS }
          : {
              projectTabsPagination: !!(ffTabsPaginationEl && ffTabsPaginationEl.checked),
              projectTabsGrouping: !!(ffTabsGroupingEl && ffTabsGroupingEl.checked),
              projectTabsBadges: !!(ffTabsBadgesEl && ffTabsBadgesEl.checked),
              projectTabsSearch: !!(ffTabsSearchEl && ffTabsSearchEl.checked),
              projectTabsPageThreshold: Number.parseInt(String(ffTabsThresholdEl && ffTabsThresholdEl.value || "80"), 10),
              projectTabsPageSize: Number.parseInt(String(ffTabsPageSizeEl && ffTabsPageSizeEl.value || "40"), 10),
            };
        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "set_feature_flags", flags }),
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
        const cfg = payload.data || {};
        applyFeatureFlags(cfg.featureFlags && typeof cfg.featureFlags === "object" ? cfg.featureFlags : flags);
        syncFeatureFlagControls();
        projectTabsRenderSig = "";
        syncProjectSelectors(todoStore || { items: [] });
        setCfgState(true, "Feature Flags 已保存");
      } catch (e) {
        setCfgState(false, `Feature Flags 保存失败: ${e.message || e}`);
      }
    };
    const saveShortenerConfig = async () => {
      try {
        refreshShortenerPrefsFromInputs();
        const prefs = {
          shortenerPreset,
          shortenerEndpoint,
          shortenerHeaderName,
          shortenerHeaderTemplate,
        };
        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "set_ui_prefs", prefs }),
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
        const cfg = payload.data || {};
        uiPrefsHydrated = false;
        applyUiPrefsOnce(cfg.uiPrefs && typeof cfg.uiPrefs === "object" ? cfg.uiPrefs : prefs);
        syncShortenerControls();
        setCfgState(true, "短链配置已保存");
      } catch (e) {
        setCfgState(false, `短链配置保存失败: ${e.message || e}`);
      }
    };

	    const saveSubscriptionConfig = async (licenseKey) => {
	      try {
	        const res = await fetch("/api/config", {
	          method: "POST",
	          headers: { "Content-Type": "application/json" },
	          body: JSON.stringify({ action: "set_subscription", licenseKey: String(licenseKey || "") }),
	        });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        const result = payload.result || {};
	        const st = String(result.status || "");
	        if (st === "active") setCfgState(true, "License 已激活");
	        else if (st === "expired") setCfgState(false, "License 已过期");
	        else if (st === "unverified") setCfgState(false, "未配置公钥，无法验签");
	        else if (st === "inactive") setCfgState(true, "已清除 License");
	        else setCfgState(false, "License 无效");
	        await loadConfig();
	      } catch (e) {
	        setCfgState(false, `保存失败: ${e.message || e}`);
	      }
	    };

	    const saveActivationConfig = async () => {
	      try {
	        const mode = actModeEl ? String(actModeEl.value || "offline") : "offline";
	        const serverUrl = actServerUrlEl ? String(actServerUrlEl.value || "") : "";
	        const deviceName = actDeviceNameEl ? String(actDeviceNameEl.value || "") : "";
	        const res = await fetch("/api/config", {
	          method: "POST",
	          headers: { "Content-Type": "application/json" },
	          body: JSON.stringify({ action: "set_activation", mode, serverUrl, deviceName }),
	        });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        setCfgState(true, "已保存激活设置");
	        await loadConfig();
	      } catch (e) {
	        setCfgState(false, `保存失败: ${e.message || e}`);
	      }
	    };

	    const clearActivation = async () => {
	      try {
	        const res = await fetch("/api/config", {
	          method: "POST",
	          headers: { "Content-Type": "application/json" },
	          body: JSON.stringify({ action: "clear_activation" }),
	        });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        setCfgState(true, "已清除激活");
	        await loadConfig();
	      } catch (e) {
	        setCfgState(false, `清除失败: ${e.message || e}`);
	      }
	    };

	    const activateSubscription = async () => {
	      try {
	        const serverUrl = actServerUrlEl ? String(actServerUrlEl.value || "") : "";
	        const deviceName = actDeviceNameEl ? String(actDeviceNameEl.value || "") : "";
	        const licenseKey = licenseKeyInputEl ? String(licenseKeyInputEl.value || "") : "";
	        if (!serverUrl.trim()) throw new Error("请先填写激活服务地址");
	        const res = await fetch("/api/config", {
	          method: "POST",
	          headers: { "Content-Type": "application/json" },
	          body: JSON.stringify({ action: "activate_subscription", serverUrl, deviceName, licenseKey }),
	        });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        const r = payload.result || {};
	        const st = String(r.status || "");
	        if (st === "active") setCfgState(true, "云端激活成功");
	        else setCfgState(false, `云端激活失败: ${st || r.error || "unknown"}`);
	        await loadConfig();
	      } catch (e) {
	        setCfgState(false, `激活失败: ${e.message || e}`);
	      }
	    };

	    const loadTelemetryPreview = async () => {
	      if (!telemetryPreviewEl) return;
	      try {
	        const res = await fetch(`/api/telemetry?limit=80&t=${Date.now()}`, { cache: "no-store" });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        const data = payload.data || {};
	        const events = Array.isArray(data.events) ? data.events : [];
	        const lines = events.map((e) => JSON.stringify(e));
	        telemetryPreviewEl.textContent = lines.length ? lines.join("\n") : "(暂无遥测事件，或未开启匿名遥测)";
	      } catch (e) {
	        telemetryPreviewEl.textContent = `读取失败: ${e.message || e}`;
	      }
	    };

    const STATUS_COLUMNS = [
      { tag: "doing", title: "进行中" },
      { tag: "done_requested", title: "待机器完成" },
      { tag: "rollback_requested", title: "待机器回滚" },
      { tag: "todo", title: "待办" },
      { tag: "done", title: "已完成" },
    ];
    const BOARD_VIEW_COLUMNS = {
      execution: ["doing", "done_requested", "rollback_requested"],
      todo: ["todo"],
      done: ["done"],
      all: ["doing", "done_requested", "rollback_requested", "todo", "done"],
    };
    const PRI_RANK = { P0: 0, P1: 1, P2: 2 };
    let todoStore = { items: [] };
    let dragState = null;
    let fallbackMouseDragState = null;
    let touchDragState = null;
    const TOUCH_DRAG_HOLD_MS = 280;
    const TOUCH_DRAG_MOVE_TOLERANCE = 12;
    const MOUSE_DRAG_MOVE_TOLERANCE = 4;

    const esc = (s) =>
      String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    const normProject = (v) => String(v || "").trim() || defaultProject;
    const isAllProject = () => selectedProject === "__all__";
    const filterItemsByProject = (items) =>
      isAllProject() ? items : items.filter((x) => normProject(x.project) === selectedProject);
	    const filterItemsBySearch = (items) => {
	      const q = String(todoSearch || "").trim().toLowerCase();
	      if (!q) return items;
	      return (Array.isArray(items) ? items : []).filter((x) => {
	        const t = String(x && x.text ? x.text : "").toLowerCase();
	        const id = String(x && x.id ? x.id : "").toLowerCase();
	        return t.includes(q) || id.includes(q);
	      });
	    };

	    // Command helper modal: map UI actions -> copyable commands
	    const PM_HOME = "/Users/Zhuanz/codex-pm";
	    const PATH_BOARD_CLI = `${PM_HOME}/board_cli.py`;
	    const PATH_ATTACH = `${PM_HOME}/attach_codex_board_agents.py`;
	    const apiTodosUrl = () => `${location.origin}/api/todos`;
	    const pageUrl = () => `${location.origin}/pm`;
	    const shSingle = (s) => "'" + String(s || "").replace(/'/g, "'\\\\''") + "'";
	    const copyText = async (text) => {
	      const t = String(text || "");
	      if (!t) return false;
	      try {
	        await navigator.clipboard.writeText(t);
	        return true;
	      } catch (_) {
	        window.prompt("复制失败，请手动复制：", t);
	        return false;
	      }
	    };
	    const curlPost = (obj) => {
	      const body = JSON.stringify(obj || {});
	      return `curl -sS -X POST ${apiTodosUrl()} -H 'Content-Type: application/json' -d ${shSingle(body)}`;
	    };
	    const curlGetTodos = () => `curl -sS ${apiTodosUrl()}`;
	    const openChrome = () => `open -a "Google Chrome" "${pageUrl()}"`;
	    const copyCmd = async (action, params = {}) => {
	      try {
	        const cmd = actionCmd(action, params);
	        const ok = await copyText(cmd);
	        if (ok) setTodoState(true, "已复制命令");
	      } catch (e) {
	        setTodoState(false, `复制失败: ${e.message || e}`);
	      }
	    };
	    const cmdCard = ({ title, desc, cmd, small }) => {
	      const wrap = document.createElement("div");
	      wrap.className = "cmd-card";
	      const head = document.createElement("div");
	      head.className = "cmd-title";
	      const t = document.createElement("span");
	      t.textContent = String(title || "");
	      const actions = document.createElement("div");
	      actions.className = "cmd-actions";
	      const copyBtn = document.createElement("button");
	      copyBtn.type = "button";
	      copyBtn.textContent = "复制命令";
	      copyBtn.addEventListener("click", async () => {
	        const ok = await copyText(cmd);
	        if (ok) setTodoState(true, "已复制命令");
	      });
	      actions.appendChild(copyBtn);
	      head.appendChild(t);
	      head.appendChild(actions);
	      const kv = document.createElement("div");
	      kv.className = "cmd-kv";
	      if (desc) {
	        const d = document.createElement("div");
	        d.className = "tiny";
	        d.textContent = String(desc || "");
	        kv.appendChild(d);
	      }
	      const pre = document.createElement("pre");
	      pre.className = small ? "cmd-pre small" : "cmd-pre";
	      pre.textContent = String(cmd || "");
	      kv.appendChild(pre);
	      wrap.appendChild(head);
	      wrap.appendChild(kv);
	      return wrap;
	    };
	    const showCmdTab = (name) => {
	      const key = String(name || "attach");
	      cmdTabEls.forEach((b) => b.classList.toggle("active", b.getAttribute("data-cmd-tab") === key));
	      [cmdPanelAttachEl, cmdPanelTaskEl, cmdPanelPageEl].forEach((p) => p && p.classList.remove("active"));
	      if (key === "task" && cmdPanelTaskEl) cmdPanelTaskEl.classList.add("active");
	      else if (key === "page" && cmdPanelPageEl) cmdPanelPageEl.classList.add("active");
	      else if (cmdPanelAttachEl) cmdPanelAttachEl.classList.add("active");
	    };
	    const closeCmdModal = () => {
	      if (!cmdModalEl) return;
	      cmdModalEl.classList.remove("show");
	      cmdModalEl.setAttribute("aria-hidden", "true");
	    };
	    const openCmdModal = () => {
	      if (!cmdModalEl) return;
	      syncCmdPrefs();
	      syncCmdMachineOptions();
	      renderCmdPanels();
	      // 更符合“按钮对应命令”的使用习惯：有选中任务就直接进“当前任务”，否则进“页面按钮”
	      showCmdTab(selectedTodoId ? "task" : "page");
	      cmdModalEl.classList.add("show");
	      cmdModalEl.setAttribute("aria-hidden", "false");
	    };
	    const syncCmdPrefs = () => {
	      try {
	        const m = String(localStorage.getItem("pm_cmd_mode") || "").trim();
	        if (m) cmdMode = m;
	      } catch (_) {}
	      try {
	        const a = String(localStorage.getItem("pm_cmd_machine") || "").trim();
	        if (a) cmdMachine = a;
	      } catch (_) {}
	      if (cmdModeSelectEl) cmdModeSelectEl.value = cmdMode || "curl";
	    };
	    const syncCmdMachineOptions = () => {
	      if (!cmdMachineSelectEl) return;
	      const agents = Array.isArray(todoStore && todoStore.agents) ? todoStore.agents : [];
	      const online = agents.filter((x) => x && !x.stale);
	      const list = online.length ? online : agents;
	      const prev = String(cmdMachineSelectEl.value || cmdMachine || "").trim();
	      const opts = [];
	      for (const a of list) {
	        const id = String(a.agentId || "").trim();
	        if (!id) continue;
	        const label = `${a.displayTitle || a.title || id} (${id}) · ${a.project || "-"} · ${a.state || "idle"}${a.stale ? " · 离线" : ""}`;
	        opts.push({ id, label });
	      }
	      // Fallbacks
	      if (!opts.find((x) => x.id === "codex-ttys000")) opts.push({ id: "codex-ttys000", label: "codex-ttys000 (fallback)" });
	      cmdMachineSelectEl.innerHTML = opts.map((x) => `<option value="${esc(x.id)}">${esc(x.label)}</option>`).join("");
	      const next = opts.find((x) => x.id === prev) ? prev : (opts[0] ? opts[0].id : "codex-ttys000");
	      cmdMachineSelectEl.value = next;
	      cmdMachine = next;
	      try { localStorage.setItem("pm_cmd_machine", cmdMachine); } catch (_) {}
	    };
	    const cmdModeNow = () => {
	      // Only trust the select when the modal is open; otherwise use stored prefs.
	      const modalOpen = !!(cmdModalEl && cmdModalEl.classList.contains("show"));
	      const v = modalOpen && cmdModeSelectEl ? String(cmdModeSelectEl.value || "").trim() : "";
	      return v || cmdMode || "cli";
	    };
	    const machineNow = () => {
	      const modalOpen = !!(cmdModalEl && cmdModalEl.classList.contains("show"));
	      const v = modalOpen && cmdMachineSelectEl ? String(cmdMachineSelectEl.value || "").trim() : "";
	      return v || cmdMachine || "codex-ttys000";
	    };
	    const shArg = (v) => {
	      const s = String(v == null ? "" : v);
	      if (!s) return "''";
	      if (/^[A-Za-z0-9_@:+,./-]+$/.test(s)) return s;
	      return shSingle(s);
	    };
	    const py = (parts) => (Array.isArray(parts) ? parts.filter(Boolean).map(shArg).join(" ") : "");
	    const PATH_OFFLINE = `${PM_HOME}/board_offline.py`;
	    const actionCmd = (action, params = {}) => {
	      const mode = cmdModeNow();
	      const m = machineNow();
	      const a = String(action || "").trim();
	      const p = params || {};
	      if (mode === "offline") {
	        if (a === "add") return py(["python3", PATH_OFFLINE, "add", "--text", p.text, "--priority", p.priority || "P1", "--project", p.project || ""]);
	        if (a === "set_status") return py(["python3", PATH_OFFLINE, "set-status", "--id", p.id, "--status", p.status || "doing"]);
	        if (a === "request_done") return py(["python3", PATH_OFFLINE, "request-done", "--id", p.id]);
	        if (a === "confirm_done") return py(["python3", PATH_OFFLINE, "confirm-done", "--id", p.id, "--machine-by", m]);
	        if (a === "request_rollback") return py(["python3", PATH_OFFLINE, "request-rollback", "--id", p.id]);
	        if (a === "cancel_rollback_request") return py(["python3", PATH_OFFLINE, "cancel-rollback-request", "--id", p.id]);
	        if (a === "confirm_rollback") return py(["python3", PATH_OFFLINE, "confirm-rollback", "--id", p.id, "--machine-by", m]);
	        if (a === "update_text") return py(["python3", PATH_OFFLINE, "update-text", "--id", p.id, "--text", p.text]);
	        if (a === "set_project") return py(["python3", PATH_OFFLINE, "set-project", "--id", p.id, "--project", p.project]);
	        if (a === "set_agent_alias") return py(["python3", PATH_OFFLINE, "set-agent-alias", "--agent-id", p.agentId, "--alias", p.alias]);
	        if (a === "set_agent_project") return py(["python3", PATH_OFFLINE, "set-agent-project", "--agent-id", p.agentId, "--project", p.project]);
	        if (a === "capture_git") return py(["python3", PATH_OFFLINE, "capture-git", "--id", p.id]);
	        if (a === "set_check") return py(["python3", PATH_OFFLINE, "set-check", "--id", p.id, "--key", p.key, "--value", p.value]);
	        if (a === "delete") return py(["python3", PATH_OFFLINE, "delete", "--id", p.id]);
	        if (a === "cleanup_agents") return py(["python3", PATH_OFFLINE, "cleanup-agents"]);
	        if (a === "add_iteration")
	          return py(["python3", PATH_OFFLINE, "add-iteration", "--project", p.project || "", "--type", p.type || "manual", "--title", p.title, "--summary", p.summary || "", "--source", p.source || "manual"]);
	      }
	      if (mode === "cli") {
	        if (a === "add") return py(["python3", PATH_BOARD_CLI, "add", "--text", p.text, "--priority", p.priority || "P1", "--project", p.project || "", "--offline"]);
	        if (a === "set_status") return py(["python3", PATH_BOARD_CLI, "set-status", "--id", p.id, "--status", p.status || "doing", "--offline"]);
	        if (a === "request_done") return py(["python3", PATH_BOARD_CLI, "request-done", "--id", p.id, "--offline"]);
	        if (a === "confirm_done") return py(["python3", PATH_BOARD_CLI, "confirm-done", "--id", p.id, "--agent", m, "--offline"]);
	        if (a === "request_rollback") return py(["python3", PATH_BOARD_CLI, "request-rollback", "--id", p.id, "--offline"]);
	        if (a === "cancel_rollback_request") return py(["python3", PATH_BOARD_CLI, "cancel-rollback-request", "--id", p.id, "--offline"]);
	        if (a === "confirm_rollback") return py(["python3", PATH_BOARD_CLI, "confirm-rollback", "--id", p.id, "--agent", m, "--offline"]);
	        if (a === "update_text") return py(["python3", PATH_BOARD_CLI, "update-text", "--id", p.id, "--text", p.text, "--offline"]);
	        if (a === "set_project") return py(["python3", PATH_BOARD_CLI, "set-project", "--id", p.id, "--project", p.project, "--offline"]);
	        if (a === "set_agent_alias") return py(["python3", PATH_BOARD_CLI, "set-agent-alias", "--agent-id", p.agentId, "--alias", p.alias, "--offline"]);
	        if (a === "set_agent_project") return py(["python3", PATH_BOARD_CLI, "set-agent-project", "--agent-id", p.agentId, "--project", p.project, "--offline"]);
	        if (a === "capture_git") return py(["python3", PATH_BOARD_CLI, "capture-git", "--id", p.id, "--offline"]);
	        if (a === "set_check") return py(["python3", PATH_BOARD_CLI, "set-check", "--id", p.id, "--key", p.key, "--value", p.value, "--offline"]);
	        if (a === "delete") return py(["python3", PATH_BOARD_CLI, "delete", "--id", p.id, "--offline"]);
	        if (a === "cleanup_agents") return py(["python3", PATH_BOARD_CLI, "cleanup-agents", "--offline"]);
	        if (a === "add_iteration")
	          return py([
	            "python3",
	            PATH_BOARD_CLI,
	            "add-iteration",
	            "--project",
	            p.project || "",
	            "--type",
	            p.type || "manual",
	            "--title",
	            p.title,
	            "--summary",
	            p.summary || "",
	            "--source",
	            p.source || "manual",
	            "--offline",
	          ]);
	      }
	      // curl (default)
	      const body = { action: a, ...(p || {}) };
	      if (a === "confirm_done" || a === "confirm_rollback") body.machineBy = m;
	      return curlPost(body);
	    };
	    const renderCmdPanels = () => {
	      if (!cmdPanelAttachEl || !cmdPanelTaskEl || !cmdPanelPageEl) return;
	      // agents 列表会随心跳变化；弹窗打开期间也要能刷新可选机器终端
	      syncCmdMachineOptions();
	      cmdPanelAttachEl.innerHTML = "";
	      cmdPanelTaskEl.innerHTML = "";
	      cmdPanelPageEl.innerHTML = "";

	      cmdPanelAttachEl.appendChild(cmdCard({ title: "打开页面（Chrome）", desc: "直接对齐用 Chrome 打开当前看板页面。", cmd: openChrome() }));
	      cmdPanelAttachEl.appendChild(cmdCard({ title: "一键接入当前运行中的 Codex 会话（自动抢单）", desc: "终端开着会定期心跳 + 自动 claim_next。建议长期使用。", cmd: `python3 ${PATH_ATTACH} --managed --offline` }));
	      cmdPanelAttachEl.appendChild(cmdCard({ title: "一键接入当前运行中的 Codex 会话（只监听不抢单）", desc: "纯监听进度，不会自动领取任务。", cmd: `python3 ${PATH_ATTACH} --observe-only --offline` }));
	      cmdPanelAttachEl.appendChild(
	        cmdCard({
	          title: "指定 tty 对齐项目/终端名（解决“终端对不上”）",
	          desc: "按你的 Terminal 标签把 ttys 映射到 project/title；会重启已挂载的 board-agent。",
	          cmd:
	            `python3 ${PATH_ATTACH} --restart --offline --observe-only \\\\\\n` +
	            `  --tty-title ttys001:终端B-守护 --tty-title ttys002:终端C-守护 \\\\\\n` +
	            `  --tty-project ttys001:TrendRadar --tty-project ttys002:clawd`,
	          small: true,
	        })
	      );
	      cmdPanelAttachEl.appendChild(
	        cmdCard({
	          title: "把 tty 绑定保存成长期配置（一次设置，启动即加载）",
	          desc: "会写入 docs/pm-attach.json；以后 pm start/pm attach 会自动读取并对齐。",
	          cmd:
	            `pm attach --restart --save-bindings \\\\\\n` +
	            `  --tty-title ttys001:终端B-守护 --tty-title ttys002:终端C-守护 \\\\\\n` +
	            `  --tty-project ttys001:TrendRadar --tty-project ttys002:clawd`,
	          small: true,
	        })
	      );
	      cmdPanelAttachEl.appendChild(cmdCard({ title: "清理历史离线终端（等同按钮：清理历史终端）", desc: "仅保留近期在线的终端心跳记录。", cmd: actionCmd("cleanup_agents"), small: true }));
	      cmdPanelAttachEl.appendChild(
	        cmdCard({
	          title: "重命名终端显示名（等同：点击终端标签重命名）",
	          desc: "这不会改你系统 Terminal 的标题，只影响看板展示。用于把看板终端名对齐到你看到的标签。",
	          cmd: actionCmd("set_agent_alias", { agentId: machineNow(), alias: "终端A-主窗口" }),
	          small: true,
	        })
	      );
	      cmdPanelAttachEl.appendChild(
	        cmdCard({
	          title: "强制对齐终端所属项目（可选）",
	          desc: "用于修正推断错误的 project（例如在 home 目录启动导致归类到 Zhuanz）。留空可清除覆盖。",
	          cmd: actionCmd("set_agent_project", { agentId: machineNow(), project: "coach-feishu-suite" }),
	          small: true,
	        })
	      );
	      cmdPanelAttachEl.appendChild(
	        cmdCard({
	          title: "board_cli 直接运行（单终端）",
	          desc: "如果你不想用 attach 脚本，这里是单终端 daemon 模式（observe-only/managed）。",
	          cmd: `python3 ${PATH_BOARD_CLI} daemon --observe-only --offline\\npython3 ${PATH_BOARD_CLI} daemon --offline`,
	          small: true,
	        })
	      );

	      const it = selectedTodoItem();
	      const tid = String((it && it.id) || "").trim();
	      if (!tid) {
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "未选择任务", desc: "在看板里点一下某个任务卡片（会出现选中描边），这里就会生成针对该任务的命令。", cmd: "（先在看板中选中一条任务）" }));
	      } else {
	        const proj = normProject(it.project);
	        cmdPanelTaskEl.appendChild(cmdCard({ title: `当前选中任务：${tid}`, desc: `项目：${proj} | 状态：${String(it.status || "todo")}`, cmd: String(it.text || "") }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "开始（等同按钮：开始）", desc: "todo -> doing", cmd: actionCmd("set_status", { id: tid, status: "doing" }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "申请完成（等同按钮：申请完成）", desc: "doing -> done_requested", cmd: actionCmd("request_done", { id: tid }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "机器确认完成（机器执行）", desc: "done_requested -> done（或 doing -> done）", cmd: actionCmd("confirm_done", { id: tid }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "申请回滚（等同按钮：申请回滚）", desc: "done -> rollback_requested", cmd: actionCmd("request_rollback", { id: tid }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "撤销回滚申请（等同按钮：撤销回滚）", desc: "rollback_requested -> done", cmd: actionCmd("cancel_rollback_request", { id: tid }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "机器确认回滚（机器执行）", desc: "rollback_requested -> todo", cmd: actionCmd("confirm_rollback", { id: tid }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "改字（等同菜单：改字）", desc: "更新任务正文", cmd: actionCmd("update_text", { id: tid, text: "把这段替换成新内容" }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "改项目（等同菜单：改项目）", desc: "把任务迁移到另一个 project", cmd: actionCmd("set_project", { id: tid, project: proj }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "更新 Git 信息（等同菜单：更新Git信息）", desc: "抓取任务对应的 git snapshot", cmd: actionCmd("capture_git", { id: tid }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "标记测试状态（等同菜单：标记测试）", desc: "key=tests: pass/fail/not_run/unknown", cmd: actionCmd("set_check", { id: tid, key: "tests", value: "pass" }), small: true }));
	        cmdPanelTaskEl.appendChild(cmdCard({ title: "删除任务（等同菜单：删除）", desc: "不可恢复，谨慎", cmd: actionCmd("delete", { id: tid }), small: true }));
	      }

	      const p = selectedProject !== "__all__" ? selectedProject : String((newTodoProjectEl && newTodoProjectEl.value) || defaultProject || "coach-feishu-suite");
	      const mode = cmdModeNow();
	      const pmShortcuts =
	        `# pm 快捷命令（按钮对应）\n` +
	        `pm ls --project ${p}\n` +
	        `pm add '写你的任务内容' --project ${p} --priority P1\n` +
	        `pm it-ls --project ${p} --limit 30\n` +
	        `pm it-add --project ${p} --type fix --title '填写迭代标题' --summary '补充说明（可选）'\n` +
	        `pm open --chrome\n` +
	        `pm attach --restart`;
	      cmdPanelPageEl.appendChild(cmdCard({ title: "pm 快捷命令（按钮对应）", desc: "把常用按钮封装成短命令（默认离线落盘，更稳定）。", cmd: pmShortcuts, small: true }));
	      const listTasksCmd =
	        mode === "offline"
	          ? py(["python3", PATH_OFFLINE, "list", "--project", p])
	          : mode === "cli"
	            ? py(["python3", PATH_BOARD_CLI, "list", "--project", p, "--offline"])
	            : curlGetTodos();
	      const listItersCmd =
	        mode === "offline"
	          ? py(["python3", PATH_OFFLINE, "list-iterations", "--project", p, "--limit", "50"])
	          : mode === "cli"
	            ? py(["python3", PATH_BOARD_CLI, "list-iterations", "--project", p, "--limit", "50", "--offline"])
	            : `curl -sS \"${location.origin}/api/iterations?project=${encodeURIComponent(p)}\"`;

	      cmdPanelPageEl.appendChild(cmdCard({ title: "刷新任务（等同按钮：刷新任务）", desc: "读取任务列表", cmd: listTasksCmd, small: true }));
	      cmdPanelPageEl.appendChild(cmdCard({ title: "添加任务（等同按钮：添加任务/快速添加）", desc: "action=add", cmd: actionCmd("add", { text: "写你的任务内容", priority: "P1", project: p }), small: true }));
	      cmdPanelPageEl.appendChild(cmdCard({ title: "记录迭代（等同按钮：记录迭代）", desc: "写版本日志并触发项目文档 AUTO 区同步", cmd: actionCmd("add_iteration", { project: p, type: "fix", title: "填写迭代标题", summary: "补充说明（可选）", source: "manual" }), small: true }));
	      cmdPanelPageEl.appendChild(cmdCard({ title: "拉取迭代日志（等同按钮：刷新日志）", desc: "读取版本/日程日志", cmd: listItersCmd, small: true }));
	    };

    const fmtIterTs = (iso) => {
      const s = String(iso || "").trim();
      if (!s) return "-";
      try {
        const d = new Date(s);
        if (Number.isNaN(d.getTime())) return s.slice(0, 16).replace("T", " ");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${mm}-${dd} ${hh}:${mi}`;
      } catch (_) {
        return s.slice(0, 16).replace("T", " ");
      }
    };
    const projectProgressMap = (items) => {
      const map = {};
      const arr = Array.isArray(items) ? items : [];
      for (const it of arr) {
        const p = normProject(it && it.project ? it.project : "");
        if (!map[p]) map[p] = { active: 0, doing: 0, waiting: 0 };
        const st = String(it && it.status ? it.status : "todo");
        if (st === "doing") { map[p].active += 1; map[p].doing += 1; }
        else if (st === "done_requested" || st === "rollback_requested") { map[p].active += 1; map[p].waiting += 1; }
      }
      return map;
    };
    const saveProjectFavorites = () => {
      try {
        localStorage.setItem(PROJECT_FAVORITES_KEY, JSON.stringify(Array.from(favoriteProjects)));
      } catch (_) {}
      scheduleSyncProjectPrefs();
    };
    const saveSelectedProject = () => {
      try { localStorage.setItem(PROJECT_SELECTED_KEY, String(selectedProject || "__all__")); } catch (_) {}
      updateProjectStateUrl();
      scheduleSyncProjectPrefs();
    };
    const saveProjectTabsPage = () => {
      try { localStorage.setItem(PROJECT_TABS_PAGE_KEY, String(Math.max(0, Number(projectTabsPage) || 0))); } catch (_) {}
      updateProjectStateUrl();
      scheduleSyncProjectPrefs();
    };
    const saveProjectTabsScroll = (left) => {
      const x = Number(left);
      if (!Number.isFinite(x) || x < 0) return;
      try { localStorage.setItem(PROJECT_TABS_SCROLL_KEY, String(x)); } catch (_) {}
    };
    const scheduleSaveProjectTabsScroll = () => {
      if (projectTabsIgnoreScrollSave || !projectTabsEl) return;
      if (projectTabsScrollSaveTimer) clearTimeout(projectTabsScrollSaveTimer);
      projectTabsScrollSaveTimer = setTimeout(() => {
        projectTabsScrollSaveTimer = null;
        if (!projectTabsEl) return;
        saveProjectTabsScroll(projectTabsEl.scrollLeft || 0);
        updateProjectStateUrl();
        scheduleSyncProjectPrefs();
      }, 80);
    };
    const updateProjectTabsViewportState = () => {
      if (!projectTabsEl) return;
      const left = Number(projectTabsEl.scrollLeft || 0);
      const max = Math.max(0, Number(projectTabsEl.scrollWidth || 0) - Number(projectTabsEl.clientWidth || 0));
      const canScroll = max > 2;
      const canLeft = canScroll && left > 2;
      const canRight = canScroll && left < max - 2;
      if (projectTabsFadeLeftEl) projectTabsFadeLeftEl.classList.toggle("show", canLeft);
      if (projectTabsFadeRightEl) projectTabsFadeRightEl.classList.toggle("show", canRight);
      if (projectTabsPrevBtn) projectTabsPrevBtn.disabled = !canLeft;
      if (projectTabsNextBtn) projectTabsNextBtn.disabled = !canRight;
    };
    const updateProjectTabsPagerState = () => {
      const total = Math.max(0, projectTabItems.length - 1);
      const usePaging = featureFlags.projectTabsPagination !== false && total > projectTabPageThreshold;
      const pageCount = usePaging ? Math.max(1, Math.ceil(total / projectTabPageSize)) : 1;
      projectTabsPageCount = pageCount;
      const clamped = Math.max(0, Math.min(pageCount - 1, Number(projectTabsPage) || 0));
      if (clamped !== projectTabsPage) {
        projectTabsPage = clamped;
        saveProjectTabsPage();
      }
      if (projectTabsPagerWrapEl) projectTabsPagerWrapEl.classList.toggle("show", usePaging);
      if (projectTabsPagerEl) projectTabsPagerEl.textContent = `${projectTabsPage + 1}/${pageCount}`;
      if (projectTabsPagePrevBtn) projectTabsPagePrevBtn.disabled = !usePaging || projectTabsPage <= 0;
      if (projectTabsPageNextBtn) projectTabsPageNextBtn.disabled = !usePaging || projectTabsPage >= pageCount - 1;
      return usePaging;
    };
    const ensureProjectPageVisible = (value) => {
      const total = Math.max(0, projectTabItems.length - 1);
      if (featureFlags.projectTabsPagination === false || total <= projectTabPageThreshold) return;
      const items = projectTabItems.slice(1);
      const idx = items.findIndex((x) => x && x.value === value);
      if (idx < 0) return;
      const next = Math.floor(idx / projectTabPageSize);
      if (next !== projectTabsPage) {
        projectTabsPage = next;
        saveProjectTabsPage();
      }
    };
    const projectGroupLabel = (group) => {
      if (group === "favorites") return "收藏置顶";
      if (group === "active") return "活跃项目";
      return "其他项目";
    };
    const projectMetaText = (item) => {
      const parts = [`最近:${item && item.latestLabel ? item.latestLabel : "-"}`];
      if (item && item.stats) {
        const doing = Number(item.stats.doing || 0);
        const waiting = Number(item.stats.waiting || 0);
        if (doing > 0) parts.push(`进行中:${doing}`);
        if (waiting > 0) parts.push(`待确认:${waiting}`);
      }
      return parts.join(" · ");
    };
    const renderProjectTabPill = (item, active) => {
      const stats = item && item.stats ? item.stats : { doing: 0, waiting: 0 };
      const doing = Number(stats.doing || 0);
      const waiting = Number(stats.waiting || 0);
      const showBadges = featureFlags.projectTabsBadges !== false;
      const badges =
        `<span class="project-status-badges">` +
        (showBadges && doing > 0 ? `<span class="project-status-badge doing" title="进行中">${doing}</span>` : "") +
        (showBadges && waiting > 0 ? `<span class="project-status-badge waiting" title="待确认">${waiting}</span>` : "") +
        `</span>`;
      const title = String((item && item.title) || (item && item.value) || "");
      const value = String((item && item.value) || "__all__");
      const meta = projectMetaText(item);
      const isFavorite = !!(item && item.isFavorite);
      const favBtn =
        value === "__all__"
          ? ""
          : `<button class="project-fav-btn${isFavorite ? " active" : ""}" type="button" data-project-favorite="${esc(value)}" aria-label="${isFavorite ? "取消收藏项目" : "收藏项目"}" title="${isFavorite ? "取消收藏" : "收藏置顶"}">★</button>`;
      return `<span class="project-pill-wrap"><button class="project-pill${active ? " active" : ""}" type="button" role="tab" aria-selected="${active ? "true" : "false"}" aria-current="${active ? "true" : "false"}" aria-controls="todoList" tabindex="0" data-project-value="${esc(value)}" title="${esc(`${title} · ${meta}`)}"><span class="project-pill-title-row"><span class="project-pill-title">${esc(title)}</span>${badges}</span><span class="project-pill-meta">${esc(meta)}</span></button>${favBtn}</span>`;
    };
    const syncProjectTabsFromSelect = () => {
      if (!projectTabsEl || !projectFilterEl) return;
      if (projectTabsFallbackMode) return;
      try {
        const usePaging = updateProjectTabsPagerState();
        const current = projectFilterEl.value || "__all__";
        ensureProjectPageVisible(current);
        const allItem = projectTabItems.find((x) => x && x.value === "__all__") || { value: "__all__", title: "全部项目", stats: { doing: 0, waiting: 0 }, latestLabel: "-", group: "all" };
        const scoped = projectTabItems.filter((x) => x && x.value !== "__all__");
        const pageStart = usePaging ? projectTabsPage * projectTabPageSize : 0;
        const pageEnd = usePaging ? pageStart + projectTabPageSize : scoped.length;
        const visible = scoped.slice(pageStart, pageEnd);
        sampleProjectNavFpsIfNeeded(scoped.length);
        const sig = JSON.stringify({
          current,
          page: projectTabsPage,
          usePaging,
          all: [Number(allItem.stats && allItem.stats.doing || 0), Number(allItem.stats && allItem.stats.waiting || 0)],
          list: visible.map((x) => [x.value, x.group, Number(x.stats && x.stats.doing || 0), Number(x.stats && x.stats.waiting || 0), x.latestLabel, x.isFavorite ? 1 : 0]),
        });
        if (sig === projectTabsRenderSig) {
          updateProjectTabsPagerState();
          updateProjectTabsViewportState();
          return;
        }
        projectTabsRenderSig = sig;
        const prevScroll = Number(projectTabsEl.scrollLeft || 0);
        let lastGroup = "";
        const body = visible
          .map((item) => {
            const chunk = [];
            const showGroups = featureFlags.projectTabsGrouping !== false;
            if (showGroups && item.group && item.group !== lastGroup) {
              chunk.push(`<span class="project-group-label">${esc(projectGroupLabel(item.group))}</span>`);
              lastGroup = item.group;
            }
            chunk.push(renderProjectTabPill(item, item.value === current));
            return chunk.join("");
          })
          .join("");
        projectTabsEl.innerHTML = renderProjectTabPill(allItem, current === "__all__") + body;
        projectTabsIgnoreScrollSave = true;
        const toScroll = projectTabsDidRestoreScroll ? prevScroll : projectTabsInitialScroll;
        projectTabsEl.scrollLeft = Number.isFinite(toScroll) && toScroll > 0 ? toScroll : 0;
        projectTabsDidRestoreScroll = true;
        setTimeout(() => {
          projectTabsIgnoreScrollSave = false;
          updateProjectTabsViewportState();
        }, 0);
        updateProjectTabsPagerState();
        updateProjectTabsViewportState();
        updateProjectStateUrl();
      } catch (e) {
        setProjectNavFallback(true, "导航渲染异常");
      }
    };
    const syncProjectSelectors = (store) => {
      const set = new Set();
      const catalog = Array.isArray(store.projectCatalog) ? store.projectCatalog : [];
      for (const p of catalog) {
        const v = String(p || "").trim();
        if (v) set.add(v);
      }
      for (const x of store.items || []) set.add(normProject(x.project));
      if (store.defaultProject) defaultProject = String(store.defaultProject).trim() || defaultProject;
      set.add(defaultProject);

      const itMap = store && store.iterLatestByProject && typeof store.iterLatestByProject === "object" ? store.iterLatestByProject : {};
      const latestTs = (project) => {
        const raw = String((itMap && itMap[project]) || "").trim();
        if (!raw) return -1;
        const ts = Date.parse(raw);
        return Number.isNaN(ts) ? -1 : ts;
      };
      const projects = Array.from(set).sort((a, b) => {
        const dt = latestTs(b) - latestTs(a);
        if (dt !== 0) return dt;
        return a.localeCompare(b);
      });
      const favBefore = favoriteProjects.size;
      favoriteProjects = new Set(Array.from(favoriteProjects).filter((p) => projects.includes(p)));
      if (favoriteProjects.size !== favBefore) saveProjectFavorites();
      const prevFilter = selectedProject;
      const prevNewProject = newTodoProjectEl.value || defaultProject;

	      const prog = projectProgressMap(store.items || []);
	      const activeProjCount = Object.keys(prog).filter((k) => prog[k] && Number(prog[k].active || 0) > 0).length;
      const favorites = [];
      const nonFavorites = [];
      for (const p of projects) {
        if (favoriteProjects.has(p)) favorites.push(p);
        else nonFavorites.push(p);
      }
      const activeProjects = nonFavorites.filter((p) => Number(prog[p] && prog[p].active || 0) > 0);
      const otherProjects = nonFavorites.filter((p) => Number(prog[p] && prog[p].active || 0) <= 0);
      const orderedProjects = featureFlags.projectTabsGrouping !== false ? favorites.concat(activeProjects, otherProjects) : favorites.concat(nonFavorites);
	      const optPlain = orderedProjects.map((p) => `<option value="${esc(p)}">${esc(p)}</option>`).join("");
      const optFilter = orderedProjects
        .map((p) => {
          const latest = fmtIterTs(itMap && itMap[p] ? itMap[p] : "");
          const doing = prog[p] ? Number(prog[p].doing || 0) : 0;
          const waiting = prog[p] ? Number(prog[p].waiting || 0) : 0;
          const meta = [`最近:${latest}`];
          if (doing > 0) meta.push(`进行中:${doing}`);
          if (waiting > 0) meta.push(`待确认:${waiting}`);
          const label = `${p} · ${meta.join(" · ")}`;
          return `<option value="${esc(p)}">${esc(label)}</option>`;
        })
        .join("");
	      const allLabel = activeProjCount > 0 ? `全部项目 · 迭代中:${activeProjCount}` : "全部项目";
	      projectFilterEl.innerHTML = `<option value="__all__">${esc(allLabel)}</option>` + optFilter;
      newTodoProjectEl.innerHTML = optPlain;
      quickAddProjectEl.innerHTML = optPlain;
      if (suggestProjectEl) suggestProjectEl.innerHTML = optPlain;

      if (prevFilter === "__all__" || projects.includes(prevFilter)) selectedProject = prevFilter;
      else selectedProject = defaultProject;
      projectFilterEl.value = selectedProject;
      saveSelectedProject();

      const desiredNew = selectedProject !== "__all__" ? selectedProject : prevNewProject;
      newTodoProjectEl.value = projects.includes(desiredNew) ? desiredNew : defaultProject;
      quickAddProjectEl.value = projects.includes(desiredNew) ? desiredNew : defaultProject;
	      if (suggestProjectEl) suggestProjectEl.value = projects.includes(desiredNew) ? desiredNew : defaultProject;
      const allDoing = Object.values(prog).reduce((acc, x) => acc + Number(x && x.doing || 0), 0);
      const allWaiting = Object.values(prog).reduce((acc, x) => acc + Number(x && x.waiting || 0), 0);
      projectTabItems = [
        { value: "__all__", title: "全部项目", latestLabel: "-", latestTs: -1, stats: { doing: allDoing, waiting: allWaiting }, group: "all", isFavorite: false },
        ...favorites.map((p) => ({ value: p, title: p, latestLabel: fmtIterTs(itMap && itMap[p] ? itMap[p] : ""), latestTs: latestTs(p), stats: prog[p] || { doing: 0, waiting: 0 }, group: "favorites", isFavorite: true })),
        ...(featureFlags.projectTabsGrouping !== false
          ? activeProjects.map((p) => ({ value: p, title: p, latestLabel: fmtIterTs(itMap && itMap[p] ? itMap[p] : ""), latestTs: latestTs(p), stats: prog[p] || { doing: 0, waiting: 0 }, group: "active", isFavorite: false }))
          : []),
        ...(featureFlags.projectTabsGrouping !== false
          ? otherProjects.map((p) => ({ value: p, title: p, latestLabel: fmtIterTs(itMap && itMap[p] ? itMap[p] : ""), latestTs: latestTs(p), stats: prog[p] || { doing: 0, waiting: 0 }, group: "others", isFavorite: false }))
          : nonFavorites.map((p) => ({ value: p, title: p, latestLabel: fmtIterTs(itMap && itMap[p] ? itMap[p] : ""), latestTs: latestTs(p), stats: prog[p] || { doing: 0, waiting: 0 }, group: "others", isFavorite: false }))),
      ];
      projectSearchItems = projectTabItems.filter((x) => x && x.value !== "__all__");
      ensureProjectPageVisible(selectedProject);
      syncProjectTabsFromSelect();
    };

    const renderAgents = (store) => {
      const agents = Array.isArray(store.agents) ? store.agents.slice() : [];
      const visible = isAllProject()
        ? agents
        : agents.filter((x) => {
            const p = String(x && x.project ? x.project : "").trim();
            return !p || p === selectedProject;
          });
      const online = visible.filter((x) => !x.stale);
      const staleCount = Math.max(0, visible.length - online.length);
      agentCountEl.textContent = staleCount > 0 ? `${online.length}/${visible.length}` : String(online.length);
      if (!visible.length) {
        agentStripEl.innerHTML = `<span class="tiny">暂无终端心跳。其他 Codex 可用 board_cli.py 发送 agent_ping 接入。</span>`;
        return;
      }
      const chips = visible
        .map((a) => {
          const staleClass = a.stale ? " stale" : "";
          const state = esc(a.state || "idle");
          const aid = esc(a.agentId || "unknown");
          const title = esc(a.displayTitle || a.title || a.agentId || "terminal");
          const rawTitle = esc(a.title || a.agentId || "terminal");
          const proj = esc(a.project || "-");
          const task = a.taskId ? ` · ${esc(a.taskId)}` : "";
          return `<span class="agent-chip${staleClass}" data-agent-id="${aid}" data-agent-title="${rawTitle}" title="点击重命名">${title} (${aid}) · ${proj} · ${state}${task}</span>`;
        })
        .join("");
      const staleHint =
        staleCount > 0
          ? `<span class="tiny">在线 ${online.length} / 总 ${visible.length}（灰色为离线历史终端）</span>`
          : `<span class="tiny">在线 ${online.length} / 总 ${visible.length}</span>`;
      agentStripEl.innerHTML = chips + staleHint;
      agentStripEl.querySelectorAll(".agent-chip[data-agent-id]").forEach((el) => {
        el.addEventListener("click", async () => {
          const agentId = el.getAttribute("data-agent-id");
          if (!agentId) return;
          const currentLabel = el.textContent || "";
          const nextAlias = window.prompt("设置终端显示名（留空恢复默认）", currentLabel.replace(/\s*\(.+$/, "").trim());
          if (nextAlias === null) return;
          try {
            const next = await apiPost({ action: "set_agent_alias", agentId, alias: nextAlias.trim() });
            applyTodoStore(next);
          } catch (e) {
            setTodoState(false, `终端改名失败: ${e.message || e}`);
          }
        });
      });
    };
    const iterTypeLabel = (raw) => {
      const k = String(raw || "manual").toLowerCase();
      if (k === "done") return "完成";
      if (k === "rollback") return "回滚";
      if (k === "optimize") return "优化";
      if (k === "fix") return "修复";
      if (k === "architecture") return "架构";
      if (k === "milestone") return "里程碑";
      return "手动";
    };
	    const renderIterations = (items) => {
	      const list = Array.isArray(items) ? items.slice() : [];
	      iterCountEl.textContent = String(list.length);
	      iterLastAtEl.textContent = list.length ? String(list[0].createdAt || "-") : "-";
	      if (!list.length) {
	        if (iterCalStripEl) iterCalStripEl.innerHTML = "";
	        iterTimelineEl.innerHTML = `<div class="empty-line">暂无迭代日志</div>`;
	        return;
	      }
	      const groups = {};
	      for (const x of list) {
	        const date = String(x.date || String(x.createdAt || "").slice(0, 10) || "unknown");
	        if (!groups[date]) groups[date] = [];
	        groups[date].push(x);
	      }
	      const dates = Object.keys(groups).sort((a, b) => b.localeCompare(a));
	      const calKey = `pm_iter_date_${selectedProject || ""}`;
	      let activeDate = "";
	      try { activeDate = localStorage.getItem(calKey) || ""; } catch (_) {}
	      if (!activeDate || !groups[activeDate]) activeDate = dates[0] || "";
	      if (iterCalStripEl) {
	        const week = (d) => {
	          try {
	            const dt = new Date(`${d}T00:00:00`);
	            if (Number.isNaN(dt.getTime())) return "";
	            return dt.toLocaleDateString("zh-CN", { weekday: "short" });
	          } catch (_) {
	            return "";
	          }
	        };
	        iterCalStripEl.innerHTML = dates
	          .map((d) => {
	            const md = /^\d{4}-\d{2}-\d{2}$/.test(d) ? d.slice(5) : d;
	            const wk = week(d) || "";
	            const cls = d === activeDate ? "iter-cal-day active" : "iter-cal-day";
	            return `<button class="${cls}" type="button" data-iter-date="${esc(d)}" title="跳转到 ${esc(d)}"><div class="md">${esc(md)}</div><div class="wk">${esc(wk)}</div></button>`;
	          })
	          .join("");
	      }
	      const html = Object.keys(groups)
	        .sort((a, b) => b.localeCompare(a))
	        .map((date) => {
	          const rows = groups[date]
	            .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")))
            .map((x) => {
              const versionTag = esc(x.versionTag || "-");
              const typeLabel = esc(iterTypeLabel(x.type));
              const title = esc(x.title || "(未命名迭代)");
              const summary = esc(x.summary || "");
              const machine = x.machineBy ? `<span>机器: ${esc(x.machineBy)}</span>` : "";
              const task = x.taskId ? `<span>任务: ${esc(x.taskId)}</span>` : "";
              const timeText = esc(String(x.createdAt || "").slice(11, 19) || "--:--:--");
	              return `
	                <div class="iter-item">
                  <div class="iter-head">
                    <span class="badge">${timeText}</span>
                    <span class="badge project">${versionTag}</span>
                    <span class="badge">${typeLabel}</span>
                    ${task}
                    ${machine}
                  </div>
                  <div class="iter-title">${title}</div>
                  ${summary ? `<div class="iter-summary">${summary}</div>` : ""}
                </div>
	              `;
	            })
	            .join("");
	          return `<div class="iter-day" data-iter-day="${esc(date)}"><div class="iter-day-title">${esc(date)}</div>${rows}</div>`;
	        })
	        .join("");
	      iterTimelineEl.innerHTML = html;

	      if (activeDate) {
	        const safeDate = String(activeDate || "");
	        const dayEl = iterTimelineEl.querySelector(`[data-iter-day="${safeDate}"]`);
	        if (dayEl) {
	          // 让用户点击日期后稳定落在该日期块顶部（而不是全页滚动）。
	          const top = dayEl.offsetTop - 6;
	          iterTimelineEl.scrollTop = Math.max(0, top);
	        }
	      }
	    };
    const setDocChangelogError = (msg) => {
      const m = String(msg || "unknown");
      if (docLatestIterEl) {
        docLatestIterEl.innerHTML = `<div class="doc-latest-title">更新日志读取失败</div><div class="doc-latest-desc">${escDoc(m)}</div>`;
      }
      if (docChangelogEl) docChangelogEl.innerHTML = `<div class="empty-line">更新日志读取失败：${escDoc(m)}</div>`;
    };
    const syncDocChangelogFromIterCache = (projectOverride) => {
      const p = String(projectOverride || activeDocProject() || "").trim() || defaultProject;
      let items = [];
      if (iterProjectForCache === p) items = Array.isArray(iterItemsCache) ? iterItemsCache.slice() : [];
      else if (!iterProjectForCache || iterProjectForCache === "__all__")
        items = (Array.isArray(iterItemsCache) ? iterItemsCache : []).filter((x) => normProject(x && x.project ? x.project : "") === p);
      renderDocChangelog(items, p);
    };

    const loadIterations = async (opts = {}) => {
      const hasProject = !!(opts && Object.prototype.hasOwnProperty.call(opts, "project"));
      let project = hasProject ? String(opts.project || "").trim() : (selectedProject !== "__all__" ? selectedProject : "");
      if (project === "__all__") project = "";
      const projectKey = project ? project : "__all__";
      const render = opts.render !== false;
      const syncDoc = !!opts.syncDoc;
      try {
        const projectQuery = project ? `&project=${encodeURIComponent(project)}` : "";
        const res = await fetch(`/api/iterations?t=${Date.now()}${projectQuery}`, { cache: "no-store" });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
        const data = payload.data || {};
        const items = Array.isArray(data.items) ? data.items : [];

        iterItemsCache = items;
        iterProjectForCache = projectKey;

        if (syncDoc || activeTabId === "doc") syncDocChangelogFromIterCache(activeDocProject());

        if (render) {
          const ver = `${data.updatedAt || ""}:${items.length}:${projectKey}`;
          if (ver !== iterVersion) {
            renderIterations(items);
            iterVersion = ver;
          }
          setIterState(true, "监听中");
        }
      } catch (e) {
        const msg = e && e.message ? e.message : String(e || "unknown");
        if (render) setIterState(false, `读取失败: ${msg}`);
        if (syncDoc || activeTabId === "doc") setDocChangelogError(msg);
      }
    };
    const stopIterations = () => {
      if (iterTimer) clearInterval(iterTimer);
      iterTimer = null;
      iterTimerSig = "";
    };
    const startIterations = (intervalMs = 1500, opts = {}) => {
      const ms = Math.max(500, Number(intervalMs) || 1500);
      const sig = JSON.stringify({ ms, p: opts && typeof opts.project === "string" ? String(opts.project || "") : "", r: opts.render !== false, d: !!opts.syncDoc });
      if (iterTimer && iterTimerSig === sig) return;
      stopIterations();
      iterTimerSig = sig;
      iterTimer = setInterval(() => loadIterations(opts), ms);
      loadIterations(opts);
    };
    const ensureDocChangelogForProject = async (project, force = false) => {
      const p = String(project || activeDocProject() || "").trim() || defaultProject;
      const cacheOk = iterProjectForCache === p || !iterProjectForCache || iterProjectForCache === "__all__";
      if (!cacheOk || force) {
        await loadIterations({ project: p, render: false, syncDoc: true });
        return;
      }
      syncDocChangelogFromIterCache(p);
    };
    const toNum = (v, fallback) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    };

    const sortItems = (items) =>
      (Array.isArray(items) ? items : [])
        .map((item, idx) => ({ item, idx }))
        .sort((a, b) => {
          const oa = toNum(a.item.order, 100000 + a.idx);
          const ob = toNum(b.item.order, 100000 + b.idx);
          if (oa !== ob) return oa - ob;
          const pa = PRI_RANK[a.item.priority] ?? 9;
          const pb = PRI_RANK[b.item.priority] ?? 9;
          if (pa !== pb) return pa - pb;
          return String(a.item.createdAt || "").localeCompare(String(b.item.createdAt || ""));
        })
        .map((x) => x.item);

    const groupedItems = (items) => {
      const map = { todo: [], doing: [], done_requested: [], done: [], rollback_requested: [] };
      for (const x of sortItems(items)) {
        const st = String(x.status || "todo");
        if (!map[st]) map[st] = [];
        map[st].push(x);
      }
      return map;
    };

    const resolveDragAction = (fromStatus, toStatus) => {
      if (fromStatus === toStatus) return null;
      if (fromStatus === "todo" && toStatus === "doing") return { action: "set_status", extra: { status: "doing" } };
      if (fromStatus === "doing" && toStatus === "done_requested") return { action: "request_done", extra: {} };
      if (fromStatus === "done" && toStatus === "rollback_requested") return { action: "request_rollback", extra: {} };
      if (fromStatus === "rollback_requested" && toStatus === "done") return { action: "cancel_rollback_request", extra: {} };
      return undefined;
    };

    const setDropHints = (fromStatus) => {
      const from = String(fromStatus || "").trim();
      document.body.classList.add("drag-mode");
      document.querySelectorAll(".todo-section-body[data-status]").forEach((body) => {
        const to = String(body.getAttribute("data-status") || "").trim();
        const transition = resolveDragAction(from, to);
        const allowed = typeof transition !== "undefined";
        const sec = body.closest(".todo-section");
        body.classList.toggle("drop-allowed", allowed);
        body.classList.toggle("drop-blocked", !allowed);
        if (sec) {
          sec.classList.toggle("drop-allowed", allowed);
          sec.classList.toggle("drop-blocked", !allowed);
        }
      });
    };

    const clearDropHints = () => {
      document.body.classList.remove("drag-mode");
      document.querySelectorAll(".todo-section-body.drop-allowed,.todo-section-body.drop-blocked").forEach((x) => {
        x.classList.remove("drop-allowed", "drop-blocked");
      });
      document.querySelectorAll(".todo-section.drop-allowed,.todo-section.drop-blocked").forEach((x) => {
        x.classList.remove("drop-allowed", "drop-blocked");
      });
    };

    const clearDragState = () => {
      dragState = null;
      document.querySelectorAll(".todo-item.dragging").forEach((x) => x.classList.remove("dragging"));
      document.querySelectorAll(".todo-section-body.drag-over").forEach((x) => x.classList.remove("drag-over"));
      document.querySelectorAll(".todo-drop-marker").forEach((x) => x.remove());
      if (fallbackMouseDragState) {
        if (fallbackMouseDragState.handle && fallbackMouseDragState.pointerId != null) {
          try {
            fallbackMouseDragState.handle.releasePointerCapture(fallbackMouseDragState.pointerId);
          } catch (_) {}
        }
        if (fallbackMouseDragState.moveHandler) {
          document.removeEventListener("pointermove", fallbackMouseDragState.moveHandler);
          document.removeEventListener("mousemove", fallbackMouseDragState.moveHandler);
        }
        if (fallbackMouseDragState.upHandler) {
          document.removeEventListener("mouseup", fallbackMouseDragState.upHandler);
          document.removeEventListener("pointerup", fallbackMouseDragState.upHandler);
        }
        if (fallbackMouseDragState.cancelHandler) {
          document.removeEventListener("pointercancel", fallbackMouseDragState.cancelHandler);
        }
        fallbackMouseDragState = null;
      }
      if (touchDragState) {
        if (touchDragState.holdTimer) clearTimeout(touchDragState.holdTimer);
        touchDragState = null;
      }
      clearDropHints();
    };

    const getBodyFromPoint = (clientX, clientY) => {
      const el = document.elementFromPoint(clientX, clientY);
      return el ? el.closest(".todo-section-body[data-status]") : null;
    };

    const getDropMarker = (body) => {
      let marker = body.querySelector(".todo-drop-marker");
      if (!marker) {
        marker = document.createElement("div");
        marker.className = "todo-drop-marker";
        body.appendChild(marker);
      }
      return marker;
    };

    const clearDropMarker = () => {
      document.querySelectorAll(".todo-drop-marker").forEach((x) => x.remove());
    };

    const updateDropMarker = (body, clientY, dragId) => {
      if (!body) return null;
      clearDropMarker();
      const cards = Array.from(body.querySelectorAll(".todo-item")).filter((el) => el.dataset.id !== dragId);
      const marker = getDropMarker(body);
      const idx = cards.length === 0 ? 0 : getDropIndex(body, clientY, dragId);
      body.querySelectorAll(".empty-line").forEach((el) => el.remove());
      if (!cards.length) {
        body.prepend(marker);
      } else {
        const anchor = cards[idx] || null;
        if (anchor) body.insertBefore(marker, anchor);
        else body.appendChild(marker);
      }
      return idx;
    };

    const resolveDropTargetFromPoint = (clientX, clientY, dragId) => {
      if (!dragState) return null;
      const body = getBodyFromPoint(clientX, clientY);
      if (!body) {
        clearDropMarker();
        return null;
      }
      const toStatus = String(body.getAttribute("data-status") || "").trim();
      const transition = resolveDragAction(dragState.fromStatus, toStatus);
      if (typeof transition === "undefined") {
        clearDropMarker();
        return null;
      }
      const targetIndex = updateDropMarker(body, clientY, dragId);
      if (targetIndex === null) {
        clearDropMarker();
        return null;
      }
      return { body, toStatus, targetIndex };
    };

    const getDropIndex = (body, clientY, dragId) => {
      const cards = Array.from(body.querySelectorAll(".todo-item")).filter((el) => el.dataset.id !== dragId);
      for (let i = 0; i < cards.length; i += 1) {
        const rect = cards[i].getBoundingClientRect();
        if (clientY < rect.top + rect.height / 2) return i;
      }
      return cards.length;
    };

    const createFallbackMouseDrag = (dragHandle, row, item) => {
      const startDrag = (ev, isMouseOnly = false) => {
        if (ev.button !== undefined && ev.button !== 0) return;
        if (ev.shiftKey || ev.metaKey || ev.ctrlKey || ev.altKey) return;
        if (!isMouseOnly && ev.pointerType && ev.pointerType !== "mouse") return;
        const id = String(item.id);
        if (fallbackMouseDragState && fallbackMouseDragState.id === id) return;
        ev.preventDefault();
        ev.stopPropagation();

        clearDragState();

        const fromStatus = String(item.status);
        const moveHandler = (e) => {
          if (!fallbackMouseDragState || fallbackMouseDragState.id !== id) return;
          const state = fallbackMouseDragState;
          state.clientX = e.clientX;
          state.clientY = e.clientY;
          if (!state.hasMoved) {
            const dx = Math.abs(e.clientX - state.startX);
            const dy = Math.abs(e.clientY - state.startY);
            if (dx > MOUSE_DRAG_MOVE_TOLERANCE || dy > MOUSE_DRAG_MOVE_TOLERANCE) {
              state.hasMoved = true;
            }
          }
          if (!state.hasMoved) return;
          if (e.cancelable) e.preventDefault();
          resolveDropTargetFromPoint(e.clientX, e.clientY, id);
        };

        const finishDrag = async (e) => {
          if (!fallbackMouseDragState || fallbackMouseDragState.id !== id) return;
          const state = fallbackMouseDragState;
          state.clientX = e.clientX;
          state.clientY = e.clientY;
          if (state.hasMoved) {
            const to = resolveDropTargetFromPoint(state.clientX, state.clientY, id);
            const targetStatus = to ? to.toStatus : null;
            const targetIndex = to ? to.targetIndex : null;
            clearDragState();
            if (!targetStatus) return;
            try {
              await persistDrop(id, fromStatus, targetStatus, targetIndex);
            } catch (err) {
              setTodoState(false, `拖拽更新失败: ${err.message || err}`);
            }
            return;
          }
          clearDragState();
        };

        const cancelDrag = () => {
          if (!fallbackMouseDragState || fallbackMouseDragState.id !== id) return;
          clearDragState();
        };

        fallbackMouseDragState = {
          id,
          fromStatus,
          handle: dragHandle,
          row,
          pointerId: ev.pointerId != null ? ev.pointerId : null,
          startX: ev.clientX,
          startY: ev.clientY,
          clientX: ev.clientX,
          clientY: ev.clientY,
          active: false,
          hasMoved: false,
          moveHandler,
          upHandler: finishDrag,
          cancelHandler: cancelDrag,
        };

        fallbackMouseDragState.active = true;
        dragState = { id, fromStatus };
        row.classList.add("dragging");
        setDropHints(fromStatus || "");
        resolveDropTargetFromPoint(ev.clientX, ev.clientY, id);

        if (ev.pointerId != null) {
          try {
            dragHandle.setPointerCapture(ev.pointerId);
          } catch (_) {}
        }

        if (window.PointerEvent) {
          document.addEventListener("pointermove", moveHandler);
          document.addEventListener("pointerup", finishDrag);
          document.addEventListener("mousemove", moveHandler);
          document.addEventListener("mouseup", finishDrag);
          document.addEventListener("pointercancel", cancelDrag);
        } else {
          document.addEventListener("mousemove", moveHandler);
          document.addEventListener("mouseup", finishDrag);
        }
      };

      if (window.PointerEvent) {
        dragHandle.addEventListener("pointerdown", startDrag, { passive: false });
        dragHandle.addEventListener("mousedown", (ev) => startDrag(ev, true), { passive: false });
        return;
      }
      dragHandle.addEventListener("mousedown", (ev) => startDrag(ev, true), { passive: false });
    };

    const moveIdToIndex = (ids, id, targetIndex) => {
      const next = ids.filter((x) => x !== id);
      const idx = Math.max(0, Math.min(targetIndex, next.length));
      next.splice(idx, 0, id);
      return next;
    };

    const persistDrop = async (id, fromStatus, toStatus, targetIndex) => {
      const transition = resolveDragAction(fromStatus, toStatus);
      if (typeof transition === "undefined") {
        setTodoState(false, `不支持拖拽: ${fromStatus} -> ${toStatus}`);
        await loadTodos();
        return;
      }
      try {
        let nextStore = null;
        if (transition) {
          nextStore = await apiPost({ action: transition.action, id, ...(transition.extra || {}) });
        }
        const visible = filterItemsByProject((nextStore || todoStore).items || []);
        const groups = groupedItems(visible);
        const targetItems = groups[toStatus] || [];
        const targetIds = moveIdToIndex(targetItems.map((x) => String(x.id)), id, targetIndex);
        nextStore = await apiPost({
          action: "reorder",
          status: toStatus,
          orderedIds: targetIds,
          ...(isAllProject() ? {} : { project: selectedProject }),
        });
        if (fromStatus !== toStatus) {
          const visibleAfter = filterItemsByProject(nextStore.items || []);
          const sourceItems = (groupedItems(visibleAfter)[fromStatus] || []).map((x) => String(x.id));
          nextStore = await apiPost({
            action: "reorder",
            status: fromStatus,
            orderedIds: sourceItems,
            ...(isAllProject() ? {} : { project: selectedProject }),
          });
        }
        applyTodoStore(nextStore);
      } catch (e) {
        setTodoState(false, `拖拽失败: ${e.message || e}`);
        await loadTodos();
      }
    };

    const closeAllTodoMenus = () => {
      document.querySelectorAll(".todo-menu").forEach((menu) => {
        menu.hidden = true;
        const wrap = menu.closest(".menu-wrap");
        const btn = wrap ? wrap.querySelector("[data-action='toggle_menu']") : null;
        if (btn) btn.setAttribute("aria-expanded", "false");
      });
    };

	    const renderTodoRow = (item) => {
	      const row = document.createElement("div");
      const pri = String(item.priority || "P1").toLowerCase();
      row.className = `todo-item pri-${pri}`;
      row.draggable = false;
      row.dataset.id = String(item.id || "");
      row.dataset.status = String(item.status || "todo");
      const textClass = item.status === "done" ? "todo-text done" : "todo-text";
      const rollbackCount = Number(item.rollbackCount || 0);
      const machineBy = String(item.machineBy || "").trim();
      const machineAction = String(item.machineAction || "").trim();
	      const machineAt = String(item.machineAt || "").trim();
	      const claimedBy = String(item.claimedBy || "").trim();
	      const git = item && item.git && typeof item.git === "object" ? item.git : null;
	      const checks = item && item.checks && typeof item.checks === "object" ? item.checks : {};
	      const testsStatus = String((checks && checks.tests) || "unknown").trim() || "unknown";

      let flowButtons = "";
      if (item.status === "todo") {
        flowButtons =
          `<button class="status-btn" data-action="set_status" data-status="doing">开始</button>` +
          ` <button class="icon-btn" type="button" title="复制“开始”命令" data-copy-action="set_status" data-copy-status="doing">⧉</button>`;
      } else if (item.status === "doing") {
        flowButtons =
          `<button class="status-btn" data-action="request_done">申请完成</button>` +
          ` <button class="icon-btn" type="button" title="复制“申请完成”命令" data-copy-action="request_done">⧉</button>`;
      } else if (item.status === "done_requested") {
        flowButtons =
          `<button class="status-btn active" disabled>待机器完成</button>` +
          ` <button class="status-btn" data-action="confirm_done">机器确认完成</button>` +
          ` <button class="icon-btn" type="button" title="复制“机器确认完成”命令" data-copy-action="confirm_done">⧉</button>`;
      } else if (item.status === "rollback_requested") {
        flowButtons =
          `<button class="status-btn active" disabled>待机器回滚</button>` +
          ` <button class="icon-btn" type="button" title="复制“机器确认回滚”命令" data-copy-action="confirm_rollback">⧉</button>`;
      } else if (item.status === "done") {
        flowButtons = `<button class="status-btn active" disabled>已完成</button>`;
      } else {
        flowButtons = `<button class="status-btn active" disabled>${esc(item.status || "unknown")}</button>`;
      }
      if (item.status === "done") {
        flowButtons +=
          ` <button class="status-btn btn-danger" data-action="request_rollback">申请回滚</button>` +
          ` <button class="icon-btn" type="button" title="复制“申请回滚”命令" data-copy-action="request_rollback">⧉</button>`;
      } else if (item.status === "rollback_requested") {
        flowButtons +=
          ` <button class="status-btn" data-action="cancel_rollback_request">撤销回滚</button>` +
          ` <button class="icon-btn" type="button" title="复制“撤销回滚”命令" data-copy-action="cancel_rollback_request">⧉</button>`;
      }
      flowButtons += ` <button class="status-btn" data-action="toggle_details">详情</button>`;
      flowButtons += `
        <span class="menu-wrap">
          <button class="status-btn more-btn" data-action="toggle_menu" aria-haspopup="menu" aria-expanded="false">⋯</button>
	          <div class="todo-menu" role="menu" hidden>
	            <button class="menu-item" type="button" data-menu="capture_git" role="menuitem">更新Git信息</button>
	            <button class="menu-item" type="button" data-menu="copy_pr" role="menuitem">复制PR描述</button>
	            <button class="menu-item" type="button" data-menu="tests_pass" role="menuitem">标记测试: 通过</button>
	            <button class="menu-item" type="button" data-menu="tests_fail" role="menuitem">标记测试: 失败</button>
	            <button class="menu-item" type="button" data-menu="tests_not_run" role="menuitem">标记测试: 未跑</button>
	            <button class="menu-item" type="button" data-menu="tests_unknown" role="menuitem">标记测试: 未知</button>
	            <button class="menu-item" type="button" data-menu="edit_text" role="menuitem">改字</button>
	            <button class="menu-item" type="button" data-menu="set_project" role="menuitem">改项目</button>
	            <button class="menu-item danger" type="button" data-menu="delete" role="menuitem">删除</button>
	          </div>
        </span>
      `;

	      row.innerHTML = `
        <div class="drag-handle" title="拖拽调整/移动状态" aria-label="拖拽卡片" style="background:#e8f1ff;border:2px solid #4c9aff;color:#0052cc;width:26px;min-width:26px;height:26px;line-height:1;border-radius:8px;font-size:18px;display:inline-flex;align-items:center;justify-content:center;pointer-events:auto;font-weight:700;letter-spacing:-3px;padding:0;z-index:2;" >
          <span class="drag-grip" aria-hidden="true">⋮</span>
        </div>
	        <div class="status-bar">${flowButtons}</div>
	          <div class="todo-main">
	          <div class="${textClass}">${esc(item.text)}</div>
	          <div class="todo-meta">
	            <span class="badge ${pri}">${item.priority || "P1"}</span>
	            <span class="badge project">${esc(normProject(item.project))}</span>
	            ${
	              git && (git.branch || git.commitShort || git.commit)
	                ? `<span class="badge git">git:${esc(git.branch || "-")}@${esc((git.commitShort || (git.commit || '').slice(0, 8) || '-'))}${git.dirty ? "*" : ""} (${Number(git.changedCount || 0)})</span>`
	                : ""
	            }
	            <span class="badge tests ${esc(testsStatus)}">tests:${esc(testsStatus)}</span>
	            <span>${item.id}</span>
	            <span>更新时间: ${item.updatedAt || "-"}</span>
	            ${claimedBy ? `<span>执行终端: ${esc(claimedBy)}</span>` : ""}
	            ${rollbackCount > 0 ? `<span>回滚次数: ${rollbackCount}</span>` : ""}
	            ${machineBy ? `<span>机器: ${esc(machineBy)} ${machineAction ? "(" + esc(machineAction) + ")" : ""} ${machineAt ? "@ " + esc(machineAt) : ""}</span>` : ""}
	            ${
	              git && Array.isArray(git.changedFiles) && git.changedFiles.length
	                ? `<span>变更: ${Math.min(git.changedFiles.length, Number(git.changedCount || git.changedFiles.length || 0))} 个文件</span>`
	                : ""
	            }
	          </div>
	        </div>
	      `;
	      if (String(item.id || "") === selectedTodoId) row.classList.add("selected");

      const dragHandle = row.querySelector(".drag-handle");
      if (dragHandle) {
        dragHandle.draggable = false;

        dragHandle.addEventListener(
          "touchstart",
          (e) => {
            if (!e.touches || e.touches.length !== 1) return;
            const touch = e.touches[0];
            if (!touch) return;
            if (touchDragState && touchDragState.holdTimer) clearTimeout(touchDragState.holdTimer);
            touchDragState = {
              id: String(item.id),
              fromStatus: String(item.status),
              startX: touch.clientX,
              startY: touch.clientY,
              clientX: touch.clientX,
              clientY: touch.clientY,
              active: false,
              holdTimer: null,
              row,
            };
            touchDragState.holdTimer = setTimeout(() => {
              if (!touchDragState || touchDragState.id !== String(item.id)) return;
              touchDragState.active = true;
              dragState = { id: String(item.id), fromStatus: String(item.status) };
              touchDragState.row.classList.add("dragging");
              setDropHints(String(item.status || ""));
              resolveDropTargetFromPoint(touchDragState.clientX, touchDragState.clientY, touchDragState.id);
            }, TOUCH_DRAG_HOLD_MS);
          },
          { passive: false },
        );

        dragHandle.addEventListener(
          "touchmove",
          (e) => {
            if (!touchDragState || touchDragState.id !== String(item.id)) return;
            if (!e.touches || !e.touches.length) return;
            const touch = e.touches[0];
            if (!touch) return;

            touchDragState.clientX = touch.clientX;
            touchDragState.clientY = touch.clientY;

            if (!touchDragState.active) {
              const dx = Math.abs(touch.clientX - touchDragState.startX);
              const dy = Math.abs(touch.clientY - touchDragState.startY);
              if (dx > TOUCH_DRAG_MOVE_TOLERANCE || dy > TOUCH_DRAG_MOVE_TOLERANCE) {
                if (touchDragState.holdTimer) {
                  clearTimeout(touchDragState.holdTimer);
                  touchDragState.holdTimer = null;
                }
              }
              return;
            }

            if (e.cancelable) e.preventDefault();
            resolveDropTargetFromPoint(touch.clientX, touch.clientY, touchDragState.id);
          },
          { passive: false },
        );

        dragHandle.addEventListener("touchend", async (e) => {
          if (!touchDragState || touchDragState.id !== String(item.id)) return;
          const touch = e.changedTouches && e.changedTouches[0] ? e.changedTouches[0] : null;
          if (touch) {
            touchDragState.clientX = touch.clientX;
            touchDragState.clientY = touch.clientY;
          }
          if (touchDragState.holdTimer) {
            clearTimeout(touchDragState.holdTimer);
            touchDragState.holdTimer = null;
          }

          if (!touchDragState.active) {
            touchDragState = null;
            return;
          }

          if (e.cancelable) e.preventDefault();
          const to = resolveDropTargetFromPoint(touchDragState.clientX, touchDragState.clientY, touchDragState.id);
          const id = touchDragState.id;
          const fromStatus = touchDragState.fromStatus;
          clearDragState();
          if (!to) return;
          await persistDrop(id, fromStatus, to.toStatus, to.targetIndex);
        });

        dragHandle.addEventListener("touchcancel", () => {
          if (!touchDragState || touchDragState.id !== String(item.id)) return;
          if (touchDragState.holdTimer) {
            clearTimeout(touchDragState.holdTimer);
            touchDragState.holdTimer = null;
          }
          clearDragState();
        });

        createFallbackMouseDrag(dragHandle, row, item);
      }
	      row.addEventListener("mousedown", (e) => {
	        const target = e.target;
	        if (!target || !target.closest) return;
	        if (target.closest("button, a, input, select, textarea, .todo-menu, .drag-handle")) return;
	        selectTodoRow(row);
	      });

      row.querySelectorAll("[data-action][data-status]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const status = btn.getAttribute("data-status");
          try {
            const next = await apiPost({ action: "set_status", id: item.id, status });
            applyTodoStore(next);
          } catch (e) {
            setTodoState(false, `任务更新失败: ${e.message || e}`);
          }
        });
      });

      row.querySelectorAll("[data-action]:not([data-status])").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const action = btn.getAttribute("data-action");
          if (!action) return;
          if (action === "toggle_details") {
            row.classList.toggle("expanded");
            return;
          }
          if (action === "toggle_menu") {
            const wrap = btn.closest(".menu-wrap");
            const menu = wrap ? wrap.querySelector(".todo-menu") : null;
            if (!menu) return;
            const isOpen = !menu.hidden;
            closeAllTodoMenus();
            if (!isOpen) {
              menu.hidden = false;
              btn.setAttribute("aria-expanded", "true");
            }
            return;
          }
          if (action === "confirm_done") {
            openConfirmDoneModal(item);
            return;
          }
          const ok =
            action === "request_rollback"
              ? window.confirm("确认申请回滚？任务将进入“待机器回滚”。")
              : action === "cancel_rollback_request"
                ? window.confirm("确认撤销回滚申请？任务将回到“已完成”。")
                : action === "request_done"
                  ? window.confirm("确认申请完成？任务将进入“待机器完成”。")
                  : true;
          if (!ok) return;
          try {
            const next = await apiPost({ action, id: item.id });
            applyTodoStore(next);
          } catch (e) {
            setTodoState(false, `操作失败: ${e.message || e}`);
          }
        });
      });
      row.querySelectorAll("[data-copy-action]").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const a = String(btn.getAttribute("data-copy-action") || "").trim();
          if (!a) return;
          const params = { id: item.id };
          if (a === "set_status") params.status = String(btn.getAttribute("data-copy-status") || "doing").trim() || "doing";
          await copyCmd(a, params);
        });
      });
      const menu = row.querySelector(".todo-menu");
      const menuBtn = row.querySelector("[data-action='toggle_menu']");
      if (menu && menuBtn) {
        menuBtn.addEventListener("click", (e) => e.stopPropagation());
        menu.addEventListener("click", (e) => e.stopPropagation());
      }
	      row.querySelectorAll("[data-menu]").forEach((m) => {
	        m.addEventListener("click", async (e) => {
          e.stopPropagation();
          closeAllTodoMenus();
	          const kind = m.getAttribute("data-menu");
	          try {
	            const buildPrDesc = () => {
	              const proj = normProject(item.project);
	              const g = item && item.git && typeof item.git === "object" ? item.git : null;
	              const c = item && item.checks && typeof item.checks === "object" ? item.checks : {};
	              const tests = String((c && c.tests) || "unknown").trim() || "unknown";
	              const head = g ? `${g.branch || '-'}@${(g.commitShort || (g.commit || '').slice(0, 8) || '-')}${g.dirty ? '*' : ''}` : "-";
	              const files = g && Array.isArray(g.changedFiles) ? g.changedFiles.slice(0, 30) : [];
	              const lines = [];
	              lines.push(`# ${item.text || item.id}`);
	              lines.push("");
	              lines.push(`- Task: ${item.id}`);
	              lines.push(`- Project: ${proj}`);
	              lines.push(`- Git: ${head}`);
	              lines.push("");
	              lines.push("## Summary");
	              lines.push(`- ${item.text || item.id}`);
	              lines.push("");
	              lines.push("## Changes");
	              if (files.length) {
	                for (const f of files) lines.push(`- ${f}`);
	                if (g && Number(g.changedCount || 0) > files.length) lines.push(`- ... (${Number(g.changedCount || 0) - files.length} more)`);
	              } else {
	                lines.push("- (no captured git snapshot yet)");
	              }
	              lines.push("");
	              lines.push("## Test Plan");
	              lines.push(`- tests: ${tests}`);
	              lines.push("");
	              return lines.join("\\n");
	            };
	            if (kind === "edit_text") {
	              const v = window.prompt("编辑任务内容", item.text || "");
	              if (!v || !v.trim()) return;
	              const next = await apiPost({ action: "update_text", id: item.id, text: v.trim() });
	              applyTodoStore(next);
	              return;
	            }
	            if (kind === "set_project") {
	              const v = window.prompt("修改任务所属项目", normProject(item.project));
	              if (!v || !v.trim()) return;
	              const next = await apiPost({ action: "set_project", id: item.id, project: v.trim() });
	              applyTodoStore(next);
	              return;
	            }
	            if (kind === "capture_git") {
	              const next = await apiPost({ action: "capture_git", id: item.id });
	              applyTodoStore(next);
	              setTodoState(true, "已更新Git信息");
	              return;
	            }
	            if (kind === "copy_pr") {
	              const text = buildPrDesc();
	              try {
	                await navigator.clipboard.writeText(text);
	                setTodoState(true, "已复制PR描述");
	              } catch (_) {
	                window.prompt("复制失败，请手动复制：", text);
	              }
	              return;
	            }
	            if (kind === "tests_pass" || kind === "tests_fail" || kind === "tests_not_run" || kind === "tests_unknown") {
	              const v =
	                kind === "tests_pass"
	                  ? "pass"
	                  : kind === "tests_fail"
	                    ? "fail"
	                    : kind === "tests_not_run"
	                      ? "not_run"
	                      : "unknown";
	              const next = await apiPost({ action: "set_check", id: item.id, key: "tests", value: v });
	              applyTodoStore(next);
	              return;
	            }
	            if (kind === "delete") {
	              const ok = window.confirm("确认删除该任务？");
	              if (!ok) return;
	              const next = await apiPost({ action: "delete", id: item.id });
              applyTodoStore(next);
              return;
            }
          } catch (err) {
            setTodoState(false, `操作失败: ${(err && err.message) || err}`);
          }
        });
      });
      return row;
    };

    const renderSection = (title, tag, list) => {
      const sec = document.createElement("div");
      sec.className = "todo-section";
      sec.innerHTML = `
        <div class="todo-section-head">
          <span>${title}</span>
          <span>${list.length} 项</span>
        </div>
        <div class="todo-section-body" data-status="${tag}"></div>
      `;
      const body = sec.querySelector(".todo-section-body");

      body.addEventListener("dragover", (e) => {
        if (!dragState) return;
        const transition = resolveDragAction(dragState.fromStatus, tag);
        if (typeof transition === "undefined") {
          clearDropMarker();
          return;
        }
        e.preventDefault();
        body.classList.add("drag-over");
        updateDropMarker(body, e.clientY, dragState.id);
      });

      body.addEventListener("dragleave", (e) => {
        if (!body.contains(e.relatedTarget)) {
          body.classList.remove("drag-over");
          clearDropMarker();
        }
      });

      body.addEventListener("drop", async (e) => {
        if (!dragState) return;
        e.preventDefault();
        body.classList.remove("drag-over");
        const id = dragState.id;
        const fromStatus = dragState.fromStatus;
        const toStatus = tag;
        const to = resolveDropTargetFromPoint(e.clientX, e.clientY, id);
        clearDragState();
        if (!to || to.toStatus !== toStatus) return;
        await persistDrop(id, fromStatus, toStatus, to.targetIndex);
      });

      if (!list.length) {
        const empty = document.createElement("div");
        empty.className = "empty-line";
        empty.textContent = "暂无";
        body.appendChild(empty);
        return sec;
      }
      for (const item of list) body.appendChild(renderTodoRow(item));
      return sec;
    };

    const renderTodos = (store) => {
      syncCurrentProjectLabel();
      const allItems = Array.isArray(store.items) ? store.items.slice() : [];
      const items = filterItemsBySearch(filterItemsByProject(allItems));
      let todoCount = 0;
      let doingCount = 0;
      let doneReqCount = 0;
      let rollbackReqCount = 0;
      let doneCount = 0;
      for (const x of items) {
        if (x.status === "doing") doingCount += 1;
        else if (x.status === "done_requested") doneReqCount += 1;
        else if (x.status === "rollback_requested") rollbackReqCount += 1;
        else if (x.status === "done") doneCount += 1;
        else todoCount += 1;
      }
      countTodoEl.textContent = String(todoCount);
      countDoingEl.textContent = String(doingCount);
      countDoneReqEl.textContent = String(doneReqCount);
      countRollbackReqEl.textContent = String(rollbackReqCount);
      countDoneEl.textContent = String(doneCount);

      const groups = groupedItems(items);
      todoListEl.innerHTML = "";
      const visibleCols = BOARD_VIEW_COLUMNS[boardView] || BOARD_VIEW_COLUMNS.execution;
      for (const tag of visibleCols) {
        const col = STATUS_COLUMNS.find((x) => x.tag === tag);
        if (!col) continue;
        todoListEl.appendChild(renderSection(col.title, col.tag, groups[col.tag] || []));
      }
    };

	    const applyTodoStore = (store) => {
	      todoStore = store || { items: [] };
      applyFeatureFlags(todoStore && todoStore.featureFlags ? todoStore.featureFlags : null);
      applyUiPrefsOnce(todoStore && todoStore.uiPrefs ? todoStore.uiPrefs : null);
      if (projectTabsFallbackMode && projectFilterWrapEl) setProjectNavFallback(false);
	      syncProjectSelectors(todoStore);
	      renderAgents(todoStore);
		      const ver = `${todoStore.updatedAt || ""}:${(todoStore.items || []).length}:${todoStore.iterUpdatedAt || ""}`;
		      todoVersion = ver;
	      renderTodos(todoStore);
	      // 重新渲染后尽量保留选中项；如果已不可见则清空。
		      if (selectedTodoId && !document.querySelector(`.todo-item[data-id="${selectedTodoId}"]`)) clearSelectedTodo();
		      syncDocProjectLabel();
		      syncDocHint();
		      setTodoState(true, "已同步");
		      if (cmdModalEl && cmdModalEl.classList.contains("show")) renderCmdPanels();
		    };

    const loadTodos = async () => {
      try {
        const res = await fetch(`/api/todos?t=${Date.now()}`, { cache: "no-store" });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
        const store = payload.data || { items: [] };
        if (Array.isArray(payload.projects)) store.projectCatalog = payload.projects;
        if (payload.defaultProject) store.defaultProject = payload.defaultProject;
        if (payload.iterLatestByProject && typeof payload.iterLatestByProject === "object") store.iterLatestByProject = payload.iterLatestByProject;
        if (payload.iterUpdatedAt) store.iterUpdatedAt = String(payload.iterUpdatedAt || "");
        if (payload.uiPrefs && typeof payload.uiPrefs === "object") store.uiPrefs = payload.uiPrefs;
        if (payload.featureFlags && typeof payload.featureFlags === "object") store.featureFlags = payload.featureFlags;
        const payloadAgents = Array.isArray(payload.agents) ? payload.agents : [];
        store.agents = normalizeAgentsFromStore(store, payloadAgents);
	        const ver = `${store.updatedAt || ""}:${(store.items || []).length}:${store.iterUpdatedAt || ""}`;
        todoLoadFailCount = 0;
	        if (ver !== todoVersion) applyTodoStore(store);
	        else setTodoState(true, "监听中");
      } catch (e) {
        todoLoadFailCount += 1;
        if (todoLoadFailCount >= 2) setProjectNavFallback(true, "接口失败，已降级");
        setTodoState(false, `读取失败: ${e.message || e}`);
      }
    };

    const stopTodos = () => {
      if (todoTimer) clearInterval(todoTimer);
      todoTimer = null;
    };
    const startTodos = (intervalMs = 1500) => {
      const ms = Math.max(500, Number(intervalMs) || 1500);
      todoIntervalMs = ms;
      if (todoTimer) return;
      todoTimer = setInterval(loadTodos, ms);
      loadTodos();
    };
    const ensureTodoInterval = (intervalMs) => {
      const ms = Math.max(500, Number(intervalMs) || 1500);
      if (todoTimer && todoIntervalMs === ms) return;
      stopTodos();
      startTodos(ms);
    };

	    const renderServices = (payload) => {
	      if (!svcGridEl) return;
	      const data = payload && payload.data && typeof payload.data === "object" ? payload.data : {};
	      const groups = Array.isArray(data.groups) ? data.groups : [];
	      const out = [];
	      const isAll = selectedProject === "__all__";
	      const visibleGroups = isAll ? groups : groups.filter((g) => String(g.project || "") === activeDocProject());
	      if (!visibleGroups.length) {
	        svcGridEl.innerHTML = `<div class="tiny">当前项目暂无服务清单。可创建 <span class="mono">docs/pm-services.json</span> 自定义。</div>`;
	        return;
	      }
	      for (const g of visibleGroups) {
	        const proj = String(g.project || "").trim() || "-";
	        const src = String(g.source || "").trim() || "default";
	        const path = String(g.path || "").trim();
	        const services = Array.isArray(g.services) ? g.services : [];
	        const up = services.filter((s) => s && s.status === "up").length;
	        const down = services.filter((s) => s && (s.status === "down")).length;
	        const loaded = services.filter((s) => s && s.status === "loaded").length;
	        const head = `
	          <div class="svc-group-head">
	            <span>${esc(proj)}</span>
	            <span class="svc-group-meta">
	              <span class="svc-status up">UP ${up}</span>
	              <span class="svc-status loaded">LOADED ${loaded}</span>
	              <span class="svc-status down">DOWN ${down}</span>
	              <span class="badge">${esc(src)}</span>
	              ${path ? `<span class="tiny mono">${esc(path)}</span>` : ""}
	            </span>
	          </div>
	        `;
	        const itemsHtml = services.length
	          ? services
	              .map((s) => {
	                const st = String(s.status || "down");
	                const name = String(s.name || s.id || "").trim() || "-";
	                const kind = String(s.kind || "").trim();
	                const label = String(s.label || "").trim();
	                const pid = Number(s.pid || 0) || 0;
	                const ports = Array.isArray(s.ports) ? s.ports : [];
	                const exp = Array.isArray(s.expectedPorts) ? s.expectedPorts : [];
	                const detail = String(s.detail || "").trim();
	                const checkedAt = String(s.checkedAt || "").trim();
	                const stdoutPath = String(s.stdoutPath || "").trim();
	                const stderrPath = String(s.stderrPath || "").trim();
	                const openUrls = Array.isArray(s.openUrls) ? s.openUrls : [];
	                const kv = [];
	                if (kind === "launchd" && label) kv.push(`label=${label}`);
	                if (pid) kv.push(`pid=${pid}`);
	                if (ports && ports.length) kv.push(`ports=${ports.join(",")}`);
	                if (exp && exp.length) kv.push(`expected=${exp.join(",")}`);
	                if (checkedAt) kv.push(`checked=${checkedAt}`);
	                if (detail) kv.push(`detail=${detail}`);
	                const links = openUrls
	                  .map((u) => `<a class="svc-link" href="${esc(u)}" target="_blank" rel="noreferrer">打开</a>`)
	                  .join("");
	                const actions = [];
	                if (kind === "launchd" && label) {
	                  actions.push(`<button class="status-btn" type="button" data-svc-action="kickstart" data-svc-label="${esc(label)}">重启</button>`);
	                  actions.push(`<button class="status-btn" type="button" data-svc-action="copy_restart" data-svc-label="${esc(label)}">复制重启命令</button>`);
	                }
	                if (stdoutPath || stderrPath) {
	                  actions.push(
	                    `<button class="status-btn" type="button" data-svc-action="copy_logs" data-svc-out="${esc(stdoutPath)}" data-svc-err="${esc(stderrPath)}">复制日志命令</button>`
	                  );
	                }
	                return `
	                  <div class="svc-item">
	                    <div class="svc-item-top">
	                      <div class="svc-name">${esc(name)}</div>
	                      <div class="svc-right">
	                        <span class="svc-status ${esc(st)}">${esc(st.toUpperCase())}</span>
	                      </div>
	                    </div>
	                    <div class="svc-kv">${kv.map((x) => `<span class="mono">${esc(x)}</span>`).join("")}</div>
	                    ${actions.length ? `<div class="svc-links">${actions.join("")}</div>` : ""}
	                    ${links ? `<div class="svc-links">${links}</div>` : ""}
	                  </div>
	                `;
	              })
	              .join("")
	          : `<div class="tiny">（未配置服务）</div>`;
	        out.push(`<div class="svc-group">${head}<div class="svc-items">${itemsHtml}</div></div>`);
	      }
	      svcGridEl.innerHTML = out.join("");
	      // bind action buttons
	      svcGridEl.querySelectorAll("[data-svc-action]").forEach((btn) => {
	        btn.addEventListener("click", async () => {
	          const a = String(btn.getAttribute("data-svc-action") || "").trim();
	          if (!a) return;
	          if (a === "copy_restart") {
	            const label = String(btn.getAttribute("data-svc-label") || "").trim();
	            const cmd = `launchctl kickstart -k gui/$(id -u)/${label}`;
	            await copyText(cmd);
	            setSvcState(true, "已复制命令");
	            return;
	          }
	          if (a === "copy_logs") {
	            const outp = String(btn.getAttribute("data-svc-out") || "").trim();
	            const errp = String(btn.getAttribute("data-svc-err") || "").trim();
	            const lines = [];
	            if (outp) lines.push(`tail -n 200 ${shSingle(outp)}`);
	            if (errp) lines.push(`tail -n 200 ${shSingle(errp)}`);
	            const cmd = lines.length ? lines.join("\n") : "(no logs path)";
	            await copyText(cmd);
	            setSvcState(true, "已复制命令");
	            return;
	          }
	          if (a === "kickstart") {
	            const label = String(btn.getAttribute("data-svc-label") || "").trim();
	            const ok = window.confirm(`确认重启服务？\\n${label}`);
	            if (!ok) return;
	            try {
	              const res = await fetch("/api/services", {
	                method: "POST",
	                headers: { "Content-Type": "application/json" },
	                body: JSON.stringify({ action: "kickstart", label }),
	              });
	              const payload = await res.json();
	              if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	              setSvcState(true, "已重启");
	              loadServices();
	            } catch (e) {
	              setSvcState(false, `重启失败: ${e.message || e}`);
	            }
	            return;
	          }
	        });
	      });
	    };

	    const loadServices = async () => {
	      try {
	        const project = selectedProject === "__all__" ? "" : activeDocProject();
	        const res = await fetch(`/api/services?project=${encodeURIComponent(project)}&t=${Date.now()}`, { cache: "no-store" });
	        const payload = await res.json();
	        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	        const ver = String(payload.data && payload.data.checkedAt ? payload.data.checkedAt : "");
	        svcLastAtEl.textContent = ver ? ver : nowText();
	        if (ver && ver === svcVersion) {
	          setSvcState(true, "监听中");
	          return;
	        }
	        svcVersion = ver;
	        renderServices(payload);
	        setSvcState(true, "已同步");
	      } catch (e) {
	        setSvcState(false, `读取失败: ${e.message || e}`);
	      }
	    };

	    const startServices = () => {
	      if (svcTimer) return;
	      svcTimer = setInterval(() => {
	        if (!svcRunning) return;
	        loadServices();
	      }, 3000);
	      loadServices();
	    };

		    const stopServices = () => {
		      if (svcTimer) clearInterval(svcTimer);
		      svcTimer = null;
		    };

		    const syncPolling = (force = false) => {
		      const tab = String(activeTabId || "board").trim() || "board";
		      // Todos: always on, but degrade refresh rate off-board to reduce noise.
		      ensureTodoInterval(tab === "board" ? 1500 : 5000);

		      // Iterations: only needed on timeline tab or doc tab (for changelog).
		      if (tab === "iterations") {
		        const p = selectedProject !== "__all__" ? selectedProject : "";
		        startIterations(1500, { project: p, render: true, syncDoc: false });
		      } else if (tab === "doc") {
		        startIterations(3000, { project: activeDocProject(), render: false, syncDoc: true });
		      } else {
		        stopIterations();
		      }

		      // Doc: only poll when on doc tab and user hasn't paused it.
		      ensureDocTimer(tab === "doc" && docRunning);

		      // Services: only poll when on services tab (and user enabled auto refresh).
		      if (tab === "services") startServices();
		      else stopServices();

		      if (!force) return;
		      if (tab === "iterations") loadIterations({ project: selectedProject !== "__all__" ? selectedProject : "", render: true });
		      if (tab === "doc") ensureDocChangelogForProject(activeDocProject(), true);
		      if (tab === "services") loadServices();
		    };

    const createTodoTask = async ({ text, priority, project }) => {
      const cleanText = String(text || "").trim();
      const cleanPriority = String(priority || "P1").trim() || "P1";
      const cleanProject = String(project || defaultProject).trim() || defaultProject;
      if (!cleanText) return;
      const next = await apiPost({ action: "add", text: cleanText, priority: cleanPriority, project: cleanProject });
      applyTodoStore(next);
    };

    const openQuickAdd = () => {
      quickAddTextEl.value = "";
      quickAddPriorityEl.value = newTodoPriorityEl.value || "P1";
      quickAddProjectEl.value =
        selectedProject !== "__all__" ? selectedProject : (newTodoProjectEl.value || defaultProject || "coach-feishu-suite");
      quickAddModalEl.classList.add("show");
      quickAddModalEl.setAttribute("aria-hidden", "false");
      setTimeout(() => quickAddTextEl.focus(), 0);
    };

    const closeQuickAdd = () => {
      quickAddModalEl.classList.remove("show");
      quickAddModalEl.setAttribute("aria-hidden", "true");
    };

    const testsStatusLabel = (raw) => {
      const v = String(raw || "unknown").trim() || "unknown";
      if (v === "pass") return "通过";
      if (v === "fail") return "失败";
      if (v === "not_run") return "未执行";
      return "未知";
    };

    const buildConfirmDoneTemplate = (item) => {
      const text = String((item && item.text) || "").trim();
      const lower = text.toLowerCase();
      const git = item && item.git && typeof item.git === "object" ? item.git : null;
      const checks = item && item.checks && typeof item.checks === "object" ? item.checks : {};
      const tests = String((checks && checks.tests) || "unknown").trim() || "unknown";
      const changedCount =
        Number((git && git.changedCount) || 0) ||
        (git && Array.isArray(git.changedFiles) ? git.changedFiles.length : 0) ||
        0;

      let doneWhat = text ? `完成任务「${text}」并完成联调。` : "完成任务实现并完成联调。";
      let optimization = "补齐关键分支和异常处理，统一反馈路径，减少重复操作。";
      let impact = `可稳定进入下一流程；变更文件约 ${changedCount} 个；tests: ${testsStatusLabel(tests)}。`;

      if (/弹窗|modal|交互|页面|ui|前端|live-view/.test(lower)) {
        optimization = "补齐交互闭环和状态同步，增加模板预填，减少人工重复填写。";
        impact = `机器确认完成更顺滑且可追溯；变更文件约 ${changedCount} 个；tests: ${testsStatusLabel(tests)}。`;
      } else if (/日志|审计|audit|导出|回放|恢复/.test(lower)) {
        optimization = "补充结构化审计信息和导出能力，强化筛选与回放分析链路。";
        impact = `排障与回溯效率提升；变更文件约 ${changedCount} 个；tests: ${testsStatusLabel(tests)}。`;
      } else if (/接口|api|服务端|后端|server/.test(lower)) {
        optimization = "统一接口入参与容错逻辑，保证线上离线行为一致。";
        impact = `降低重复请求和异常分支风险；变更文件约 ${changedCount} 个；tests: ${testsStatusLabel(tests)}。`;
      }

      return { doneWhat, optimization, impact };
    };

    const openConfirmDoneModal = (item) => {
      if (!confirmDoneModalEl) return;
      confirmDoneTaskId = String((item && item.id) || "").trim();
      const tpl = buildConfirmDoneTemplate(item || {});
      if (confirmDoneWhatEl) confirmDoneWhatEl.value = tpl.doneWhat || "";
      if (confirmDoneOptEl) confirmDoneOptEl.value = tpl.optimization || "";
      if (confirmDoneImpactEl) confirmDoneImpactEl.value = tpl.impact || "";
      confirmDoneModalEl.classList.add("show");
      confirmDoneModalEl.setAttribute("aria-hidden", "false");
      setTimeout(() => {
        if (confirmDoneWhatEl) confirmDoneWhatEl.focus();
      }, 0);
    };

    const closeConfirmDoneModal = () => {
      if (!confirmDoneModalEl) return;
      confirmDoneModalEl.classList.remove("show");
      confirmDoneModalEl.setAttribute("aria-hidden", "true");
      confirmDoneTaskId = "";
    };
    const buildProjectShareLink = () => {
      try {
        const q = new URLSearchParams(location.search || "");
        const project = String(selectedProject || "__all__");
        if (project && project !== "__all__") q.set("project", project);
        else q.delete("project");
        if (projectTabsPage > 0) q.set("pp", String(projectTabsPage));
        else q.delete("pp");
        const scroll = projectTabsEl ? Number(projectTabsEl.scrollLeft || 0) : Number(projectTabsInitialScroll || 0);
        if (scroll > 1) q.set("ps", String(Math.round(scroll)));
        else q.delete("ps");
        const url = `${location.origin}${location.pathname}${q.toString() ? `?${q.toString()}` : ""}${location.hash || ""}`;
        return url;
      } catch (_) {
        return location.href;
      }
    };
    const copyProjectShareLink = async () => {
      const url = buildProjectShareLink();
      const ok = await copyText(url);
      if (ok) {
        setTodoState(true, "已复制当前视图链接");
        announceProjectA11y("已复制当前项目视图链接");
      }
    };
    const buildShortLinkTemplate = () => {
      refreshShortenerPrefsFromInputs();
      const longUrl = buildProjectShareLink();
      const project = String(selectedProject || "__all__");
      const slugBase = `pm-${project === "__all__" ? "all" : project}`
        .toLowerCase()
        .replace(/[^a-z0-9-]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "")
        .slice(0, 36) || "pm-link";
      const title = `CodexPM-${project === "__all__" ? "all" : project}`;
      const commonMeta = {
        project,
        page: Number(projectTabsPage || 0) + 1,
        scroll: Math.round(projectTabsEl ? Number(projectTabsEl.scrollLeft || 0) : 0),
      };
      const genericPayload = {
        long_url: longUrl,
        slug: `${slugBase}-{YYYYMMDD}`,
        title,
        expire_at: "",
        tags: ["codex-pm", "project-nav"],
        meta: commonMeta,
      };
      const endpoint = shortenerEndpoint || "https://short.example.com/api/v1/links";
      const headerLine = `${shortenerHeaderName || "Authorization"}: ${shortenerHeaderTemplate || "Bearer {{TOKEN}}"}`;
      if (shortenerPreset === "internal_shortener_v1") {
        const body = {
          url: longUrl,
          slug: `${slugBase}-{YYYYMMDD}`,
          title,
          expire_at: "",
          tags: ["codex-pm", "project-nav"],
          meta: commonMeta,
        };
        const curl = [
          `curl -sS -X POST ${shSingle(endpoint)}`,
          `  -H 'Content-Type: application/json'`,
          `  -H ${shSingle(headerLine)}`,
          `  -d ${shSingle(JSON.stringify(body))}`,
        ].join(" \\\n");
        return [
          "# short-link template (internal_shortener_v1)",
          `POST ${endpoint}`,
          `Header: ${headerLine}`,
          "",
          JSON.stringify(body, null, 2),
          "",
          "# curl",
          curl,
        ].join("\n");
      }
      const queryTemplate =
        `long_url=${encodeURIComponent(genericPayload.long_url)}` +
        `&slug=${encodeURIComponent(genericPayload.slug)}` +
        `&title=${encodeURIComponent(genericPayload.title)}` +
        `&expire_at=${encodeURIComponent(genericPayload.expire_at)}`;
      return [
        "# short-link template (generic)",
        JSON.stringify(genericPayload, null, 2),
        "",
        "# query template",
        queryTemplate,
      ].join("\n");
    };
    const copyProjectShortLinkTemplate = async () => {
      const text = buildShortLinkTemplate();
      const ok = await copyText(text);
      if (ok) {
        emitUiEvent("project_shortlink_template_copy", {
          project: selectedProject || "__all__",
          page: Number(projectTabsPage || 0) + 1,
        });
        setTodoState(true, "已复制短链参数模板");
        announceProjectA11y("已复制短链参数模板");
      }
    };
    const renderProjectSearchList = (keyword = "") => {
      if (!projectSearchListEl) return;
      const q = String(keyword || "").trim().toLowerCase();
      const all = projectTabItems.filter((x) => x && x.value !== "__all__");
      const filtered = !q
        ? all
        : all.filter((x) => {
            const meta = projectMetaText(x);
            const raw = `${x.value} ${x.group || ""} ${meta}`.toLowerCase();
            return raw.includes(q);
          });
      projectSearchItems = filtered.slice(0, 120);
      if (!projectSearchItems.length) {
        projectSearchListEl.innerHTML = `<div class="project-search-empty">没有匹配项目</div>`;
        projectSearchIndex = 0;
        return;
      }
      if (projectSearchIndex >= projectSearchItems.length) projectSearchIndex = 0;
      projectSearchListEl.innerHTML = projectSearchItems
        .map((item, idx) => {
          const active = idx === projectSearchIndex;
          const mark = item.isFavorite ? "★" : "";
          return `<button class="project-search-item${active ? " active" : ""}" type="button" data-project-search-item="${esc(item.value)}"><span class="project-search-name">${mark ? `<span aria-hidden="true">${mark}</span>` : ""}${esc(item.value)}</span><span class="project-search-meta">${esc(projectMetaText(item))}</span></button>`;
        })
        .join("");
      const activeEl = projectSearchListEl.querySelector(".project-search-item.active");
      if (activeEl && typeof activeEl.scrollIntoView === "function") activeEl.scrollIntoView({ block: "nearest" });
    };
    const openProjectSearch = () => {
      if (featureFlags.projectTabsSearch === false) return;
      if (!projectSearchModalEl || !projectSearchInputEl) return;
      projectSearchOpen = true;
      projectSearchModalEl.classList.add("show");
      projectSearchModalEl.setAttribute("aria-hidden", "false");
      projectSearchIndex = 0;
      renderProjectSearchList("");
      emitUiEvent("project_search_open", { total: projectTabItems.length });
      setTimeout(() => {
        projectSearchInputEl.focus();
        projectSearchInputEl.select();
      }, 0);
    };
    const closeProjectSearch = () => {
      if (!projectSearchModalEl) return;
      projectSearchOpen = false;
      projectSearchModalEl.classList.remove("show");
      projectSearchModalEl.setAttribute("aria-hidden", "true");
    };

    addTodoBtn.addEventListener("click", async () => {
      const text = (newTodoTextEl.value || "").trim();
      const priority = (newTodoPriorityEl.value || "P1").trim();
      const project = (newTodoProjectEl.value || defaultProject).trim() || defaultProject;
      if (!text) return;
      try {
        await createTodoTask({ text, priority, project });
        newTodoTextEl.value = "";
      } catch (e) {
        setTodoState(false, `新增失败: ${e.message || e}`);
      }
    });
    quickAddBtn.addEventListener("click", () => openQuickAdd());
    refreshTodoBtn.addEventListener("click", () => loadTodos());
	    cleanupAgentsBtn.addEventListener("click", async () => {
	      const ok = window.confirm("确认清理离线历史终端？仅保留最近在线终端。");
	      if (!ok) return;
	      try {
	        const next = await apiPost({ action: "cleanup_agents" });
	        applyTodoStore(next);
	        setTodoState(true, "已清理历史终端");
	      } catch (e) {
	        setTodoState(false, `清理失败: ${e.message || e}`);
	      }
	    });
	    if (cmdHelpBtn) cmdHelpBtn.addEventListener("click", () => openCmdModal());
	    if (cmdRefreshBtn) cmdRefreshBtn.addEventListener("click", () => renderCmdPanels());
	    if (cmdCloseBtn) cmdCloseBtn.addEventListener("click", () => closeCmdModal());
	    if (cmdCloseBtn2) cmdCloseBtn2.addEventListener("click", () => closeCmdModal());
	    if (cmdModalEl) {
	      cmdModalEl.addEventListener("click", (e) => {
	        if (e.target === cmdModalEl) closeCmdModal();
	      });
	    }
	    if (cmdTabEls && cmdTabEls.length) {
	      cmdTabEls.forEach((b) => {
	        b.addEventListener("click", () => showCmdTab(b.getAttribute("data-cmd-tab") || "attach"));
	      });
	    }
	    if (cmdModeSelectEl) {
	      cmdModeSelectEl.addEventListener("change", () => {
	        cmdMode = cmdModeNow();
	        try { localStorage.setItem("pm_cmd_mode", cmdMode); } catch (_) {}
	        renderCmdPanels();
	      });
	    }
	    if (cmdMachineSelectEl) {
	      cmdMachineSelectEl.addEventListener("change", () => {
	        cmdMachine = machineNow();
	        try { localStorage.setItem("pm_cmd_machine", cmdMachine); } catch (_) {}
	        renderCmdPanels();
	      });
	    }
	    addIterBtn.addEventListener("click", async () => {
	      const title = (iterTitleEl.value || "").trim();
	      const summary = (iterSummaryEl.value || "").trim();
	      const type = (iterTypeEl.value || "manual").trim();
      const project =
        selectedProject !== "__all__" ? selectedProject : (newTodoProjectEl.value || defaultProject || "coach-feishu-suite").trim();
      if (!title) return;
      try {
        const res = await fetch("/api/todos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "add_iteration",
            project,
            type,
            title,
            summary,
            source: "manual",
          }),
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
        iterTitleEl.value = "";
        iterSummaryEl.value = "";
        await Promise.all([loadIterations(), loadDoc()]);
        setIterState(true, "已写入");
      } catch (e) {
        setIterState(false, `写入失败: ${e.message || e}`);
      }
    });
    refreshIterBtn.addEventListener("click", () => loadIterations());
    const jumpToIterDate = (date) => {
      const d = String(date || "").trim();
      if (!d) return;
      const calKey = `pm_iter_date_${selectedProject || ""}`;
      try { localStorage.setItem(calKey, d); } catch (_) {}
      if (iterCalStripEl) {
        iterCalStripEl.querySelectorAll("[data-iter-date]").forEach((el) => {
          el.classList.toggle("active", el.getAttribute("data-iter-date") === d);
        });
      }
      const dayEl = iterTimelineEl.querySelector(`[data-iter-day="${d}"]`);
      if (dayEl) {
        const top = dayEl.offsetTop - 6;
        iterTimelineEl.scrollTop = Math.max(0, top);
      }
    };
    if (iterCalStripEl) {
      iterCalStripEl.addEventListener("click", (e) => {
        const btn = e.target && e.target.closest ? e.target.closest("[data-iter-date]") : null;
        if (!btn) return;
        const date = btn.getAttribute("data-iter-date") || "";
        jumpToIterDate(date);
      });
    }
    if (iterCalPrevBtn && iterCalStripEl) {
      iterCalPrevBtn.addEventListener("click", () => {
        iterCalStripEl.scrollLeft = Math.max(0, iterCalStripEl.scrollLeft - 260);
      });
    }
    if (iterCalNextBtn && iterCalStripEl) {
      iterCalNextBtn.addEventListener("click", () => {
        iterCalStripEl.scrollLeft = iterCalStripEl.scrollLeft + 260;
      });
    }
    const selectProjectByValue = (value) => {
      if (!projectFilterEl) return;
      const next = String(value || "__all__").trim() || "__all__";
      projectSwitchStartTs = performance.now();
      if (projectFilterEl.value !== next) projectFilterEl.value = next;
      projectFilterEl.dispatchEvent(new Event("change"));
    };
    const setProjectTabsPage = (nextPage) => {
      const page = Math.max(0, Math.min(projectTabsPageCount - 1, Number(nextPage) || 0));
      if (page === projectTabsPage) return;
      projectTabsPage = page;
      saveProjectTabsPage();
      projectTabsRenderSig = "";
      projectTabsDidRestoreScroll = true;
      projectTabsInitialScroll = 0;
      saveProjectTabsScroll(0);
      emitUiEvent("project_tab_page", { page: projectTabsPage + 1, pages: projectTabsPageCount });
      syncProjectTabsFromSelect();
    };
    if (projectStateShareBtn) {
      projectStateShareBtn.addEventListener("click", () => copyProjectShareLink());
    }
    if (projectStateShortTplBtn) {
      projectStateShortTplBtn.addEventListener("click", () => copyProjectShortLinkTemplate());
    }
    if (projectSearchBtn) {
      projectSearchBtn.addEventListener("click", () => openProjectSearch());
    }
    if (projectSearchCloseBtn) {
      projectSearchCloseBtn.addEventListener("click", () => closeProjectSearch());
    }
    if (projectSearchModalEl) {
      projectSearchModalEl.addEventListener("click", (e) => {
        if (e.target === projectSearchModalEl) closeProjectSearch();
      });
    }
    if (projectSearchInputEl) {
      projectSearchInputEl.addEventListener("input", () => {
        projectSearchIndex = 0;
        renderProjectSearchList(projectSearchInputEl.value || "");
      });
      projectSearchInputEl.addEventListener("keydown", (e) => {
        const key = String(e.key || "");
        if (key === "ArrowDown" || key === "ArrowUp") {
          if (!projectSearchItems.length) return;
          e.preventDefault();
          const dir = key === "ArrowDown" ? 1 : -1;
          projectSearchIndex = (projectSearchIndex + dir + projectSearchItems.length) % projectSearchItems.length;
          renderProjectSearchList(projectSearchInputEl.value || "");
          return;
        }
        if (key === "Enter") {
          if (!projectSearchItems.length) return;
          e.preventDefault();
          const item = projectSearchItems[Math.max(0, Math.min(projectSearchItems.length - 1, projectSearchIndex))];
          if (!item) return;
          emitUiEvent("project_search_select", { project: item.value, from: "keyboard" });
          closeProjectSearch();
          selectProjectByValue(item.value);
          return;
        }
        if (key === "Escape") {
          e.preventDefault();
          closeProjectSearch();
        }
      });
    }
    if (projectSearchListEl) {
      projectSearchListEl.addEventListener("click", (e) => {
        const btn = e.target && e.target.closest ? e.target.closest("[data-project-search-item]") : null;
        if (!btn) return;
        const value = btn.getAttribute("data-project-search-item") || "__all__";
        emitUiEvent("project_search_select", { project: value, from: "mouse" });
        closeProjectSearch();
        selectProjectByValue(value);
      });
    }
    if (projectTabsEl && projectFilterEl && !projectTabsFallbackMode) {
      projectTabsEl.addEventListener("click", (e) => {
        const favBtn = e.target && e.target.closest ? e.target.closest("[data-project-favorite]") : null;
        if (favBtn) {
          e.preventDefault();
          e.stopPropagation();
          const p = String(favBtn.getAttribute("data-project-favorite") || "").trim();
          if (!p) return;
          if (favoriteProjects.has(p)) favoriteProjects.delete(p);
          else favoriteProjects.add(p);
          saveProjectFavorites();
          emitUiEvent("project_favorite_toggle", { project: p, active: favoriteProjects.has(p) ? 1 : 0 });
          projectTabsRenderSig = "";
          syncProjectSelectors(todoStore || { items: [] });
          return;
        }
        const btn = e.target && e.target.closest ? e.target.closest("[data-project-value]") : null;
        if (!btn) return;
        const value = btn.getAttribute("data-project-value") || "__all__";
        selectProjectByValue(value);
      });
      projectTabsEl.addEventListener("keydown", (e) => {
        const key = String(e.key || "");
        if (!["ArrowLeft", "ArrowRight", "Enter", " ", "Home", "End"].includes(key)) return;
        const pills = Array.from(projectTabsEl.querySelectorAll(".project-pill[data-project-value]"));
        if (!pills.length) return;
        const currentEl = e.target && e.target.closest ? e.target.closest(".project-pill[data-project-value]") : null;
        const currentIdx = pills.indexOf(currentEl);
        if (key === "ArrowLeft" || key === "ArrowRight" || key === "Home" || key === "End") {
          e.preventDefault();
          const base = currentIdx >= 0 ? currentIdx : Math.max(0, pills.findIndex((x) => x.classList.contains("active")));
          let nextIdx = base;
          if (key === "Home") nextIdx = 0;
          else if (key === "End") nextIdx = pills.length - 1;
          else {
            const dir = key === "ArrowRight" ? 1 : -1;
            nextIdx = (base + dir + pills.length) % pills.length;
          }
          const next = pills[nextIdx];
          if (next && typeof next.focus === "function") {
            next.focus({ preventScroll: true });
            next.scrollIntoView({ block: "nearest", inline: "nearest" });
          }
          return;
        }
        if (key === "Enter" || key === " ") {
          if (!currentEl) return;
          e.preventDefault();
          const value = currentEl.getAttribute("data-project-value") || "__all__";
          selectProjectByValue(value);
        }
      });
      projectTabsEl.addEventListener("scroll", () => {
        updateProjectTabsViewportState();
        scheduleSaveProjectTabsScroll();
      });
    }
    if (projectTabsPrevBtn && projectTabsEl) {
      projectTabsPrevBtn.addEventListener("click", () => {
        const step = Math.max(220, Math.round((projectTabsEl.clientWidth || 320) * 0.72));
        projectTabsEl.scrollBy({ left: -step, behavior: "smooth" });
        emitUiEvent("project_tab_scroll", { dir: "left", step });
      });
    }
    if (projectTabsNextBtn && projectTabsEl) {
      projectTabsNextBtn.addEventListener("click", () => {
        const step = Math.max(220, Math.round((projectTabsEl.clientWidth || 320) * 0.72));
        projectTabsEl.scrollBy({ left: step, behavior: "smooth" });
        emitUiEvent("project_tab_scroll", { dir: "right", step });
      });
    }
    if (projectTabsPagePrevBtn) {
      projectTabsPagePrevBtn.addEventListener("click", () => setProjectTabsPage(projectTabsPage - 1));
    }
    if (projectTabsPageNextBtn) {
      projectTabsPageNextBtn.addEventListener("click", () => setProjectTabsPage(projectTabsPage + 1));
    }
    syncProjectTabsFromSelect();
    window.addEventListener("resize", () => updateProjectTabsViewportState());
    projectFilterEl.addEventListener("change", () => {
      if (projectSwitchStartTs <= 0) projectSwitchStartTs = performance.now();
      const prev = selectedProject;
      selectedProject = projectFilterEl.value || "__all__";
      saveSelectedProject();
      if (selectedProject !== "__all__") newTodoProjectEl.value = selectedProject;
      syncProjectTabsFromSelect();
      // project filter affects both tasks and agent strip/count
      renderAgents(todoStore);
      renderTodos(todoStore);
      syncPolling(true);
      if (activeTabId === "doc") loadDoc();
      const spend = projectSwitchStartTs > 0 ? Math.max(0, performance.now() - projectSwitchStartTs) : 0;
      if (projectSwitchStartTs > 0) {
        emitUiEvent("project_switch", { from: prev, to: selectedProject, latencyMs: Math.round(spend) });
      }
      projectSwitchStartTs = 0;
      announceProjectA11y(selectedProject === "__all__" ? "已切换到全部项目" : `已切换项目 ${selectedProject}`);
      setTodoState(true, selectedProject === "__all__" ? "显示全部项目" : `当前项目: ${selectedProject}`);
      updateProjectStateUrl();
      scheduleSyncProjectPrefs();
    });
    newTodoTextEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addTodoBtn.click();
    });
    iterTitleEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addIterBtn.click();
    });
    quickAddSubmitBtn.addEventListener("click", async () => {
      const text = (quickAddTextEl.value || "").trim();
      const priority = (quickAddPriorityEl.value || "P1").trim();
      const project = (quickAddProjectEl.value || defaultProject).trim() || defaultProject;
      if (!text) return;
      try {
        await createTodoTask({ text, priority, project });
        closeQuickAdd();
      } catch (e) {
        setTodoState(false, `新增失败: ${e.message || e}`);
      }
    });
    quickAddCloseBtn.addEventListener("click", () => closeQuickAdd());
    quickAddCancelBtn.addEventListener("click", () => closeQuickAdd());
    quickAddModalEl.addEventListener("click", (e) => {
      if (e.target === quickAddModalEl) closeQuickAdd();
    });
    if (confirmDoneCloseBtn) confirmDoneCloseBtn.addEventListener("click", () => closeConfirmDoneModal());
    if (confirmDoneCancelBtn) confirmDoneCancelBtn.addEventListener("click", () => closeConfirmDoneModal());
    if (confirmDoneModalEl) {
      confirmDoneModalEl.addEventListener("click", (e) => {
        if (e.target === confirmDoneModalEl) closeConfirmDoneModal();
      });
    }
    if (confirmDoneSubmitBtn) {
      confirmDoneSubmitBtn.addEventListener("click", async () => {
        const id = String(confirmDoneTaskId || "").trim();
        if (!id) return closeConfirmDoneModal();
        const doneWhat = String((confirmDoneWhatEl && confirmDoneWhatEl.value) || "").trim();
        const optimization = String((confirmDoneOptEl && confirmDoneOptEl.value) || "").trim();
        const impact = String((confirmDoneImpactEl && confirmDoneImpactEl.value) || "").trim();
        try {
          const next = await apiPost({
            action: "confirm_done",
            id,
            machineBy: machineNow(),
            doneWhat,
            optimization,
            impact,
          });
          applyTodoStore(next);
          closeConfirmDoneModal();
          setTodoState(true, `已机器确认完成: ${id}`);
        } catch (e) {
          setTodoState(false, `机器确认完成失败: ${e.message || e}`);
        }
      });
    }
	    window.addEventListener("keydown", (e) => {
	      const key = String(e.key || "").toLowerCase();
	      const meta = e.metaKey || e.ctrlKey;
      if (meta && key === "k" && featureFlags.projectTabsSearch !== false) {
        e.preventDefault();
        openProjectSearch();
        return;
      }
		      if (e.key === "Escape") closeAllTodoMenus();
		      if (e.key === "Escape") clearSelectedTodo();
		      if (e.key === "Escape" && projectSearchOpen) {
		        closeProjectSearch();
		        return;
		      }
		      if (e.key === "Escape" && quickAddModalEl.classList.contains("show")) {
		        closeQuickAdd();
		        return;
		      }
		      if (e.key === "Escape" && cmdModalEl && cmdModalEl.classList.contains("show")) {
		        closeCmdModal();
		        return;
		      }
		      if (e.key === "Escape" && confirmDoneModalEl && confirmDoneModalEl.classList.contains("show")) {
		        closeConfirmDoneModal();
		        return;
		      }
		      // 键盘流：避免干扰输入框/富文本编辑器/弹窗。
		      const ae = document.activeElement;
		      const tag = ae && ae.tagName ? String(ae.tagName).toLowerCase() : "";
		      const typing =
		        (tag === "input" || tag === "textarea" || tag === "select") ||
		        (ae && ae.isContentEditable) ||
            projectSearchOpen ||
		        (quickAddModalEl.classList.contains("show")) ||
		        (confirmDoneModalEl && confirmDoneModalEl.classList.contains("show")) ||
		        (cmdModalEl && cmdModalEl.classList.contains("show"));
	      if (typing) return;

	      // 全局快捷键
	      if (key === "/") {
	        e.preventDefault();
	        todoSearchEl.focus();
	        todoSearchEl.select();
	        return;
	      }
	      if (key === "n") {
	        e.preventDefault();
	        openQuickAdd();
	        return;
	      }
	      if (key === "j") {
	        e.preventDefault();
	        selectNextTodo(1);
	        return;
	      }
	      if (key === "k") {
	        e.preventDefault();
	        selectNextTodo(-1);
	        return;
	      }
	      if (key === "?") {
	        e.preventDefault();
	        window.alert(
	          [
	            "看板快捷键：",
	            "/  聚焦搜索",
            "⌘/Ctrl + K  项目快速切换",
	            "n  快速添加任务",
	            "j/k  选择下一条/上一条任务",
	            "Enter  展开/收起详情",
	            "m  执行“下一步流转”（等价于向前拖拽一次）",
	            "s  开始（todo->doing）",
	            "d  申请完成（doing->待机器完成）",
	            "r  申请回滚（done->待机器回滚） / 撤销回滚（待机器回滚->done）",
	            "e  改字",
	            "p  改项目",
	            ".  打开/关闭 ⋯ 菜单",
	            "Del  删除任务",
	            "Esc  关闭菜单/清空选中",
	          ].join("\\n")
	        );
	        return;
	      }

	      const row = selectedTodoRow();
	      const item = selectedTodoItem();
	      if (!row || !item) return;
	      const status = String(item.status || "");

	      if (e.key === "Enter") {
	        e.preventDefault();
	        row.classList.toggle("expanded");
	        return;
	      }
	      const doApi = async (action, extra = {}) => {
	        try {
	          const next = await apiPost({ action, id: item.id, ...extra });
	          applyTodoStore(next);
	        } catch (err) {
	          setTodoState(false, `操作失败: ${(err && err.message) || err}`);
	        }
	      };
	      if (key === "m") {
	        e.preventDefault();
	        // “下一步”流转：与拖拽规则保持一致
	        if (status === "todo") return doApi("set_status", { status: "doing" });
	        if (status === "doing") {
	          if (!window.confirm("确认申请完成？任务将进入“待机器完成”。")) return;
	          return doApi("request_done");
	        }
	        if (status === "done") {
	          if (!window.confirm("确认申请回滚？任务将进入“待机器回滚”。")) return;
	          return doApi("request_rollback");
	        }
	        if (status === "rollback_requested") {
	          if (!window.confirm("确认撤销回滚申请？任务将回到“已完成”。")) return;
	          return doApi("cancel_rollback_request");
	        }
	        return;
	      }
	      if (key === "s" && status === "todo") {
	        e.preventDefault();
	        return doApi("set_status", { status: "doing" });
	      }
	      if (key === "d" && status === "doing") {
	        e.preventDefault();
	        if (!window.confirm("确认申请完成？任务将进入“待机器完成”。")) return;
	        return doApi("request_done");
	      }
	      if (key === "r") {
	        e.preventDefault();
	        if (status === "done") {
	          if (!window.confirm("确认申请回滚？任务将进入“待机器回滚”。")) return;
	          return doApi("request_rollback");
	        }
	        if (status === "rollback_requested") {
	          if (!window.confirm("确认撤销回滚申请？任务将回到“已完成”。")) return;
	          return doApi("cancel_rollback_request");
	        }
	      }
	      if (key === "e") {
	        e.preventDefault();
	        const v = window.prompt("编辑任务内容", item.text || "");
	        if (!v || !v.trim()) return;
	        return doApi("update_text", { text: v.trim() });
	      }
	      if (key === "p") {
	        e.preventDefault();
	        const v = window.prompt("修改任务所属项目", normProject(item.project));
	        if (!v || !v.trim()) return;
	        return doApi("set_project", { project: v.trim() });
	      }
	      if (key === ".") {
	        e.preventDefault();
	        const wrap = row.querySelector(".menu-wrap");
	        const menu = wrap ? wrap.querySelector(".todo-menu") : null;
	        const btn = wrap ? wrap.querySelector("[data-action='toggle_menu']") : null;
	        if (!menu || !btn) return;
	        const isOpen = !menu.hidden;
	        closeAllTodoMenus();
	        if (!isOpen) {
	          menu.hidden = false;
	          btn.setAttribute("aria-expanded", "true");
	        }
	        return;
	      }
	      if (e.key === "Backspace" || e.key === "Delete") {
	        e.preventDefault();
	        if (!window.confirm("确认删除该任务？")) return;
	        return doApi("delete");
	      }
	    });
    quickAddTextEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") quickAddSubmitBtn.click();
    });
    todoSearchEl.addEventListener("input", () => setSearch(todoSearchEl.value || ""));
    todoSearchEl.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        todoSearchEl.value = "";
        setSearch("");
      }
    });
	    densityBtn.addEventListener("click", () => setDensity(!compactDensity));
	    document.addEventListener("click", () => closeAllTodoMenus());
	    if (telemetryEnabledEl) telemetryEnabledEl.addEventListener("change", () => saveTelemetryConfig());
	    if (telemetryLocalOnlyEl) telemetryLocalOnlyEl.addEventListener("change", () => saveTelemetryConfig());
	    if (telemetryRefreshBtn) telemetryRefreshBtn.addEventListener("click", () => loadTelemetryPreview());
    if (shortenerSaveBtn) shortenerSaveBtn.addEventListener("click", () => saveShortenerConfig());
    if (shortenerPresetEl) shortenerPresetEl.addEventListener("change", () => { refreshShortenerPrefsFromInputs(); syncShortenerControls(); });
    if (shortenerEndpointEl)
      shortenerEndpointEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") saveShortenerConfig();
      });
    if (shortenerHeaderNameEl)
      shortenerHeaderNameEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") saveShortenerConfig();
      });
    if (shortenerHeaderTemplateEl)
      shortenerHeaderTemplateEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") saveShortenerConfig();
      });
    if (ffSaveBtn) ffSaveBtn.addEventListener("click", () => saveFeatureFlagsConfig(false));
    if (ffResetBtn)
      ffResetBtn.addEventListener("click", () => {
        if (!window.confirm("确认恢复默认导航开关？")) return;
        saveFeatureFlagsConfig(true);
      });
    if (ffTabsThresholdEl)
      ffTabsThresholdEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") saveFeatureFlagsConfig(false);
      });
    if (ffTabsPageSizeEl)
      ffTabsPageSizeEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") saveFeatureFlagsConfig(false);
      });
	    if (telemetryClearBtn)
	      telemetryClearBtn.addEventListener("click", async () => {
	        const ok = window.confirm("确认清空本地遥测日志？");
	        if (!ok) return;
	        try {
	          const res = await fetch("/api/telemetry", {
	            method: "POST",
	            headers: { "Content-Type": "application/json" },
	            body: JSON.stringify({ action: "clear" }),
	          });
	          const payload = await res.json();
	          if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	          setCfgState(true, "已清空");
	          await loadTelemetryPreview();
	        } catch (e) {
	          setCfgState(false, `清空失败: ${e.message || e}`);
	        }
	      });

	    if (licenseSaveBtn)
	      licenseSaveBtn.addEventListener("click", () => saveSubscriptionConfig(licenseKeyInputEl ? licenseKeyInputEl.value : ""));
	    if (licenseClearBtn)
	      licenseClearBtn.addEventListener("click", () => {
	        if (licenseKeyInputEl) licenseKeyInputEl.value = "";
	        saveSubscriptionConfig("");
	      });
	    if (licenseKeyInputEl)
	      licenseKeyInputEl.addEventListener("keydown", (e) => {
	        if (e.key === "Enter") saveSubscriptionConfig(licenseKeyInputEl.value || "");
	      });

	    if (actSaveBtn) actSaveBtn.addEventListener("click", () => saveActivationConfig());
	    if (actModeEl) actModeEl.addEventListener("change", () => saveActivationConfig());
	    if (actActivateBtn)
	      actActivateBtn.addEventListener("click", async () => {
	        if (!actModeEl || String(actModeEl.value || "offline") !== "cloud") {
	          if (!window.confirm("当前模式不是云端。是否切换到云端并继续？")) return;
	          if (actModeEl) actModeEl.value = "cloud";
	          await saveActivationConfig();
	        }
	        activateSubscription();
	      });
	    if (actClearBtn)
	      actClearBtn.addEventListener("click", () => {
	        if (!window.confirm("确认清除云端激活信息？")) return;
	        clearActivation();
	      });

    toggleDocBtn.addEventListener("click", () => (docRunning ? stopDoc() : startDoc()));
    reloadDocBtn.addEventListener("click", async () => {
      await loadDoc();
      await ensureDocChangelogForProject(activeDocProject(), true);
    });
    if (copyMdBtn)
      copyMdBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(String(lastDocMarkdown || ""));
          setDocState(true, "已复制Markdown");
        } catch (_) {
          setDocState(false, "复制失败");
        }
      });
    if (copyHtmlBtn)
      copyHtmlBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(docRenderEl ? String(docRenderEl.innerHTML || "") : "");
          setDocState(true, "已复制渲染HTML");
        } catch (_) {
          setDocState(false, "复制失败");
        }
      });
    if (docChangelogRefreshBtn)
      docChangelogRefreshBtn.addEventListener("click", () => ensureDocChangelogForProject(activeDocProject(), true));
    boardSubtabEls.forEach((btn) => {
      btn.addEventListener("click", () => {
        const next = btn.getAttribute("data-board-view") || "execution";
        activateBoardView(next);
      });
    });
	    tabBtnEls.forEach((btn) => {
	      btn.addEventListener("click", () => {
	        const target = btn.getAttribute("data-tab-target") || "board";
	        activateTab(target);
	        syncPolling(true);
	      });
	    });
	    try {
	      activateTab(localStorage.getItem("pm_active_tab") || "board");
	    } catch (_) {
	      activateTab("board");
	    }
	    syncPolling(true);
    try {
      activateBoardView(localStorage.getItem("pm_board_view") || "execution");
    } catch (_) {
      activateBoardView("execution");
    }
    try {
      const dens = localStorage.getItem("pm_board_density") || "normal";
      setDensity(dens === "compact");
    } catch (_) {
      setDensity(false);
    }
    try {
      const q = localStorage.getItem("pm_todo_search") || "";
      todoSearchEl.value = q;
      setSearch(q);
    } catch (_) {
      setSearch("");
    }
	    try {
	      const v = localStorage.getItem("pm_svc_auto") || "1";
	      svcRunning = v !== "0";
	      if (svcAutoEl) svcAutoEl.checked = svcRunning;
	    } catch (_) {}
		    try {
		      // Default: collapse TOC so it doesn't squeeze reading width.
		      const v = localStorage.getItem("pm_doc_toc_collapsed") || "1";
		      setTocCollapsed(v === "1");
		    } catch (_) {
		      setTocCollapsed(false);
		    }
		    docTocToggleBtnMain = document.getElementById("docTocToggleBtnMain");
		    const tocToggle = () => setTocCollapsed(!document.body.classList.contains("toc-collapsed"));
		    if (docTocToggleBtn) docTocToggleBtn.addEventListener("click", tocToggle);
		    if (docTocToggleBtnMain) docTocToggleBtnMain.addEventListener("click", tocToggle);
		    if (suggestRefreshBtn) suggestRefreshBtn.addEventListener("click", () => renderSuggestions());
		    if (suggestClearBtn)
		      suggestClearBtn.addEventListener("click", () => {
	        if (!window.confirm("确认清空当前项目的全部建议？")) return;
	        saveSuggestions([]);
	        renderSuggestions();
	      });

	    const onSelectionMaybeShow = () => {
	      if (suggestModalEl && suggestModalEl.classList.contains("show")) return;
	      if (selBubbleDragging) return;
	      const sel = captureSelection();
	      if (!sel) {
	        // If user pinned the bubble position, keep it visible even when selection is cleared.
	        if (!selBubblePinnedPos) hideSelBubble();
	        return;
	      }
	      lastDocSelection = sel;
	      if (sel.rect) showSelBubble(sel.rect);
	      else hideSelBubble();
	    };
	    if (docRenderEl) {
	      docRenderEl.addEventListener("mouseup", () => setTimeout(onSelectionMaybeShow, 0));
	      docRenderEl.addEventListener("keyup", () => setTimeout(onSelectionMaybeShow, 0));
	    }
	    window.addEventListener("scroll", () => { if (!selBubblePinnedPos) hideSelBubble(); }, { passive: true });
	    window.addEventListener("resize", () => { if (!selBubblePinnedPos) hideSelBubble(); });
	    document.addEventListener("selectionchange", () => setTimeout(onSelectionMaybeShow, 0));
	    // Make selection bubble draggable via handle; persist last position.
	    try { selBubblePinnedPos = loadSelBubblePos(); } catch (_) {}
	    const bubbleGetPos = () => {
	      const left = Number(String(selBubbleEl && selBubbleEl.style ? selBubbleEl.style.left : "0").replace("px", "")) || 0;
	      const top = Number(String(selBubbleEl && selBubbleEl.style ? selBubbleEl.style.top : "0").replace("px", "")) || 0;
	      return { left, top };
	    };
	    const bubbleSetPos = (left, top) => {
	      if (!selBubbleEl) return;
	      const w = selBubbleEl.offsetWidth || 220;
	      const h = selBubbleEl.offsetHeight || 38;
	      const L = clamp(left, 10, window.innerWidth - w - 10);
	      const T = clamp(top, 10, window.innerHeight - h - 10);
	      selBubbleEl.style.left = `${Math.round(L)}px`;
	      selBubbleEl.style.top = `${Math.round(T)}px`;
	    };
	    const bubbleResetPinned = () => {
	      selBubblePinnedPos = null;
	      clearSelBubblePos();
	      if (lastDocSelection && lastDocSelection.rect) showSelBubble(lastDocSelection.rect);
	    };
	    if (selBubbleHandleEl && selBubbleEl) {
	      selBubbleHandleEl.setAttribute("data-drag-ready", "1");
	      selBubbleHandleEl.addEventListener("dblclick", (e) => {
	        e.preventDefault();
	        e.stopPropagation();
	        bubbleResetPinned();
	      });
	      const startDrag = (ev) => {
	        if (ev.button !== undefined && ev.button !== 0) return;
	        if (ev.shiftKey || ev.metaKey || ev.ctrlKey || ev.altKey) return;
	        if (!selBubbleEl || selBubbleEl.hidden) return;
	        ev.preventDefault();
	        ev.stopPropagation();
	        const start = bubbleGetPos();
	        const sx = ev.clientX;
	        const sy = ev.clientY;
	        selBubbleDragging = true;
	        selBubbleEl.classList.add("dragging");
	        const move = (e) => {
	          if (!selBubbleDragging) return;
	          if (e.cancelable) e.preventDefault();
	          bubbleSetPos(start.left + (e.clientX - sx), start.top + (e.clientY - sy));
	        };
	        const end = () => {
	          if (!selBubbleDragging) return;
	          selBubbleDragging = false;
	          selBubbleEl.classList.remove("dragging");
	          const pos = bubbleGetPos();
	          selBubblePinnedPos = { left: pos.left, top: pos.top };
	          saveSelBubblePos(selBubblePinnedPos);
	          window.removeEventListener("pointermove", move);
	          window.removeEventListener("pointerup", end);
	          window.removeEventListener("pointercancel", end);
	          window.removeEventListener("mousemove", move);
	          window.removeEventListener("mouseup", end);
	        };
	        if (window.PointerEvent && ev.pointerId != null && selBubbleHandleEl.setPointerCapture) {
	          try { selBubbleHandleEl.setPointerCapture(ev.pointerId); } catch (_) {}
	        }
	        window.addEventListener("pointermove", move, { passive: false });
	        window.addEventListener("pointerup", end);
	        window.addEventListener("pointercancel", end);
	        window.addEventListener("mousemove", move);
	        window.addEventListener("mouseup", end);
	      };
	      if (window.PointerEvent) selBubbleHandleEl.addEventListener("pointerdown", startDrag, { passive: false });
	      selBubbleHandleEl.addEventListener("mousedown", startDrag, { passive: false });

	      // Fallback: allow dragging by grabbing the bubble body (excluding buttons/links/inputs).
	      const startDragFromBubble = (ev) => {
	        const t = ev && ev.target ? ev.target : null;
	        if (t && t.closest && t.closest("button, a, input, select, textarea")) return;
	        startDrag(ev);
	      };
	      if (window.PointerEvent) selBubbleEl.addEventListener("pointerdown", startDragFromBubble, { passive: false });
	      selBubbleEl.addEventListener("mousedown", startDragFromBubble, { passive: false });

	      // Touch fallback (for browsers without PointerEvent mouse synthesis).
	      selBubbleHandleEl.addEventListener(
	        "touchstart",
	        (ev) => {
	          if (!ev.touches || ev.touches.length !== 1) return;
	          if (!selBubbleEl || selBubbleEl.hidden) return;
	          const t = ev.touches[0];
	          if (!t) return;
	          ev.preventDefault();
	          ev.stopPropagation();
	          const start = bubbleGetPos();
	          const sx = t.clientX;
	          const sy = t.clientY;
	          selBubbleDragging = true;
	          selBubbleEl.classList.add("dragging");
	          const move = (e) => {
	            if (!selBubbleDragging) return;
	            const tt = e.touches && e.touches[0] ? e.touches[0] : null;
	            if (!tt) return;
	            e.preventDefault();
	            bubbleSetPos(start.left + (tt.clientX - sx), start.top + (tt.clientY - sy));
	          };
	          const end = () => {
	            if (!selBubbleDragging) return;
	            selBubbleDragging = false;
	            selBubbleEl.classList.remove("dragging");
	            const pos = bubbleGetPos();
	            selBubblePinnedPos = { left: pos.left, top: pos.top };
	            saveSelBubblePos(selBubblePinnedPos);
	            window.removeEventListener("touchmove", move);
	            window.removeEventListener("touchend", end);
	            window.removeEventListener("touchcancel", end);
	          };
	          window.addEventListener("touchmove", move, { passive: false });
	          window.addEventListener("touchend", end);
	          window.addEventListener("touchcancel", end);
	        },
	        { passive: false }
	      );

	      // Touch fallback on bubble body too (excluding buttons).
	      selBubbleEl.addEventListener(
	        "touchstart",
	        (ev) => {
	          const target = ev && ev.target ? ev.target : null;
	          if (target && target.closest && target.closest("button, a, input, select, textarea")) return;
	          if (!ev.touches || ev.touches.length !== 1) return;
	          if (!selBubbleEl || selBubbleEl.hidden) return;
	          const t = ev.touches[0];
	          if (!t) return;
	          ev.preventDefault();
	          ev.stopPropagation();
	          const start = bubbleGetPos();
	          const sx = t.clientX;
	          const sy = t.clientY;
	          selBubbleDragging = true;
	          selBubbleEl.classList.add("dragging");
	          const move = (e) => {
	            if (!selBubbleDragging) return;
	            const tt = e.touches && e.touches[0] ? e.touches[0] : null;
	            if (!tt) return;
	            e.preventDefault();
	            bubbleSetPos(start.left + (tt.clientX - sx), start.top + (tt.clientY - sy));
	          };
	          const end = () => {
	            if (!selBubbleDragging) return;
	            selBubbleDragging = false;
	            selBubbleEl.classList.remove("dragging");
	            const pos = bubbleGetPos();
	            selBubblePinnedPos = { left: pos.left, top: pos.top };
	            saveSelBubblePos(selBubblePinnedPos);
	            window.removeEventListener("touchmove", move);
	            window.removeEventListener("touchend", end);
	            window.removeEventListener("touchcancel", end);
	          };
	          window.addEventListener("touchmove", move, { passive: false });
	          window.addEventListener("touchend", end);
	          window.addEventListener("touchcancel", end);
	        },
	        { passive: false }
	      );
	    }
	    if (selSuggestBtn) selSuggestBtn.addEventListener("click", () => openSuggestModal(lastDocSelection));
	    if (selCopyBtn)
	      selCopyBtn.addEventListener("click", async () => {
	        const s = lastDocSelection && lastDocSelection.text ? String(lastDocSelection.text) : "";
	        if (!s) return;
	        await copyText(s);
	        setDocState(true, "已复制圈选内容");
	        hideSelBubble();
	      });
	    if (suggestCloseBtn) suggestCloseBtn.addEventListener("click", () => closeSuggestModal());
	    if (suggestCancelBtn) suggestCancelBtn.addEventListener("click", () => closeSuggestModal());
	    if (suggestModalEl)
	      suggestModalEl.addEventListener("click", (e) => {
	        if (e.target === suggestModalEl) closeSuggestModal();
	      });
	    if (suggestTextEl)
	      suggestTextEl.addEventListener("input", () => {
	        const p = lastDocSelection || {};
	        if (!suggestTodoTextEl) return;
	        // Only auto-update when the todo textarea still matches the default skeleton.
	        const cur = String(suggestTodoTextEl.value || "");
	        const next = buildTodoFromSuggestion(p.text || "", String(suggestTextEl.value || ""), p);
	        if (!cur.trim() || cur.startsWith("【文档建议】")) suggestTodoTextEl.value = next;
	      });
	    if (suggestSubmitBtn)
	      suggestSubmitBtn.addEventListener("click", async () => {
	        const p = lastDocSelection;
	        if (!p || !p.text) return;
	        const quote = String(p.text || "").trim();
	        const sug = String(suggestTextEl ? suggestTextEl.value : "").trim();
	        const todoText = String(suggestTodoTextEl ? suggestTodoTextEl.value : "").trim() || buildTodoFromSuggestion(quote, sug, p);
	        const pri = String(suggestPriorityEl ? suggestPriorityEl.value : "P1").trim() || "P1";
	        const proj = String(suggestProjectEl ? suggestProjectEl.value : activeDocProject()).trim() || activeDocProject();
	        try {
	          await createTodoTask({ text: todoText, priority: pri, project: proj });
	          const items = loadSuggestions();
	          items.push({
	            id: `sug-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`,
	            project: proj,
	            quote,
	            suggestion: sug,
	            todoText,
	            priority: pri,
	            headingId: p.headingId || "",
	            headingTitle: p.headingTitle || "",
	            createdAt: new Date().toISOString(),
	          });
	          saveSuggestions(items.slice(-200));
	          renderSuggestions();
	          setDocState(true, "建议已保存，并已创建Todo");
	          closeSuggestModal();
	          hideSelBubble();
	        } catch (e) {
	          setDocState(false, `创建Todo失败: ${e.message || e}`);
	        }
	      });

	    if (svcRefreshBtn) svcRefreshBtn.addEventListener("click", () => loadServices());
	    if (svcScanBtn) {
	      svcScanBtn.addEventListener("click", async () => {
	        const ok = window.confirm("扫描 ~/Library/LaunchAgents 并写入各项目 docs/pm-services.json ？\\n（不会覆盖你已有的 name/自定义字段，只补齐缺失并刷新路径/日志信息）");
	        if (!ok) return;
	        try {
	          setSvcState(true, "扫描中...");
	          const res = await fetch("/api/services", {
	            method: "POST",
	            headers: { "Content-Type": "application/json" },
	            body: JSON.stringify({ action: "scan_launchagents", mode: "merge" }),
	          });
	          const payload = await res.json();
	          if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
	          if (svcScanResultEl) svcScanResultEl.textContent = JSON.stringify(payload.result || {}, null, 2);
	          setSvcState(true, "扫描完成");
	          loadServices();
	        } catch (e) {
	          setSvcState(false, `扫描失败: ${e.message || e}`);
	        }
	      });
	    }
	    if (svcAutoEl) {
	      svcAutoEl.addEventListener("change", () => {
	        svcRunning = !!svcAutoEl.checked;
	        try { localStorage.setItem("pm_svc_auto", svcRunning ? "1" : "0"); } catch (_) {}
	        setSvcState(true, svcRunning ? "已开启自动刷新" : "已暂停自动刷新");
	        if (svcRunning) loadServices();
	      });
	    }

		    // Polling is tab-aware; init is handled via syncPolling() after restoring tab state.
    syncFeatureFlagControls();
    syncShortenerControls();
    updateProjectStateUrl();
		    loadConfig();
		    loadTelemetryPreview();
	  </script>
</body>
</html>
